<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tactical Shooter: WINTER FIX</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body {
            margin: 0; overflow: hidden; background-color: #1a1a2e;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white; user-select: none; -webkit-user-select: none; touch-action: none;
        }
        canvas { display: block; }

        /* --- UI ELEMENTS --- */
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 20, 35, 0.98); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 20;
            background-image: radial-gradient(circle at center, #253045 0%, #0d101b 100%);
        }
        
        h1 { margin-bottom: 5px; font-size: 32px; color: #00AAFF; text-align: center; text-transform: uppercase; text-shadow: 0 0 15px #0077FF; letter-spacing: 2px; }
        .menu-stats { color: #FFFF00; margin-bottom: 15px; font-size: 14px; border: 1px solid #555; padding: 10px; border-radius: 5px; background: rgba(0,0,0,0.5); }

        /* –ö–ù–û–ü–ö–ò –ú–ï–ù–Æ –°–û –°–ù–ï–ì–û–ú */
        .mission-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; max-height: 50vh; overflow-y: auto; width: 95%; max-width: 800px; padding: 5px;}
        
        .btn {
            background: linear-gradient(180deg, #2a3a50 0%, #1a202a 100%); 
            color: white; border: 1px solid #4a5a70; padding: 12px;
            font-size: 14px; cursor: pointer; text-align: left; font-family: inherit;
            border-radius: 6px; position: relative; overflow: hidden; transition: all 0.1s;
            display: flex; flex-direction: column; justify-content: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        /* –≠—Ñ—Ñ–µ–∫—Ç —Å–Ω–µ–≥–∞ –Ω–∞ –∫–Ω–æ–ø–∫–∞—Ö */
        .btn::after { 
            content: '‚ùÑÔ∏è'; position: absolute; top: 2px; right: 5px; 
            font-size: 14px; opacity: 0.4; filter: grayscale(100%) brightness(200%);
        }
        .btn:hover { background: #3a4a60; border-color: #00AAFF; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,100,255,0.2); }
        .btn:active { transform: scale(0.98); }
        
        .btn b { font-size: 15px; color: #EEF; display: block; margin-bottom: 3px; }
        .btn span { font-size: 11px; color: #88AACC; }

        /* –°—Ç–∏–ª—å –æ—Å–æ–±—ã—Ö –∫–Ω–æ–ø–æ–∫ */
        .boss-btn { border-color: #A020F0; background: linear-gradient(180deg, #3a1040 0%, #200525 100%); }
        .boss-btn b { color: #E0A0FF; }
        .hard-btn { border-color: #FF3333; background: linear-gradient(180deg, #401010 0%, #250505 100%); }
        .hard-btn b { color: #FFAAAA; }
        .special-btn { border-color: #00FFCC; background: linear-gradient(180deg, #002222 0%, #001111 100%); }
        .special-btn b { color: #AAFFFF; }

        .menu-wide-btn { width: 340px; margin-top:5px; text-align: center; font-weight: bold; font-size: 16px; padding: 12px; background: #222; border: 2px solid #555; display: block;}
        .shop-btn { border-color: #FFD700; color: #FFD700; background: rgba(50, 40, 0, 0.5); }

        /* –ò–ì–†–û–í–û–ô –ò–ù–¢–ï–†–§–ï–ô–° */
        #game-ui { display: none; position: absolute; top: 10px; left: 10px; width: 100%; pointer-events: none; z-index: 5; box-sizing: border-box; padding-right: 20px;}
        #top-bar { display: flex; justify-content: space-between; align-items: flex-start; }
        .stat-box { background: rgba(0, 20, 40, 0.8); padding: 5px 12px; border-radius: 8px; margin-bottom: 5px; font-size: 16px; border: 1px solid rgba(0, 150, 255, 0.3); }
        #mission-text { font-size: 20px; font-weight: 800; color: #00FFFF; text-shadow: 0 0 10px rgba(0,255,255,0.5); }
        
        .bar-container { margin-top: 5px; width: 220px; height: 16px; background: #222; border: 1px solid #555; position: relative; border-radius: 4px; overflow: hidden; }
        #health-fill { width: 100%; height: 100%; background: linear-gradient(90deg, #00FF00, #00CC00); transition: width 0.1s; }
        #xp-fill { width: 0%; height: 100%; background: linear-gradient(90deg, #0077FF, #00FFFF); transition: width 0.2s; }
        
        /* –ú–û–ë–ò–õ–¨–ù–û–ï –£–ü–†–ê–í–õ–ï–ù–ò–ï */
        #mobile-controls { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .joystick-zone { position: absolute; bottom: 40px; width: 90px; height: 90px; background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 50%; pointer-events: auto; }
        .joystick-knob { position: absolute; top: 50%; left: 50%; width: 40px; height: 40px; background: rgba(0, 119, 255, 0.5); border-radius: 50%; transform: translate(-50%, -50%); }
        #mobile-grenade-btn { position: absolute; bottom: 100px; right: 130px; width: 50px; height: 50px; background: rgba(255, 165, 0, 0.2); border: 2px solid #FFA500; border-radius: 50%; display: flex; justify-content: center; align-items: center; pointer-events: auto; color: orange; font-size: 20px;}
        #weapon-bar { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; pointer-events: auto; }
        .wpn-btn { width: 40px; height: 40px; background: #222; border: 1px solid #444; color: white; font-size: 9px; font-weight: bold; display: flex; justify-content: center; align-items: center; border-radius: 6px; }
        .wpn-btn.active { border-color: #00AAFF; background: #003366; }

        /* –ú–ê–ì–ê–ó–ò–ù –ò –î–† */
        #shop-screen, #settings-screen { display: none; }
        .shop-container { display: flex; gap: 20px; width: 95%; max-width: 1000px; justify-content: center; flex-wrap: wrap; }
        .shop-column { background: #1a2230; padding: 15px; border: 1px solid #334455; width: 200px; border-radius: 8px; }
        .shop-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px; font-size: 12px; }
        .promo-container { margin-top: 15px; border-top: 1px dashed #555; padding-top: 5px; text-align: center; }

        .lang-btn { width: 80px; padding: 10px; margin: 5px; background: #333; border: 1px solid #555; color: white; cursor: pointer; font-weight: bold; }
        .lang-btn:hover { background: #555; }

        /* NOTIFICATIONS */
        #levelup-notify, #artifact-notify { position: absolute; top: 30%; left: 50%; transform: translate(-50%, -50%); text-align: center; opacity: 0; pointer-events: none; z-index: 100; transition: opacity 0.5s; }
        
        body.mobile-mode .mission-grid { grid-template-columns: 1fr; }
    </style>
</head>
<body>

    <div id="levelup-notify">
        <div style="font-size:40px; color:#FFD700; text-shadow:0 0 20px orange; font-weight:900;">LEVEL UP!</div>
        <div style="font-size:20px; color:white;">HP FULL</div>
    </div>
    <div id="artifact-notify">
        <div style="font-size:30px; color:#00FFFF; text-shadow:0 0 20px blue; font-weight:900;">SECRET FOUND!</div>
    </div>

    <div id="platform-screen" class="overlay" style="z-index: 30;">
        <h1>WINTER OPS<br><span style="font-size:18px; color:white;">TACTICAL v15.5</span></h1>
        <div style="margin-top:20px;">
            <button class="btn menu-wide-btn" onclick="selectPlatform('PC')">üíª PC (Mouse/Keys)</button>
            <button class="btn menu-wide-btn" onclick="selectPlatform('MOBILE')">üì± Mobile (Touch)</button>
        </div>
    </div>

    <div id="settings-screen" class="overlay" style="z-index: 35;">
        <h1 id="lbl-settings">–ù–ê–°–¢–†–û–ô–ö–ò</h1>
        <div style="margin: 20px;">
            <button class="lang-btn" onclick="setLang('ru')">RU</button>
            <button class="lang-btn" onclick="setLang('ua')">UA</button>
            <button class="lang-btn" onclick="setLang('en')">EN</button>
        </div>
        <button class="btn menu-wide-btn" onclick="closeSettings()" style="border-color:red;">OK</button>
    </div>

    <div id="menu-overlay" class="overlay" style="display: none;">
        <h1 id="menu-title">–ö–ê–ú–ü–ê–ù–ò–Ø</h1>
        <div class="menu-stats">
            LVL: <span id="menu-level">1</span> | XP: <span id="menu-xp">0</span> | üí∞: <span id="menu-coins">0</span>
        </div>
        
        <div id="menu-buttons" class="mission-grid">
            </div>
        
        <div style="display:flex; flex-wrap:wrap; justify-content:center; gap:5px; width:100%; max-width:800px;">
            <button class="btn menu-wide-btn" style="width:48%; background:#003300; border-color:#00FF00;" onclick="startTraining()" id="btn-tr">üéØ –¢–†–ï–ù–ò–†–û–í–ö–ê</button>
            <button class="btn menu-wide-btn" style="width:48%; border-color:#00FFFF;" onclick="playCustomMap()" id="btn-cust">üó∫Ô∏è –°–í–û–Ø –ö–ê–†–¢–ê</button>
            <button class="btn menu-wide-btn" style="width:48%; border-color:#00FF00;" onclick="openEditor()" id="btn-edit">üõ†Ô∏è –†–ï–î–ê–ö–¢–û–†</button>
            <button class="btn menu-wide-btn" style="width:48%;" onclick="openSettings()" id="btn-set">‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò</button>
        </div>

        <button class="btn menu-wide-btn shop-btn" onclick="openShop()" id="btn-shop">üõí –ú–ê–ì–ê–ó–ò–ù</button>
        <button id="end-game-btn" class="btn menu-wide-btn" onclick="showMainMenu()" style="display:none; background: #FF3333; margin-top: 20px;">–í –ú–ï–ù–Æ</button>
    </div>

    <div id="game-ui">
        <button id="exit-mission-btn" onclick="showMainMenu()" style="position: absolute; top: 0; left: 50%; transform: translateX(-50%); background: rgba(255, 0, 0, 0.2); border: 1px solid red; color: red; padding: 5px 20px; font-weight: bold; pointer-events: auto;">MENU</button>
        <div id="top-bar">
            <div>
                <div id="mission-text">MISSION</div>
                <div class="bar-container" id="health-bar"><div id="health-fill"></div></div>
                <div class="bar-container" style="height:6px; margin-top:5px; background:#111; border:none;"><div id="xp-fill"></div></div>
                <div class="stat-box" id="weapon-info" style="margin-top: 5px; font-size:12px;">PISTOL</div>
            </div>
            <div style="text-align: right;">
                <div class="stat-box" id="stats">0</div>
                <div class="stat-box" id="grenade-counter" style="color:orange;">üí£ 3</div>
                <div class="stat-box" id="coin-counter" style="color:yellow;">$ 0</div>
            </div>
        </div>
    </div>

    <div id="shop-screen" class="overlay" style="z-index: 25; display: none; overflow-y: auto;">
        <h1 id="lbl-shop-title">–ú–ê–ì–ê–ó–ò–ù</h1>
        <div style="color: yellow; margin-bottom: 5px;">üí∞: <span id="shop-coins">0</span></div>
        <div class="shop-container">
            <div class="shop-column">
                <h3>–í–ò–î</h3>
                <canvas id="previewCanvas" width="150" height="150" style="background:#222; border-radius:50%; margin-bottom:5px;"></canvas>
                <input type="color" id="colorPicker" value="#0077FF" onchange="updatePreview()">
            </div>
            <div class="shop-column"><h3>–í–ï–©–ò</h3><div id="accessories-list"></div></div>
            <div class="shop-column"><h3>–û–†–£–ñ–ò–ï</h3><div id="weapons-list"></div></div>
            <div class="shop-column">
                <h3>–ò–ù–í–ï–ù–¢–ê–†–¨</h3><div id="inventory-list">–ü—É—Å—Ç–æ</div>
                <div class="promo-container">
                    <input type="text" id="promo-input" placeholder="CODE" style="width:100px; padding:5px; color:black;">
                    <button class="btn" onclick="redeemCode()" style="display:inline-block; padding:5px;">OK</button>
                </div>
            </div>
        </div>
        <button class="btn menu-wide-btn" onclick="closeShop()" style="position:fixed; bottom:10px; border-color:red;">–í–´–•–û–î</button>
    </div>
    
    <div id="editor-ui" style="display:none; position:absolute; bottom:10px; left:10px; z-index:50; display:flex; gap:5px;">
        <div class="btn" style="width:40px; height:40px;" onclick="setEditorTool(1)">‚¨ú</div>
        <div class="btn" style="width:40px; height:40px;" onclick="setEditorTool(2)">üëæ</div>
        <div class="btn" style="width:40px; height:40px; border-color:red;" onclick="setEditorTool(0)">‚ùå</div>
        <div class="btn" onclick="saveCustomMap()">SAVE</div>
        <div class="btn" onclick="exitEditor()" style="border-color:red;">EXIT</div>
    </div>

    <div id="mobile-controls">
        <div id="stick-left" class="joystick-zone"><div class="joystick-knob" id="knob-left"></div></div>
        <div id="stick-right" class="joystick-zone" style="right:20px;"><div class="joystick-knob" id="knob-right" style="background:rgba(255,50,50,0.5);"></div></div>
        <div id="mobile-grenade-btn" onclick="throwGrenadeMobile()">üí£</div>
        <div id="weapon-bar"></div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        // --- TRANSLATION DATA ---
        const LANG = {
            ru: {
                menu: "–ö–ê–ú–ü–ê–ù–ò–Ø", tr: "üéØ –¢–†–ï–ù–ò–†–û–í–ö–ê", cust: "üó∫Ô∏è –°–í–û–Ø –ö–ê–†–¢–ê", edit: "üõ†Ô∏è –†–ï–î–ê–ö–¢–û–†", set: "‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò", shop: "üõí –ú–ê–ì–ê–ó–ò–ù",
                missions: [
                    {n: "–ü–µ—Ä–≤–∞—è –ö—Ä–æ–≤—å", d: "–í—ã–∂–∏—Ç—å 20 —Å–µ–∫"}, {n: "–ó–∞—á–∏—Å—Ç–∫–∞", d: "–£–±–∏—Ç—å 5 –≤—Ä–∞–≥–æ–≤"}, {n: "–õ–æ–≥–æ–≤–æ –ó–≤–µ—Ä—è", d: "–£–±–∏—Ç—å –ë–æ—Å—Å–∞"},
                    {n: "–ù–∞—à–µ—Å—Ç–≤–∏–µ", d: "–í—ã–∂–∏—Ç—å 40 —Å–µ–∫"}, {n: "–ú—è—Å–æ—Ä—É–±–∫–∞", d: "–£–±–∏—Ç—å 50 –≤—Ä–∞–≥–æ–≤"}, {n: "–í–µ—Ç–µ—Ä–∞–Ω", d: "–•–∞—Ä–¥–∫–æ—Ä (60—Å)"},
                    {n: "–°–∞–ø–µ—Ä", d: "–°–æ–±—Ä–∞—Ç—å 15 –±–æ–º–±"}, {n: "–ê–ø–æ–∫–∞–ª–∏–ø—Å–∏—Å", d: "–ê–¥ (50—Å)"}, {n: "–£–¥–µ—Ä–∂–∞–Ω–∏–µ", d: "–í –∫—Ä—É–≥—É 15—Å"},
                    {n: "–ù–æ—á–Ω–æ–π –†–µ–π–¥", d: "–¢—å–º–∞ (–£–±–∏—Ç—å 10)"}, {n: "–°–Ω–∞–π–ø–µ—Ä—ã", d: "–£–±–∏—Ç—å 10 —Å–Ω–∞–π–ø–µ—Ä–æ–≤"}, {n: "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞", d: "–ü–æ–ª–∏–≥–æ–Ω"},
                    {n: "–ê—Ä—Ç–∏–ª–ª–µ—Ä–∏—è", d: "–£–±–∏—Ç—å 30 (–ë–∞–∑—É–∫–∞)"}, {n: "–û–±–æ—Ä–æ–Ω–∞", d: "–¢–∞–Ω–∫–∏ (60—Å)"}, {n: "–î–≤–∞ –ë–æ—Å—Å–∞", d: "–£–±–∏—Ç—å –î–≤–æ–∏—Ö"},
                    {n: "–¢–∞–Ω–∫–æ–≤—ã–π –†–∞—à", d: "–£–±–∏—Ç—å 15 —Ç–∞–Ω–∫–æ–≤"}, {n: "–°–ø–∏–¥—Ä–∞–Ω", d: "–ë—ã—Å—Ç—Ä—ã–µ (45—Å)"}, {n: "Boss Rush", d: "–£–±–∏—Ç—å 3 –ë–æ—Å—Å–æ–≤"},
                    {n: "–ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å", d: "–£–±–∏—Ç—å 100"}, {n: "–§–∏–Ω–∞–ª", d: "–í—ã–∂–∏—Ç—å 120 —Å–µ–∫"}
                ],
                stTime: "–í—Ä–µ–º—è", stKill: "–£–±–∏—Ç–æ", stZone: "–ó–æ–Ω–∞", stBomb: "–ë–æ–º–±—ã"
            },
            ua: {
                menu: "–ö–ê–ú–ü–ê–ù–Ü–Ø", tr: "üéØ –¢–†–ï–ù–£–í–ê–ù–ù–Ø", cust: "üó∫Ô∏è –°–í–û–Ø –ö–ê–†–¢–ê", edit: "üõ†Ô∏è –†–ï–î–ê–ö–¢–û–†", set: "‚öôÔ∏è –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø", shop: "üõí –ú–ê–ì–ê–ó–ò–ù",
                missions: [
                    {n: "–ü–µ—Ä—à–∞ –ö—Ä–æ–≤", d: "–í–∏–∂–∏—Ç–∏ 20 —Å–µ–∫"}, {n: "–ó–∞—á–∏—Å—Ç–∫–∞", d: "–í–±–∏—Ç–∏ 5 –≤–æ—Ä–æ–≥—ñ–≤"}, {n: "–õ—ñ–≥–≤–æ –ó–≤—ñ—Ä–∞", d: "–í–±–∏—Ç–∏ –ë–æ—Å–∞"},
                    {n: "–ù–∞–≤–∞–ª–∞", d: "–í–∏–∂–∏—Ç–∏ 40 —Å–µ–∫"}, {n: "–ú'—è—Å–æ—Ä—É–±–∫–∞", d: "–í–±–∏—Ç–∏ 50 –≤–æ—Ä–æ–≥—ñ–≤"}, {n: "–í–µ—Ç–µ—Ä–∞–Ω", d: "–•–∞—Ä–¥–∫–æ—Ä (60—Å)"},
                    {n: "–°–∞–ø–µ—Ä", d: "–ó—ñ–±—Ä–∞—Ç–∏ 15 –±–æ–º–±"}, {n: "–ê–ø–æ–∫–∞–ª—ñ–ø—Å–∏—Å", d: "–ü–µ–∫–ª–æ (50—Å)"}, {n: "–£—Ç—Ä–∏–º–∞–Ω–Ω—è", d: "–í –∫–æ–ª—ñ 15—Å"},
                    {n: "–ù—ñ—á–Ω–∏–π –†–µ–π–¥", d: "–¢–µ–º—Ä—è–≤–∞ (–í–±–∏—Ç–∏ 10)"}, {n: "–°–Ω–∞–π–ø–µ—Ä–∏", d: "–í–±–∏—Ç–∏ 10 —Å–Ω–∞–π–ø–µ—Ä—ñ–≤"}, {n: "–¢—Ä–µ–Ω—É–≤–∞–Ω–Ω—è", d: "–ü–æ–ª—ñ–≥–æ–Ω"},
                    {n: "–ê—Ä—Ç–∏–ª–µ—Ä—ñ—è", d: "–í–±–∏—Ç–∏ 30 (–ë–∞–∑—É–∫–∞)"}, {n: "–û–±–æ—Ä–æ–Ω–∞", d: "–¢–∞–Ω–∫–∏ (60—Å)"}, {n: "–î–≤–∞ –ë–æ—Å–∞", d: "–í–±–∏—Ç–∏ –î–≤–æ—Ö"},
                    {n: "–¢–∞–Ω–∫–æ–≤–∏–π –†–∞—à", d: "–í–±–∏—Ç–∏ 15 —Ç–∞–Ω–∫—ñ–≤"}, {n: "–°–ø—ñ–¥—Ä–∞–Ω", d: "–®–≤–∏–¥–∫—ñ (45—Å)"}, {n: "Boss Rush", d: "–í–±–∏—Ç–∏ 3 –ë–æ—Å—ñ–≤"},
                    {n: "–ù–µ—Å–∫—ñ–Ω—á–µ–Ω–Ω—ñ—Å—Ç—å", d: "–í–±–∏—Ç–∏ 100"}, {n: "–§—ñ–Ω–∞–ª", d: "–í–∏–∂–∏—Ç–∏ 120 —Å–µ–∫"}
                ],
                stTime: "–ß–∞—Å", stKill: "–í–±–∏—Ç–æ", stZone: "–ó–æ–Ω–∞", stBomb: "–ë–æ–º–±–∏"
            },
            en: {
                menu: "CAMPAIGN", tr: "üéØ TRAINING", cust: "üó∫Ô∏è CUSTOM MAP", edit: "üõ†Ô∏è EDITOR", set: "‚öôÔ∏è SETTINGS", shop: "üõí SHOP",
                missions: [
                    {n: "First Blood", d: "Survive 20s"}, {n: "Clean Up", d: "Kill 5 enemies"}, {n: "Beast Lair", d: "Kill Boss"},
                    {n: "The Horde", d: "Survive 40s"}, {n: "Meat Grinder", d: "Kill 50 enemies"}, {n: "Veteran", d: "Hardcore (60s)"},
                    {n: "Sapper", d: "Collect 15 bombs"}, {n: "Apocalypse", d: "Hell (50s)"}, {n: "Hold Point", d: "Zone 15s"},
                    {n: "Night Raid", d: "Dark (Kill 10)"}, {n: "Snipers", d: "Kill 10 snipers"}, {n: "Training", d: "Range"},
                    {n: "Artillery", d: "Kill 30 (Bazooka)"}, {n: "Defense", d: "Tanks (60s)"}, {n: "Two Bosses", d: "Kill Two"},
                    {n: "Tank Rush", d: "Kill 15 Tanks"}, {n: "Speedrun", d: "Fast (45s)"}, {n: "Boss Rush", d: "Kill 3 Bosses"},
                    {n: "Infinity", d: "Kill 100"}, {n: "Final", d: "Survive 120s"}
                ],
                stTime: "Time", stKill: "Kills", stZone: "Zone", stBomb: "Bombs"
            }
        };

        // --- CORE VARS ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let currentLang = 'ru'; 
        let controlMode = 'PC';
        let gameState = 'PLATFORM_SELECT';
        let currentMissionId = 0;
        let megaEquipMode = false;
        
        let gameTime=0, enemiesKilled=0, grenadesKilled=0, bossSpawned=false, zoneTimer=0;
        let captureZone = { x: 0, y: 0, radius: 100 };
        let screenShake = 0;
        let player, activePets=[], enemies=[], bullets=[], particles=[], drops=[], obstacles=[], decorations=[], snowflakes=[];
        let keys={}, mouse={x:0,y:0,down:false};
        let joystickLeft={x:0,y:0,active:false,id:null}, joystickRight={x:0,y:0,active:false,id:null};

        let playerStats = { coins: 0, color: '#0077FF', xp: 0, level: 1, nextLevelXp: 100, unlockedWeapons: ['pistol'], unlockedOutfits: ['none'], currentOutfit: 'none', redeemedCodes: [], godMode: false, inventory: [], skills: [], unlockedPets: ['none'], currentPet: 'none' };
        let customMap = { walls: [], spawns: [] };
        
        const shopData = {
            outfits: ['none','santa_hat','helmet','vest','nvg','full_armor','chain','crown'],
            weapons: ['pistol','rifle','shotgun','sniper','minigun','snowball','bazooka','laser','crossbow','plasma'],
            pets: ['drone','slime','ufo','wisp','turret']
        };

        // --- INIT ---
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resize); resize();
        for(let i=0; i<60; i++) snowflakes.push({ x: Math.random()*window.innerWidth, y: Math.random()*window.innerHeight, r: Math.random()*2+0.5, s: Math.random()*1+0.2 });
        loadGame();
        renderMenuButtons();

        // --- MENU SYSTEM ---
        function setLang(l) { currentLang = l; renderMenuButtons(); saveGame(); }
        function openSettings() { document.getElementById('settings-screen').style.display='flex'; }
        function closeSettings() { document.getElementById('settings-screen').style.display='none'; }
        function openShop() { document.getElementById('shop-screen').style.display='flex'; renderShop(); }
        function closeShop() { document.getElementById('shop-screen').style.display='none'; }
        function openEditor() { gameState='EDITOR'; document.getElementById('menu-overlay').style.display='none'; document.getElementById('editor-ui').style.display='flex'; }
        function exitEditor() { gameState='MENU'; document.getElementById('menu-overlay').style.display='flex'; document.getElementById('editor-ui').style.display='none'; }
        let editorTool=1; function setEditorTool(t){editorTool=t;}

        function renderMenuButtons() {
            const t = LANG[currentLang];
            document.getElementById('menu-title').innerText = t.menu;
            document.getElementById('btn-tr').innerText = t.tr;
            document.getElementById('btn-cust').innerText = t.cust;
            document.getElementById('btn-edit').innerText = t.edit;
            document.getElementById('btn-set').innerText = t.set;
            document.getElementById('btn-shop').innerText = t.shop;

            const grid = document.getElementById('menu-buttons');
            grid.innerHTML = '';
            
            // Mission Logic Config
            const configs = [
                {id:1, type:'time', val:20}, {id:2, type:'kill', val:5}, {id:3, type:'boss'},
                {id:4, type:'time', val:40}, {id:5, type:'kill', val:50}, {id:6, type:'time', val:60, hard:true},
                {id:7, type:'coll', val:15}, {id:8, type:'time', val:50, hard:true}, {id:9, type:'zone', val:15},
                {id:10, type:'kill', val:10, dark:true}, {id:11, type:'kill', val:10, snip:true}, {id:12}, // 12 is skip/custom
                {id:13, type:'kill', val:30, wpn:'bazooka'}, {id:14, type:'time', val:60, hard:true, tank:true}, 
                {id:15, type:'boss', double:true}, {id:16, type:'kill', val:15, tank:true}, {id:17, type:'time', val:45, speed:true},
                {id:18, type:'boss', rush:true}, {id:19, type:'kill', val:100}, {id:20, type:'time', val:120, hard:true}
            ];

            configs.forEach((cfg, i) => {
                if(cfg.id === 12) return; // Skip training in list
                let txt = t.missions[i];
                if(i >= t.missions.length) txt = {n:`Mission ${cfg.id}`, d:"..."}; // Fallback

                let btn = document.createElement('button');
                btn.className = 'btn';
                if(cfg.type==='boss') btn.classList.add('boss-btn');
                if(cfg.hard) btn.classList.add('hard-btn');
                if(cfg.type==='zone'||cfg.dark) btn.classList.add('special-btn');
                
                btn.innerHTML = `<b>${cfg.id}. ${txt.n}</b><span>${txt.d}</span>`;
                btn.onclick = () => startMission(cfg.id, cfg);
                grid.appendChild(btn);
            });
        }

        // --- GAME LOOP ---
        let mCfg = {}; 
        function startMission(id, config) {
            currentMissionId = id; mCfg = config || {};
            gameState='PLAYING'; 
            player = new Player(canvas.width/2, canvas.height/2); 
            enemies=[]; bullets=[]; particles=[]; obstacles=[]; drops=[]; decorations=[]; 
            gameTime=0; enemiesKilled=0; grenadesKilled=0; bossSpawned=false; zoneTimer=0; 
            
            // Generate Map
            if(id === 'CUSTOM') {
                customMap.walls.forEach(w => obstacles.push(new Rect(w.x, w.y, 50)));
            } else {
                for(let i=0; i<30; i++) decorations.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, size:Math.random()*20+10});
                if(id !== 'TRAINING') {
                     for (let i=0; i<12; i++) { 
                        let s=40+Math.random()*60; let x=50+Math.random()*(canvas.width-s-100); let y=50+Math.random()*(canvas.height-s-100); 
                        if(mCfg.type==='zone' && Math.hypot(x-canvas.width/2, y-canvas.height/2)<150) continue; 
                        if(Math.hypot(x-player.x, y-player.y)>200) obstacles.push(new Rect(x, y, s)); 
                    }
                }
            }

            if(mCfg.type === 'zone') { captureZone.x=canvas.width/2; captureZone.y=canvas.height/2; }

            // Pets / Mega Mode
            activePets = []; 
            if(megaEquipMode) {
                ['drone', 'slime', 'ufo', 'wisp', 'turret'].forEach((t, i) => activePets.push(new Pet(t, i)));
            } else if(playerStats.currentPet !== 'none') {
                activePets.push(new Pet(playerStats.currentPet));
            }

            document.getElementById('menu-overlay').style.display='none'; 
            document.getElementById('game-ui').style.display='block';
            let mIdx = id - 1; if(id==='TRAINING') mIdx=11;
            let mName = (typeof id === 'number' || id==='TRAINING') ? LANG[currentLang].missions[mIdx]?.n : "CUSTOM";
            document.getElementById('mission-text').innerText = mName || "MISSION";
            
            updateUI();
        }

        function updateGame() {
            if(gameState !== 'PLAYING') return;
            gameTime += 1/60;
            
            // Spawn Logic
            if(currentMissionId !== 'TRAINING' && currentMissionId !== 'CUSTOM') {
                let rate = (mCfg.hard) ? 60 : 120;
                if(mCfg.speed) rate = 50;
                
                // Boss Spawn
                if(mCfg.type==='boss' && !bossSpawned && gameTime>2) {
                    if(mCfg.double) { spawnEnemy('boss'); spawnEnemy('boss'); }
                    else spawnEnemy('boss');
                    bossSpawned=true;
                }
                if(mCfg.rush && !enemies.some(e=>e.type==='boss') && enemiesKilled < 3 && gameTime>1) {
                    spawnEnemy('boss'); bossSpawned=true;
                }

                if(Math.floor(gameTime*60) % rate === 0) {
                    let t = 'standard';
                    if(mCfg.tank) t = 'tank';
                    if(mCfg.snip) t = 'sniper';
                    spawnEnemy(t);
                }
            }

            // Win Logic
            let win = false;
            if(mCfg.type === 'time' && gameTime >= mCfg.val) win = true;
            if(mCfg.type === 'kill' && enemiesKilled >= mCfg.val) win = true; // BUG FIX: Fixed condition
            if(mCfg.type === 'coll' && grenadesKilled >= mCfg.val) win = true;
            if(mCfg.type === 'zone' && zoneTimer >= mCfg.val) win = true;
            if(mCfg.type === 'boss' && bossSpawned) {
                if(mCfg.rush) { if(enemiesKilled>=3) win=true; }
                else if(!enemies.some(e => e.type === 'boss')) win = true;
            }
            if(win) gameOver(true);

            // Stats Update
            let l = LANG[currentLang];
            let sTxt = "";
            if(mCfg.type==='zone') { 
                if(Math.hypot(player.x-captureZone.x, player.y-captureZone.y)<captureZone.radius) zoneTimer+=1/60; 
                sTxt = `${l.stZone}: ${zoneTimer.toFixed(1)}/${mCfg.val}`;
            } else if (mCfg.type==='kill') sTxt = `${l.stKill}: ${enemiesKilled}/${mCfg.val}`;
            else if (mCfg.type==='coll') sTxt = `${l.stBomb}: ${grenadesKilled}/${mCfg.val}`;
            else sTxt = `${l.stTime}: ${gameTime.toFixed(0)}`;
            document.getElementById('stats').innerText = sTxt;

            player.update();
            activePets.forEach(p => p.update());
            enemies.forEach((e, i) => { e.update(); if(e.dead) enemies.splice(i, 1); });
            bullets.forEach((b, i) => { b.update(); if(b.dead) bullets.splice(i, 1); });
            drops.forEach((d, i) => { 
                if(Math.hypot(d.x-player.x, d.y-player.y) < player.radius + 20) {
                    if(d.type==='coin') playerStats.coins+=10;
                    else if(d.type==='medkit') player.hp = Math.min(player.maxHp, player.hp+25);
                    else if(d.type==='artifact') playerStats.inventory.push(d.artifactType);
                    drops.splice(i, 1); updateUI();
                }
            });
            particles.forEach((p, i) => { p.update(); if(p.life<=0) particles.splice(i, 1); });
            
            bullets.forEach(b => {
                if(!b.isEnemy) {
                    enemies.forEach(e => {
                        if(!b.dead && Math.hypot(b.x-e.x, b.y-e.y) < e.radius+b.radius) {
                            e.takeDamage(b.dmg); b.dead = true; createParticles(b.x, b.y, 'red');
                        }
                    });
                } else {
                    if(!b.dead && Math.hypot(b.x-player.x, b.y-player.y) < player.radius+b.radius) {
                        player.takeDamage(b.dmg); b.dead = true;
                    }
                }
            });
            if(screenShake > 0) screenShake *= 0.9;
        }

        function spawnEnemy(type='standard') {
            let s=Math.floor(Math.random()*4), x, y; 
            if(s===0){x=Math.random()*canvas.width;y=-30;} else if(s===1){x=canvas.width+30;y=Math.random()*canvas.height;} 
            else if(s===2){x=Math.random()*canvas.width;y=canvas.height+30;} else{x=-30;y=Math.random()*canvas.height;} 
            enemies.push(new Enemy(x, y, type));
        }

        function drawGame() {
            ctx.clearRect(0,0,canvas.width, canvas.height);
            ctx.save();
            if(screenShake > 0.5) ctx.translate((Math.random()-0.5)*screenShake, (Math.random()-0.5)*screenShake);

            if(mCfg.dark) { ctx.fillStyle = '#050510'; ctx.fillRect(0,0,canvas.width, canvas.height); } 
            else { ctx.fillStyle = '#1a1a2e'; ctx.fillRect(0,0,canvas.width, canvas.height); ctx.fillStyle = 'rgba(255,255,255,0.05)'; decorations.forEach(d => { ctx.beginPath(); ctx.arc(d.x, d.y, d.size, 0, Math.PI*2); ctx.fill(); }); }

            if(mCfg.type === 'zone') {
                ctx.beginPath(); ctx.arc(captureZone.x, captureZone.y, captureZone.radius, 0, Math.PI*2);
                ctx.fillStyle = 'rgba(0,255,100,0.2)'; ctx.fill(); ctx.strokeStyle = '#00FF00'; ctx.lineWidth=2; ctx.stroke();
            }

            obstacles.forEach(o => o.draw());
            drops.forEach(d => d.draw());
            enemies.forEach(e => e.draw());
            bullets.forEach(b => b.draw());
            if(player && !player.dead) player.draw();
            activePets.forEach(p => p.draw());
            particles.forEach(p => p.draw());

            if(mCfg.dark) {
                ctx.setTransform(1,0,0,1,0,0);
                let g = ctx.createRadialGradient(player.x, player.y, 60, player.x, player.y, 300);
                g.addColorStop(0, 'rgba(0,0,0,0)'); g.addColorStop(1, 'rgba(0,0,0,0.95)');
                ctx.fillStyle = g; ctx.fillRect(0,0,canvas.width, canvas.height);
            }

            ctx.fillStyle = 'rgba(255,255,255,0.5)';
            snowflakes.forEach(s => { s.y+=s.s; if(s.y>canvas.height) s.y=-10; ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI*2); ctx.fill(); });
            ctx.restore();
        }

        // --- CLASSES ---
        class Rect { constructor(x,y,s){this.x=x;this.y=y;this.size=s;} draw(){ctx.fillStyle='#445';ctx.fillRect(this.x,this.y,this.size,this.size); ctx.strokeStyle='#223'; ctx.strokeRect(this.x,this.y,this.size,this.size);} }
        class Player { 
            constructor(x,y){
                this.x=x;this.y=y;this.hp=100;this.maxHp=100;this.radius=15;this.angle=0;this.weapon='pistol';
                if(megaEquipMode) this.maxHp=880; else if(playerStats.currentOutfit==='vest') this.maxHp=200;
                this.hp=this.maxHp;
            }
            update() {
                let spd = 4; let dx=0, dy=0;
                if(controlMode==='PC'){ if(keys['KeyW']) dy=-spd; if(keys['KeyS']) dy=spd; if(keys['KeyA']) dx=-spd; if(keys['KeyD']) dx=spd; this.angle = Math.atan2(mouse.y-this.y, mouse.x-this.x); if(mouse.down) this.shoot(); } 
                else { if(joystickLeft.active) { dx=joystickLeft.x*spd; dy=joystickLeft.y*spd; } if(joystickRight.active) { this.angle=Math.atan2(joystickRight.y, joystickRight.x); this.shoot(); } else if(dx||dy) this.angle=Math.atan2(dy,dx); }
                if(!this.checkCol(this.x+dx, this.y)) this.x+=dx; if(!this.checkCol(this.x, this.y+dy)) this.y+=dy;
                this.x=Math.max(15,Math.min(canvas.width-15,this.x)); this.y=Math.max(15,Math.min(canvas.height-15,this.y));
            }
            checkCol(x,y){ for(let o of obstacles) if(x>o.x && x<o.x+o.size && y>o.y && y<o.y+o.size) return true; return false; }
            shoot() { if(this.cooldown>0) {this.cooldown--; return;} this.cooldown=10; bullets.push(new Bullet(this.x, this.y, {x:Math.cos(this.angle)*15,y:Math.sin(this.angle)*15}, false, 25)); }
            takeDamage(amt){ if(playerStats.godMode) return; this.hp-=amt; screenShake=5; if(this.hp<=0) gameOver(false); updateUI(); }
            draw() { 
                ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.angle);
                ctx.fillStyle=playerStats.color; ctx.beginPath(); ctx.arc(0,0,15,0,Math.PI*2); ctx.fill(); 
                ctx.fillStyle='#000'; ctx.fillRect(10,-3,15,6); 
                if(megaEquipMode || playerStats.currentOutfit === 'crown') { ctx.fillStyle='gold'; ctx.beginPath(); ctx.moveTo(-10,-10); ctx.lineTo(0,-20); ctx.lineTo(10,-10); ctx.fill(); }
                ctx.restore();
            }
        }
        class Enemy {
            constructor(x,y,type){this.x=x;this.y=y;this.type=type;this.hp=40;this.radius=15;this.speed=1.5; if(type==='boss'){this.hp=500;this.radius=35;} if(type==='tank') {this.hp=200; this.radius=25;}}
            update(){ let a = Math.atan2(player.y-this.y, player.x-this.x); let d = Math.hypot(player.x-this.x, player.y-this.y); if(d > this.radius + 15) { this.x+=Math.cos(a)*this.speed; this.y+=Math.sin(a)*this.speed; } }
            draw(){ ctx.save(); ctx.translate(this.x, this.y); ctx.fillStyle = this.type==='boss'?'purple':(this.type==='tank'?'#004400':'red'); ctx.beginPath(); ctx.arc(0,0,this.radius,0,Math.PI*2); ctx.fill(); ctx.restore(); }
            takeDamage(d){ this.hp-=d; if(this.hp<=0) { this.dead=true; enemiesKilled++; addXp(10); if(Math.random()<0.3) drops.push({x:this.x, y:this.y, type:'coin'}); } }
        }
        class Bullet { constructor(x,y,vel,isEnemy,dmg){this.x=x;this.y=y;this.vel=vel;this.isEnemy=isEnemy;this.dmg=dmg;this.radius=4;} update(){this.x+=this.vel.x;this.y+=this.vel.y; if(this.x<0||this.x>canvas.width)this.dead=true;} draw(){ctx.fillStyle=this.isEnemy?'orange':'yellow';ctx.beginPath();ctx.arc(this.x,this.y,this.radius,0,Math.PI*2);ctx.fill();} }
        class Particle { constructor(x,y,c){this.x=x;this.y=y;this.c=c;this.vx=(Math.random()-0.5)*5;this.vy=(Math.random()-0.5)*5;this.life=20;} update(){this.x+=this.vx;this.y+=this.vy;this.life--;} draw(){ctx.globalAlpha=this.life/20;ctx.fillStyle=this.c;ctx.fillRect(this.x,this.y,3,3);ctx.globalAlpha=1;} }
        class Pet { constructor(t,i){this.type=t;this.x=player.x;this.y=player.y;this.off=i*10;} update(){this.x+=(player.x-this.x)*0.05; this.y+=(player.y-this.y)*0.05;} draw(){ctx.fillStyle='cyan';ctx.beginPath();ctx.arc(this.x+this.off,this.y-20,5,0,Math.PI*2);ctx.fill();} }
        class DropItem { constructor(x,y,t,at){this.x=x;this.y=y;this.type=t;this.artifactType=at||'rusty_gear';} draw(){ctx.fillStyle=this.type==='coin'?'gold':'lime';ctx.beginPath();ctx.arc(this.x,this.y,10,0,Math.PI*2);ctx.fill();} }

        // --- RENDER SHOP ---
        function renderShop() {
            const l = document.getElementById('accessories-list'); l.innerHTML='';
            shopData.outfits.forEach(i=>{ let d=document.createElement('div'); d.className='shop-item'; d.innerText=i; l.appendChild(d); });
        }
        function createParticles(x,y,c){for(let i=0;i<5;i++)particles.push(new Particle(x,y,c));}
        function addXp(amt){playerStats.xp+=amt; if(playerStats.xp>=playerStats.nextLevelXp){playerStats.level++; playerStats.xp=0; player.hp=player.maxHp; document.getElementById('levelup-notify').style.opacity=1; setTimeout(()=>document.getElementById('levelup-notify').style.opacity=0,2000);} updateUI();}
        function gameOver(win){ gameState='GAMEOVER'; alert(win?"VICTORY":"DEFEAT"); showMainMenu(); }
        function showMainMenu(){ gameState='MENU'; document.getElementById('menu-overlay').style.display='flex'; document.getElementById('game-ui').style.display='none'; }
        function startTraining() { startMission('TRAINING', {}); }
        function playCustomMap() { if(customMap.spawns.length===0)alert("No spawns!"); else startMission('CUSTOM', {}); }
        function loadGame(){ try{let d=JSON.parse(localStorage.getItem('winterOps_v15_fix')); if(d) { playerStats={...playerStats,...d.stats}; if(d.lang) currentLang = d.lang; if(d.map) customMap=d.map;} }catch(e){} }
        function saveGame(){ localStorage.setItem('winterOps_v15_fix', JSON.stringify({stats: playerStats, lang: currentLang, map: customMap})); }
        function updateUI(){ if(gameState==='PLAYING'){ document.getElementById('health-fill').style.width=(player.hp/player.maxHp)*100+'%'; document.getElementById('xp-fill').style.width=(playerStats.xp/playerStats.nextLevelXp)*100+'%'; document.getElementById('coin-counter').innerText='$ '+playerStats.coins; } }
        function redeemCode() { let c = document.getElementById('promo-input').value.trim().toUpperCase(); if(c === '2KFNWKC') { megaEquipMode = true; alert("MEGA MODE!"); return; } }
        function selectPlatform(m) { controlMode = m; document.getElementById('platform-screen').style.display='none'; showMainMenu(); }
        
        // --- EDITOR & INPUTS ---
        function saveCustomMap() { saveGame(); alert("Saved!"); }
        canvas.addEventListener('mousedown', (e)=>{
            if(gameState==='EDITOR'){
                 let gx=Math.floor(e.clientX/50)*50, gy=Math.floor(e.clientY/50)*50;
                 customMap.walls=customMap.walls.filter(w=>w.x!==gx||w.y!==gy); customMap.spawns=customMap.spawns.filter(s=>s.x!==gx||s.y!==gy);
                 if(editorTool===1)customMap.walls.push({x:gx,y:gy}); if(editorTool===2)customMap.spawns.push({x:gx,y:gy});
            }
        });

        window.addEventListener('keydown',e=>keys[e.code]=true); window.addEventListener('keyup',e=>keys[e.code]=false);
        window.addEventListener('mousemove',e=>{mouse.x=e.clientX;mouse.y=e.clientY});
        window.addEventListener('mousedown',()=>mouse.down=true); window.addEventListener('mouseup',()=>mouse.down=false);
        
        // TOUCH
        document.addEventListener('touchstart',e=>{
            if(controlMode!=='MOBILE'||gameState!=='PLAYING')return;
            for(let i=0;i<e.changedTouches.length;i++){
                let t=e.changedTouches[i];
                if(t.target.id==='mobile-grenade-btn')continue;
                let zl=document.querySelector('.joystick-zone').getBoundingClientRect();
                if(t.clientX<window.innerWidth/2) { joystickLeft.active=true; joystickLeft.id=t.identifier; joystickLeft.sx=t.clientX; joystickLeft.sy=t.clientY; }
                else { joystickRight.active=true; joystickRight.id=t.identifier; joystickRight.sx=t.clientX; joystickRight.sy=t.clientY; }
            }
        },{passive:false});
        document.addEventListener('touchmove',e=>{
            if(controlMode!=='MOBILE'||gameState!=='PLAYING')return; e.preventDefault();
            for(let i=0;i<e.changedTouches.length;i++){
                let t=e.changedTouches[i];
                if(t.identifier===joystickLeft.id){
                     let dx=t.clientX-joystickLeft.sx, dy=t.clientY-joystickLeft.sy;
                     let d=Math.min(Math.hypot(dx,dy),40); let a=Math.atan2(dy,dx);
                     joystickLeft.x=Math.cos(a)*(d/40); joystickLeft.y=Math.sin(a)*(d/40);
                     document.getElementById('knob-left').style.transform=`translate(-50%,-50%) translate(${joystickLeft.x*40}px,${joystickLeft.y*40}px)`;
                }
                if(t.identifier===joystickRight.id){
                     let dx=t.clientX-joystickRight.sx, dy=t.clientY-joystickRight.sy;
                     let d=Math.min(Math.hypot(dx,dy),40); let a=Math.atan2(dy,dx);
                     joystickRight.x=Math.cos(a)*(d/40); joystickRight.y=Math.sin(a)*(d/40);
                     document.getElementById('knob-right').style.transform=`translate(-50%,-50%) translate(${joystickRight.x*40}px,${joystickRight.y*40}px)`;
                }
            }
        },{passive:false});
        document.addEventListener('touchend',e=>{
             for(let i=0;i<e.changedTouches.length;i++){
                let t=e.changedTouches[i];
                if(t.identifier===joystickLeft.id){joystickLeft.active=false; joystickLeft.x=0; joystickLeft.y=0; document.getElementById('knob-left').style.transform='translate(-50%,-50%)';}
                if(t.identifier===joystickRight.id){joystickRight.active=false; document.getElementById('knob-right').style.transform='translate(-50%,-50%)';}
             }
        });
        function throwGrenadeMobile(){if(player)player.shoot();} // Simplification for mobile

        function loop() { requestAnimationFrame(loop); if(gameState==='PLAYING' || gameState==='EDITOR') { if(gameState==='PLAYING')updateGame(); drawGame(); } }
        loop();
    </script>
</body>
</html>
