<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tactical Shooter: FINAL FIXED</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        /* --- –°–¢–ê–†–´–ô –í–ò–ó–£–ê–õ (v14 Style) --- */
        body {
            margin: 0; overflow: hidden; background-color: #1a1a2e;
            font-family: 'Courier New', Courier, monospace; /* –¢–æ—Ç —Å–∞–º—ã–π —à—Ä–∏—Ñ—Ç */
            color: white; user-select: none; -webkit-user-select: none; touch-action: none;
        }
        canvas { display: block; }
        
        /* UI ELEMENTS */
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 20, 40, 0.95); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 20;
        }
        h1 { margin-bottom: 5px; font-size: 28px; color: #00AAFF; text-align: center; text-transform: uppercase; text-shadow: 0 0 10px white; }
        
        /* –ö–ù–û–ü–ö–ò –° –≠–§–§–ï–ö–¢–û–ú –°–ù–ï–ì–ê */
        .btn {
            background: #222; color: white; border: 2px solid #0077FF; padding: 10px;
            font-size: 12px; cursor: pointer; text-align: center; font-family: inherit; margin: 2px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: transform 0.1s; position: relative;
        }
        .btn:hover { background: #0077FF; color: black; transform: scale(1.02); }
        /* –°–ù–ï–ì –¢–£–¢ */
        .btn::after { content: '‚ùÑÔ∏è'; position: absolute; top: 2px; right: 2px; font-size: 10px; opacity: 0.6; }
        
        .btn b { font-size: 14px; margin-bottom: 3px; display:block; color: #EEF; }
        .btn span { font-size: 10px; color: #aaa; font-weight: normal; }

        .boss-btn { border-color: #A020F0; } .boss-btn b { color: #E0A0FF; }
        .hard-btn { border-color: #FF3333; } .hard-btn b { color: #FFAAAA; }
        .special-btn { border-color: #00FFCC; } .special-btn b { color: #AAFFFF; }
        
        .mission-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; margin-bottom: 10px; max-height: 50vh; overflow-y: auto; width: 95%; max-width: 600px;}
        
        .menu-wide-btn { width: 340px; margin-top:5px; font-size: 14px; font-weight: bold; }
        .shop-btn { border-color: #FFFF00; color: #FFFFAA; }
        
        /* –ò–ù–¢–ï–†–§–ï–ô–° –í –ò–ì–†–ï */
        #game-ui { display: none; position: absolute; top: 10px; left: 10px; pointer-events: none; width: 100%; box-sizing: border-box; padding-right: 20px; z-index: 5; }
        #exit-mission-btn { position: absolute; top: 0; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.6); border: 1px solid #FF3333; color: #FF3333; font-family: inherit; cursor: pointer; pointer-events: auto; padding: 5px 15px; font-weight: bold; font-size: 12px; z-index: 100; }
        #top-bar { display: flex; justify-content: space-between; align-items: flex-start; }
        .stat-box { background: rgba(0,0,0,0.6); padding: 5px 10px; border-radius: 5px; margin-bottom: 5px; font-size: 16px; border: 1px solid rgba(255,255,255,0.2); }
        .bar-container { margin-top: 5px; width: 200px; height: 15px; background: #444; border: 2px solid #fff; position: relative; }
        #health-fill { width: 100%; height: 100%; background: #00FF00; transition: width 0.1s; }
        #xp-fill { width: 0%; height: 100%; background: #0077FF; transition: width 0.2s; }
        
        /* –ú–ê–ì–ê–ó–ò–ù –ò –ù–ê–°–¢–†–û–ô–ö–ò */
        #shop-screen, #settings-screen { display: none; }
        .shop-container { display: flex; gap: 20px; width: 95%; max-width: 1000px; justify-content: center; flex-wrap: wrap; }
        .shop-column { background: #223; padding: 15px; border: 2px solid #558; width: 200px; }
        .shop-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 5px; }
        
        /* –Ø–ó–´–ö–ò */
        .lang-btn { width: 80px; padding: 10px; margin: 5px; background: #333; border: 1px solid #fff; color: white; cursor: pointer; font-family: inherit; }
        .lang-btn:hover { background: #555; }

        /* –ú–û–ë–ò–õ–¨–ù–´–ï */
        #mobile-controls { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .joystick-zone { position: absolute; bottom: 40px; width: 90px; height: 90px; background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 50%; pointer-events: auto; }
        .joystick-knob { position: absolute; top: 50%; left: 50%; width: 40px; height: 40px; background: rgba(0, 119, 255, 0.5); border-radius: 50%; transform: translate(-50%, -50%); }
        #mobile-grenade-btn { position: absolute; bottom: 100px; right: 130px; width: 50px; height: 50px; background: rgba(255, 165, 0, 0.3); border: 2px solid #FFA500; border-radius: 50%; color: #FFA500; font-size: 20px; display: flex; justify-content: center; align-items: center; pointer-events: auto; }
        #weapon-bar { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; pointer-events: auto; }
        .wpn-btn { width: 35px; height: 35px; background: #333; border: 1px solid #666; color: white; font-size: 9px; font-weight: bold; display: flex; justify-content: center; align-items: center; border-radius: 5px; font-family: inherit; }
        .wpn-btn.active { border-color: #0077FF; background: #004488; }

        body.mobile-mode .mission-grid { grid-template-columns: 1fr 1fr; }
    </style>
</head>
<body>

    <div id="levelup-notify" style="position:absolute; top:30%; left:50%; transform:translate(-50%,-50%); text-align:center; opacity:0; pointer-events:none; z-index:100; transition:opacity 0.5s;">
        <div id="notif-lvl" style="font-size:40px; color:#FFD700; text-shadow:0 0 10px orange; font-weight:bold;">LEVEL UP!</div>
    </div>
    
    <div id="platform-screen" class="overlay" style="z-index: 30;">
        <h1 id="title-main">Tactical Shooter<br>‚ùÑÔ∏è WINTER ‚ùÑÔ∏è</h1>
        <h2 id="lbl-choose">Control:</h2>
        <button class="btn menu-wide-btn" onclick="selectPlatform('PC')" id="btn-pc">üíª PC</button>
        <button class="btn menu-wide-btn" onclick="selectPlatform('MOBILE')" id="btn-mob">üì± Mobile</button>
    </div>

    <div id="settings-screen" class="overlay" style="z-index: 35;">
        <h1 id="lbl-settings">–ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø</h1>
        <div style="margin: 20px;">
            <button class="lang-btn" onclick="setLang('uk')">üá∫üá¶ UKR</button>
            <button class="lang-btn" onclick="setLang('ru')">üá∑üá∫ RUS</button>
            <button class="lang-btn" onclick="setLang('en')">üá∫üá∏ ENG</button>
        </div>
        <button class="btn menu-wide-btn" onclick="closeSettings()" style="border-color:red;" id="btn-set-ok">OK</button>
    </div>

    <div id="menu-overlay" class="overlay" style="display: none;">
        <h1 id="menu-title">–ú–ï–ù–Æ –ú–Ü–°–Ü–ô</h1>
        <div class="menu-stats" style="color: #FFFF00; margin-bottom: 20px; font-size: 14px; border: 1px solid #555; padding: 10px; text-align: center;">
            LVL: <span id="menu-level">1</span> | XP: <span id="menu-xp">0</span> | üí∞: <span id="menu-coins">0</span>
        </div>
        
        <div id="menu-buttons" class="mission-grid">
            </div>
        
        <button class="btn multi-btn" style="border-color:#FF00FF;" onclick="openMultiplayer()" id="btn-onl">üåê –û–ù–õ–ê–ô–ù</button>
        <button class="btn menu-wide-btn" style="border-color:#00FFFF;" onclick="playCustomMap()" id="btn-cust">üó∫Ô∏è CUSTOM MAP</button>
        <button class="btn shop-btn" onclick="openShop()" id="btn-shop">üõí –ú–ê–ì–ê–ó–ò–ù</button>
        <button class="btn editor-btn" onclick="openEditor()" style="border-color:#00FF00;" id="btn-edit">üõ†Ô∏è –†–ï–î–ê–ö–¢–û–†</button>
        <button class="btn menu-wide-btn" onclick="openSettings()" id="btn-set">‚öôÔ∏è –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø</button>
        <button id="end-game-btn" class="btn menu-wide-btn" onclick="showMainMenu()" style="display:none; background: #FF3333; margin-top: 20px;">MENU</button>
    </div>

    <div id="game-ui">
        <button id="exit-mission-btn" onclick="showMainMenu()">EXIT</button>
        <div id="top-bar">
            <div>
                <div id="mission-text" style="font-size: 18px; font-weight: bold; color: #77DDFF; text-shadow: 1px 1px 0 #000;">...</div>
                <div class="bar-container" id="health-bar"><div id="health-fill"></div></div>
                <div class="bar-container" style="height: 10px; border-color: #0077FF; margin-top: 5px;"><div id="xp-fill"></div></div>
                <div class="stat-box" id="weapon-info" style="margin-top: 5px; color: #aaa;">Weapon</div>
            </div>
            <div style="text-align: right;">
                <div class="stat-box" id="stats">0.0</div>
                <div class="stat-box" id="grenade-counter" style="color: #FFA500; font-weight: bold;">üí£: 3</div>
                <div class="stat-box" id="coin-counter" style="color: #FFFF00; font-weight: bold;">üí∞: 0</div>
            </div>
        </div>
    </div>

    <div id="shop-screen" class="overlay" style="z-index: 25; display: none; overflow-y: auto;">
        <h1 id="lbl-shop">–ú–ê–ì–ê–ó–ò–ù</h1>
        <div style="color: yellow; margin-bottom: 5px;">üí∞: <span id="shop-coins">0</span></div>
        <div class="shop-container">
            <div class="shop-column">
                <h3 id="lbl-look">–í–ò–ì–õ–Ø–î</h3>
                <canvas id="previewCanvas" width="150" height="150" style="border: 2px solid #555; background: #222; margin-bottom: 5px;"></canvas>
                <input type="color" id="colorPicker" value="#0077FF" onchange="updatePreview()">
            </div>
            <div class="shop-column"><h3 id="lbl-acc">–ê–ö–°–ï–°–£–ê–†–ò</h3><div id="accessories-list"></div></div>
            <div class="shop-column"><h3 id="lbl-wpn">–ó–ë–†–û–Ø</h3><div id="weapons-list"></div></div>
            <div class="shop-column">
                <h3 id="lbl-inv">–Ü–ù–í–ï–ù–¢–ê–†</h3><div id="inventory-list" style="font-size:12px; color:#aaa;"></div>
                <div style="margin-top: 20px; border-top: 2px dashed #555; padding: 10px;">
                    <input type="text" id="promo-input" placeholder="CODE" style="background:#111; border:1px solid #0077FF; color:white; padding:5px; width:100px;">
                    <button class="btn" style="display:inline-block; padding:5px;" onclick="redeemCode()">OK</button>
                </div>
            </div>
        </div>
        <button class="btn menu-wide-btn" onclick="closeShop()" style="margin-top: 10px; border-color:red;" id="btn-shop-close">EXIT</button>
    </div>

    <div id="mobile-controls">
        <div id="stick-left" class="joystick-zone"><div class="joystick-knob" id="knob-left"></div></div>
        <div id="stick-right" class="joystick-zone" style="right: 20px;"><div class="joystick-knob" id="knob-right" style="background: rgba(255, 51, 51, 0.5);"></div></div>
        <div id="mobile-grenade-btn" onclick="throwGrenadeMobile()">üí£</div>
        <div id="weapon-bar"></div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        // --- TEXT DATA (TRANSLATIONS) ---
        const LANG = {
            uk: {
                menu: "–ú–ï–ù–Æ –ú–Ü–°–Ü–ô", choose: "–û–±–µ—Ä—ñ—Ç—å –∫–µ—Ä—É–≤–∞–Ω–Ω—è", pc: "üíª –ü–ö", mob: "üì± –ú–æ–±—ñ–ª—å–Ω–∏–π",
                onl: "üåê –û–ù–õ–ê–ô–ù", cust: "üó∫Ô∏è –°–í–û–Ø –ö–ê–†–¢–ê", shop: "üõí –ú–ê–ì–ê–ó–ò–ù", edit: "üõ†Ô∏è –†–ï–î–ê–ö–¢–û–†", set: "‚öôÔ∏è –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø",
                shT: "–ú–ê–ì–ê–ó–ò–ù", look: "–í–ò–ì–õ–Ø–î", acc: "–ê–ö–°–ï–°–£–ê–†–ò", wpn: "–ó–ë–†–û–Ø", inv: "–Ü–ù–í–ï–ù–¢–ê–†", ok: "–û–ö", close: "–ó–ê–ö–†–ò–¢–ò",
                lvlup: "–ù–û–í–ò–ô –†–Ü–í–ï–ù–¨!", stTime: "–ß–∞—Å", stKill: "–í–±–∏—Ç–æ", stBomb: "–ë–æ–º–±–∏", stZone: "–ó–æ–Ω–∞",
                missions: [
                    {n:"–û–∫–æ–ø", d:"–í–∏–∂–∏—Ç–∏ 20—Å"}, {n:"–ó–∞—á–∏—Å—Ç–∫–∞", d:"–í–±–∏—Ç–∏ 5 –≤–æ—Ä–æ–≥—ñ–≤"}, {n:"–õ—ñ–≥–≤–æ", d:"–í–±–∏—Ç–∏ –ë–æ—Å–∞"},
                    {n:"–û—Ä–¥–∞", d:"–í–∏–∂–∏—Ç–∏ 40—Å"}, {n:"–ú'—è—Å–æ—Ä—É–±–∫–∞", d:"–í–±–∏—Ç–∏ 50 –≤–æ—Ä–æ–≥—ñ–≤"}, {n:"–í–µ—Ç–µ—Ä–∞–Ω", d:"–•–∞—Ä–¥–∫–æ—Ä (60—Å)"},
                    {n:"–°–∞–ø–µ—Ä", d:"–ó—ñ–±—Ä–∞—Ç–∏ 15 –±–æ–º–±"}, {n:"–ü–µ–∫–ª–æ", d:"–í–∏–∂–∏—Ç–∏ 50—Å"}, {n:"–ó–æ–Ω–∞", d:"–í –∫–æ–ª—ñ 15—Å"},
                    {n:"–ù—ñ—á", d:"–í–±–∏—Ç–∏ 10 (–¢–µ–º—Ä—è–≤–∞)"}, {n:"–°–Ω–∞–π–ø–µ—Ä–∏", d:"–í–±–∏—Ç–∏ 10 —Å–Ω–∞–π–ø–µ—Ä—ñ–≤"}, {n:"–¢—Ä–µ–Ω—É–≤–∞–Ω–Ω—è", d:"–ü–æ–ª—ñ–≥–æ–Ω"},
                    {n:"–ë–∞–∑—É–∫–∞", d:"–í–±–∏—Ç–∏ 30"}, {n:"–û–±–æ—Ä–æ–Ω–∞", d:"–¢–∞–Ω–∫–∏ (60—Å)"}, {n:"–î–≤–∞ –ë–æ—Å–∞", d:"–í–±–∏—Ç–∏ –î–≤–æ—Ö"},
                    {n:"–¢–∞–Ω–∫–∏", d:"–í–±–∏—Ç–∏ 15 —Ç–∞–Ω–∫—ñ–≤"}, {n:"–°–ø—ñ–¥—Ä–∞–Ω", d:"–®–≤–∏–¥–∫—ñ (45—Å)"}, {n:"Boss Rush", d:"–í–±–∏—Ç–∏ 3 –ë–æ—Å—ñ–≤"},
                    {n:"100 –ö—ñ–ª—ñ–≤", d:"–í–±–∏—Ç–∏ 100"}, {n:"–§—ñ–Ω–∞–ª", d:"–í–∏–∂–∏—Ç–∏ 120—Å"}
                ],
                items: { none: "–ù–µ–º–∞—î", santa_hat: "–®–∞–ø–∫–∞", helmet: "–ö–∞—Å–∫–∞", vest: "–ñ–∏–ª–µ—Ç", nvg: "–ü–ù–ë", crown: "–ö–æ—Ä–æ–Ω–∞", pistol: "–ü—ñ—Å—Ç", rifle: "–ê–≤—Ç", shotgun: "–î—Ä–æ–±", minigun: "–ö—É–ª–µ–º", bazooka: "–ë–∞–∑—É–∫–∞" }
            },
            ru: {
                menu: "–ú–ï–ù–Æ –ú–ò–°–°–ò–ô", choose: "–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ", pc: "üíª –ü–ö", mob: "üì± –ú–æ–±–∏–ª—å–Ω—ã–π",
                onl: "üåê –û–ù–õ–ê–ô–ù", cust: "üó∫Ô∏è –°–í–û–Ø –ö–ê–†–¢–ê", shop: "üõí –ú–ê–ì–ê–ó–ò–ù", edit: "üõ†Ô∏è –†–ï–î–ê–ö–¢–û–†", set: "‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò",
                shT: "–ú–ê–ì–ê–ó–ò–ù", look: "–í–ò–î", acc: "–í–ï–©–ò", wpn: "–û–†–£–ñ–ò–ï", inv: "–ò–ù–í–ï–ù–¢–ê–†–¨", ok: "–û–ö", close: "–ó–ê–ö–†–´–¢–¨",
                lvlup: "–ù–û–í–´–ô –£–†–û–í–ï–ù–¨!", stTime: "–í—Ä–µ–º—è", stKill: "–£–±–∏—Ç–æ", stBomb: "–ë–æ–º–±—ã", stZone: "–ó–æ–Ω–∞",
                missions: [
                    {n:"–û–∫–æ–ø", d:"–í—ã–∂–∏—Ç—å 20—Å"}, {n:"–ó–∞—á–∏—Å—Ç–∫–∞", d:"–£–±–∏—Ç—å 5 –≤—Ä–∞–≥–æ–≤"}, {n:"–õ–æ–≥–æ–≤–æ", d:"–£–±–∏—Ç—å –ë–æ—Å—Å–∞"},
                    {n:"–û—Ä–¥–∞", d:"–í—ã–∂–∏—Ç—å 40—Å"}, {n:"–ú—è—Å–æ—Ä—É–±–∫–∞", d:"–£–±–∏—Ç—å 50 –≤—Ä–∞–≥–æ–≤"}, {n:"–í–µ—Ç–µ—Ä–∞–Ω", d:"–•–∞—Ä–¥–∫–æ—Ä (60—Å)"},
                    {n:"–°–∞–ø–µ—Ä", d:"–°–æ–±—Ä–∞—Ç—å 15 –±–æ–º–±"}, {n:"–ê–¥", d:"–í—ã–∂–∏—Ç—å 50—Å"}, {n:"–ó–æ–Ω–∞", d:"–í –∫—Ä—É–≥—É 15—Å"},
                    {n:"–ù–æ—á—å", d:"–£–±–∏—Ç—å 10 (–¢—å–º–∞)"}, {n:"–°–Ω–∞–π–ø–µ—Ä—ã", d:"–£–±–∏—Ç—å 10 —Å–Ω–∞–π–ø–µ—Ä–æ–≤"}, {n:"–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞", d:"–ü–æ–ª–∏–≥–æ–Ω"},
                    {n:"–ë–∞–∑—É–∫–∞", d:"–£–±–∏—Ç—å 30"}, {n:"–û–±–æ—Ä–æ–Ω–∞", d:"–¢–∞–Ω–∫–∏ (60—Å)"}, {n:"–î–≤–∞ –ë–æ—Å—Å–∞", d:"–£–±–∏—Ç—å –î–≤–æ–∏—Ö"},
                    {n:"–¢–∞–Ω–∫–∏", d:"–£–±–∏—Ç—å 15 —Ç–∞–Ω–∫–æ–≤"}, {n:"–°–ø–∏–¥—Ä–∞–Ω", d:"–ë—ã—Å—Ç—Ä—ã–µ (45—Å)"}, {n:"Boss Rush", d:"–£–±–∏—Ç—å 3 –ë–æ—Å—Å–æ–≤"},
                    {n:"100 –ö–∏–ª–ª–æ–≤", d:"–£–±–∏—Ç—å 100"}, {n:"–§–∏–Ω–∞–ª", d:"–í—ã–∂–∏—Ç—å 120—Å"}
                ],
                items: { none: "–ù–µ—Ç", santa_hat: "–®–∞–ø–∫–∞", helmet: "–ö–∞—Å–∫–∞", vest: "–ñ–∏–ª–µ—Ç", nvg: "–ü–ù–í", crown: "–ö–æ—Ä–æ–Ω–∞", pistol: "–ü–∏—Å—Ç", rifle: "–ê–≤—Ç", shotgun: "–î—Ä–æ–±", minigun: "–ü—É–ª–µ–º", bazooka: "–ë–∞–∑—É–∫–∞" }
            },
            en: {
                menu: "MISSIONS", choose: "Choose Control", pc: "üíª PC", mob: "üì± Mobile",
                onl: "üåê ONLINE", cust: "üó∫Ô∏è CUSTOM MAP", shop: "üõí SHOP", edit: "üõ†Ô∏è EDITOR", set: "‚öôÔ∏è SETTINGS",
                shT: "SHOP", look: "LOOK", acc: "GEAR", wpn: "WEAPONS", inv: "INVENTORY", ok: "OK", close: "CLOSE",
                lvlup: "LEVEL UP!", stTime: "Time", stKill: "Kills", stBomb: "Bombs", stZone: "Zone",
                missions: [
                    {n:"Trench", d:"Survive 20s"}, {n:"Cleanup", d:"Kill 5 enemies"}, {n:"Lair", d:"Kill Boss"},
                    {n:"Horde", d:"Survive 40s"}, {n:"Grinder", d:"Kill 50 enemies"}, {n:"Veteran", d:"Hardcore (60s)"},
                    {n:"Sapper", d:"Collect 15 bombs"}, {n:"Hell", d:"Survive 50s"}, {n:"Zone", d:"Hold 15s"},
                    {n:"Night", d:"Kill 10 (Dark)"}, {n:"Snipers", d:"Kill 10 Snipers"}, {n:"Training", d:"Range"},
                    {n:"Bazooka", d:"Kill 30"}, {n:"Defense", d:"Tanks (60s)"}, {n:"Two Bosses", d:"Kill Two"},
                    {n:"Tanks", d:"Kill 15 Tanks"}, {n:"Speedrun", d:"Fast (45s)"}, {n:"Boss Rush", d:"Kill 3 Bosses"},
                    {n:"100 Kills", d:"Kill 100"}, {n:"Final", d:"Survive 120s"}
                ],
                items: { none: "None", santa_hat: "Hat", helmet: "Helmet", vest: "Vest", nvg: "NVG", crown: "Crown", pistol: "Pistol", rifle: "Rifle", shotgun: "Shotgun", minigun: "Minigun", bazooka: "Bazooka" }
            }
        };

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resize); resize();

        let curLang = 'ru';
        let controlMode = 'PC';
        let gameState = 'PLATFORM_SELECT';
        let currentMissionId = 0;
        let megaEquipMode = false;

        let playerStats = { coins: 0, color: '#0077FF', xp: 0, level: 1, nextLevelXp: 100, unlockedWeapons: ['pistol'], unlockedOutfits: ['none'], currentOutfit: 'none', redeemedCodes: [], godMode: false, inventory: [], skills: [], unlockedPets: ['none'], currentPet: 'none' };
        let customMap = { walls: [], spawns: [] };
        
        let gameTime=0, enemiesKilled=0, grenadesKilled=0, bossSpawned=false, zoneTimer=0;
        let captureZone = { x: 0, y: 0, radius: 100 };
        let screenShake = 0;
        let player, activePets=[], enemies=[], bullets=[], particles=[], drops=[], obstacles=[], decorations=[], snowflakes=[];
        let keys={}, mouse={x:0,y:0,down:false};
        let joystickLeft={x:0,y:0,active:false,id:null}, joystickRight={x:0,y:0,active:false,id:null};

        // SNOW
        for(let i=0; i<60; i++) snowflakes.push({ x: Math.random()*window.innerWidth, y: Math.random()*window.innerHeight, r: Math.random()*2+0.5, s: Math.random()*1+0.2 });

        // --- LANGUAGE SYSTEM ---
        function setLang(l) { curLang = l; applyLang(); saveGame(); }
        function applyLang() {
            let t = LANG[curLang];
            document.getElementById('lbl-choose').innerText = t.choose;
            document.getElementById('btn-pc').innerText = t.pc; document.getElementById('btn-mob').innerText = t.mob;
            
            document.getElementById('menu-title').innerText = t.menu;
            document.getElementById('btn-onl').innerText = t.onl; document.getElementById('btn-cust').innerText = t.cust;
            document.getElementById('btn-shop').innerText = t.shop; document.getElementById('btn-edit').innerText = t.edit;
            document.getElementById('btn-set').innerText = t.set;
            
            document.getElementById('lbl-shop').innerText = t.shT; document.getElementById('lbl-look').innerText = t.look;
            document.getElementById('lbl-acc').innerText = t.acc; document.getElementById('lbl-wpn').innerText = t.wpn;
            document.getElementById('lbl-inv').innerText = t.inv; document.getElementById('btn-shop-close').innerText = t.close;
            document.getElementById('btn-set-ok').innerText = t.ok;
            document.getElementById('notif-lvl').innerText = t.lvlup;
            document.getElementById('exit-mission-btn').innerText = t.close;

            renderMenuButtons();
            renderShop();
        }

        function renderMenuButtons() {
            const grid = document.getElementById('menu-buttons'); grid.innerHTML = '';
            const t = LANG[curLang];
            const configs = [
                {id:1, type:'time', val:20}, {id:2, type:'kill', val:5}, {id:3, type:'boss'},
                {id:4, type:'time', val:40}, {id:5, type:'kill', val:50}, {id:6, type:'time', val:60, hard:true},
                {id:7, type:'coll', val:15}, {id:8, type:'time', val:50, hard:true}, {id:9, type:'zone', val:15},
                {id:10, type:'kill', val:10, dark:true}, {id:11, type:'kill', val:10, snip:true}, {id:12}, 
                {id:13, type:'kill', val:30, wpn:'bazooka'}, {id:14, type:'time', val:60, hard:true, tank:true}, 
                {id:15, type:'boss', double:true}, {id:16, type:'kill', val:15, tank:true}, {id:17, type:'time', val:45, speed:true},
                {id:18, type:'boss', rush:true}, {id:19, type:'kill', val:100}, {id:20, type:'time', val:120, hard:true}
            ];

            configs.forEach((cfg, i) => {
                if(i===11) return; // Skip training
                let txt = t.missions[i] || {n:"M"+cfg.id, d:"..."};
                let btn = document.createElement('button');
                btn.className = 'btn';
                if(cfg.type==='boss') btn.classList.add('boss-btn');
                if(cfg.hard) btn.classList.add('hard-btn');
                if(cfg.type==='zone'||cfg.dark) btn.classList.add('special-btn');
                
                btn.innerHTML = `<b>${cfg.id}. ${txt.n}</b><span>${txt.d}</span>`;
                btn.onclick = () => startMission(cfg.id, cfg);
                grid.appendChild(btn);
            });
        }

        // --- GAMEPLAY ---
        let mCfg = {};
        function startMission(id, config) {
            currentMissionId = id; mCfg = config || {};
            if(id === 'TRAINING') mCfg = { id: 12 }; 
            
            gameState='PLAYING'; 
            player = new Player(canvas.width/2, canvas.height/2); 
            enemies=[]; bullets=[]; particles=[]; obstacles=[]; drops=[]; decorations=[]; 
            gameTime=0; enemiesKilled=0; grenadesKilled=0; bossSpawned=false; zoneTimer=0; 
            
            if(id === 'CUSTOM') { customMap.walls.forEach(w => obstacles.push(new Rect(w.x, w.y, 50))); } 
            else {
                for(let i=0; i<30; i++) decorations.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, size:Math.random()*20+10});
                if(id !== 'TRAINING') {
                     for (let i=0; i<12; i++) { 
                        let s=40+Math.random()*60; let x=50+Math.random()*(canvas.width-s-100); let y=50+Math.random()*(canvas.height-s-100); 
                        if(mCfg.type==='zone' && Math.hypot(x-canvas.width/2, y-canvas.height/2)<150) continue; 
                        if(Math.hypot(x-player.x, y-player.y)>200) obstacles.push(new Rect(x, y, s)); 
                    }
                }
            }
            if(mCfg.type === 'zone') { captureZone.x=canvas.width/2; captureZone.y=canvas.height/2; }

            activePets = []; 
            if(megaEquipMode) { ['drone', 'slime', 'ufo', 'wisp', 'turret'].forEach((t, i) => activePets.push(new Pet(t, i))); } 
            else if(playerStats.currentPet !== 'none') { activePets.push(new Pet(playerStats.currentPet)); }

            document.getElementById('menu-overlay').style.display='none'; 
            document.getElementById('game-ui').style.display='block';
            let mName = (typeof id === 'number' || id==='TRAINING') ? LANG[curLang].missions[id==='TRAINING'?11:(id-1)]?.n : "CUSTOM";
            document.getElementById('mission-text').innerText = mName;
            updateUI();
        }

        function updateGame() {
            if(gameState !== 'PLAYING') return;
            gameTime += 1/60;
            
            if(currentMissionId !== 'TRAINING' && currentMissionId !== 'CUSTOM') {
                let rate = (mCfg.hard) ? 60 : 120; if(mCfg.speed) rate = 50;
                
                if(mCfg.type==='boss' && !bossSpawned && gameTime>2) {
                    if(mCfg.double) { spawnEnemy('boss'); spawnEnemy('boss'); } else spawnEnemy('boss');
                    bossSpawned=true;
                }
                if(mCfg.rush && !enemies.some(e=>e.type==='boss') && enemiesKilled < 3 && gameTime>1) { spawnEnemy('boss'); bossSpawned=true; }

                if(Math.floor(gameTime*60) % rate === 0) {
                    let t = 'standard';
                    if(mCfg.tank) t = 'tank'; if(mCfg.snip) t = 'sniper';
                    spawnEnemy(t);
                }
            }

            // WIN CHECK (FIXED)
            let win = false;
            if(mCfg.type === 'time' && gameTime >= mCfg.val) win = true;
            if(mCfg.type === 'kill' && enemiesKilled >= mCfg.val) win = true; // FIX APPLIED HERE
            if(mCfg.type === 'coll' && grenadesKilled >= mCfg.val) win = true;
            if(mCfg.type === 'zone' && zoneTimer >= mCfg.val) win = true;
            if(mCfg.type === 'boss' && bossSpawned) {
                if(mCfg.rush) { if(enemiesKilled>=3) win=true; }
                else if(!enemies.some(e => e.type === 'boss')) win = true;
            }
            if(win) gameOver(true);

            let t = LANG[curLang]; let sTxt = "";
            if(mCfg.type==='zone') { 
                if(Math.hypot(player.x-captureZone.x, player.y-captureZone.y)<captureZone.radius) zoneTimer+=1/60; 
                sTxt = `${t.stZone}: ${zoneTimer.toFixed(1)}/${mCfg.val}`;
            } else if (mCfg.type==='kill') sTxt = `${t.stKill}: ${enemiesKilled}/${mCfg.val}`;
            else if (mCfg.type==='coll') sTxt = `${t.stBomb}: ${grenadesKilled}/${mCfg.val}`;
            else sTxt = `${t.stTime}: ${gameTime.toFixed(0)}`;
            document.getElementById('stats').innerText = sTxt;

            player.update();
            activePets.forEach(p => p.update());
            enemies.forEach((e, i) => { e.update(); if(e.dead) enemies.splice(i, 1); });
            bullets.forEach((b, i) => { b.update(); if(b.dead) bullets.splice(i, 1); });
            drops.forEach((d, i) => { 
                if(Math.hypot(d.x-player.x, d.y-player.y) < player.radius + 20) {
                    if(d.type==='coin') playerStats.coins+=10;
                    else if(d.type==='medkit') player.hp = Math.min(player.maxHp, player.hp+25);
                    else if(d.type==='artifact') playerStats.inventory.push(d.artifactType);
                    drops.splice(i, 1); updateUI();
                }
            });
            particles.forEach((p, i) => { p.update(); if(p.life<=0) particles.splice(i, 1); });
            
            bullets.forEach(b => {
                if(!b.isEnemy) {
                    enemies.forEach(e => {
                        if(!b.dead && Math.hypot(b.x-e.x, b.y-e.y) < e.radius+b.radius) {
                            e.takeDamage(b.dmg); b.dead = true; createParticles(b.x, b.y, 'red');
                        }
                    });
                } else {
                    if(!b.dead && Math.hypot(b.x-player.x, b.y-player.y) < player.radius+b.radius) {
                        player.takeDamage(b.dmg); b.dead = true;
                    }
                }
            });
            if(screenShake > 0) screenShake *= 0.9;
        }

        function spawnEnemy(type='standard') {
            let s=Math.floor(Math.random()*4), x, y; 
            if(s===0){x=Math.random()*canvas.width;y=-30;} else if(s===1){x=canvas.width+30;y=Math.random()*canvas.height;} 
            else if(s===2){x=Math.random()*canvas.width;y=canvas.height+30;} else{x=-30;y=Math.random()*canvas.height;} 
            enemies.push(new Enemy(x, y, type));
        }

        function drawGame() {
            ctx.clearRect(0,0,canvas.width, canvas.height);
            ctx.save();
            if(screenShake > 0.5) ctx.translate((Math.random()-0.5)*screenShake, (Math.random()-0.5)*screenShake);

            if(mCfg.dark) { ctx.fillStyle = '#050510'; ctx.fillRect(0,0,canvas.width, canvas.height); } 
            else { ctx.fillStyle = '#1a1a2e'; ctx.fillRect(0,0,canvas.width, canvas.height); ctx.fillStyle = 'rgba(255,255,255,0.05)'; decorations.forEach(d => { ctx.beginPath(); ctx.arc(d.x, d.y, d.size, 0, Math.PI*2); ctx.fill(); }); }

            if(mCfg.type === 'zone') {
                ctx.beginPath(); ctx.arc(captureZone.x, captureZone.y, captureZone.radius, 0, Math.PI*2);
                ctx.fillStyle = 'rgba(0,255,100,0.2)'; ctx.fill(); ctx.strokeStyle = '#00FF00'; ctx.lineWidth=2; ctx.stroke();
            }

            obstacles.forEach(o => o.draw());
            drops.forEach(d => d.draw());
            enemies.forEach(e => e.draw());
            bullets.forEach(b => b.draw());
            if(player && !player.dead) player.draw();
            activePets.forEach(p => p.draw());
            particles.forEach(p => p.draw());

            if(mCfg.dark) {
                ctx.setTransform(1,0,0,1,0,0);
                let g = ctx.createRadialGradient(player.x, player.y, 60, player.x, player.y, 300);
                g.addColorStop(0, 'rgba(0,0,0,0)'); g.addColorStop(1, 'rgba(0,0,0,0.95)');
                ctx.fillStyle = g; ctx.fillRect(0,0,canvas.width, canvas.height);
            }

            ctx.fillStyle = 'rgba(255,255,255,0.5)';
            snowflakes.forEach(s => { s.y+=s.s; if(s.y>canvas.height) s.y=-10; ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI*2); ctx.fill(); });
            ctx.restore();
        }

        // --- CLASSES ---
        class Rect { constructor(x,y,s){this.x=x;this.y=y;this.size=s;} draw(){ctx.fillStyle='#445';ctx.fillRect(this.x,this.y,this.size,this.size); ctx.strokeStyle='#223'; ctx.strokeRect(this.x,this.y,this.size,this.size);} }
        class Player { 
            constructor(x,y){
                this.x=x;this.y=y;this.hp=100;this.maxHp=100;this.radius=15;this.angle=0;this.weapon='pistol';
                if(megaEquipMode) this.maxHp=880; else if(playerStats.currentOutfit==='vest') this.maxHp=200;
                this.hp=this.maxHp;
            }
            update() {
                let spd = 4; let dx=0, dy=0;
                if(controlMode==='PC'){ if(keys['KeyW']) dy=-spd; if(keys['KeyS']) dy=spd; if(keys['KeyA']) dx=-spd; if(keys['KeyD']) dx=spd; this.angle = Math.atan2(mouse.y-this.y, mouse.x-this.x); if(mouse.down) this.shoot(); } 
                else { if(joystickLeft.active) { dx=joystickLeft.x*spd; dy=joystickLeft.y*spd; } if(joystickRight.active) { this.angle=Math.atan2(joystickRight.y, joystickRight.x); this.shoot(); } else if(dx||dy) this.angle=Math.atan2(dy,dx); }
                if(!this.checkCol(this.x+dx, this.y)) this.x+=dx; if(!this.checkCol(this.x, this.y+dy)) this.y+=dy;
                this.x=Math.max(15,Math.min(canvas.width-15,this.x)); this.y=Math.max(15,Math.min(canvas.height-15,this.y));
            }
            checkCol(x,y){ for(let o of obstacles) if(x>o.x && x<o.x+o.size && y>o.y && y<o.y+o.size) return true; return false; }
            shoot() { if(this.cooldown>0) {this.cooldown--; return;} this.cooldown=10; bullets.push(new Bullet(this.x, this.y, {x:Math.cos(this.angle)*15,y:Math.sin(this.angle)*15}, false, 25)); }
            takeDamage(amt){ if(playerStats.godMode) return; this.hp-=amt; screenShake=5; if(this.hp<=0) gameOver(false); updateUI(); }
            draw() { 
                ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.angle);
                ctx.fillStyle=playerStats.color; ctx.beginPath(); ctx.arc(0,0,15,0,Math.PI*2); ctx.fill(); 
                ctx.fillStyle='#000'; ctx.fillRect(10,-3,15,6); 
                if(megaEquipMode || playerStats.currentOutfit === 'crown') { ctx.fillStyle='gold'; ctx.beginPath(); ctx.moveTo(-10,-10); ctx.lineTo(0,-20); ctx.lineTo(10,-10); ctx.fill(); }
                ctx.restore();
            }
        }
        class Enemy {
            constructor(x,y,type){this.x=x;this.y=y;this.type=type;this.hp=40;this.radius=15;this.speed=1.5; if(type==='boss'){this.hp=500;this.radius=35;} if(type==='tank') {this.hp=200; this.radius=25;}}
            update(){ let a = Math.atan2(player.y-this.y, player.x-this.x); let d = Math.hypot(player.x-this.x, player.y-this.y); if(d > this.radius + 15) { this.x+=Math.cos(a)*this.speed; this.y+=Math.sin(a)*this.speed; } }
            draw(){ ctx.save(); ctx.translate(this.x, this.y); ctx.fillStyle = this.type==='boss'?'purple':(this.type==='tank'?'#004400':'red'); ctx.beginPath(); ctx.arc(0,0,this.radius,0,Math.PI*2); ctx.fill(); ctx.restore(); }
            takeDamage(d){ this.hp-=d; if(this.hp<=0) { this.dead=true; enemiesKilled++; addXp(10); if(Math.random()<0.3) drops.push({x:this.x, y:this.y, type:'coin'}); } }
        }
        class Bullet { constructor(x,y,vel,isEnemy,dmg){this.x=x;this.y=y;this.vel=vel;this.isEnemy=isEnemy;this.dmg=dmg;this.radius=4;} update(){this.x+=this.vel.x;this.y+=this.vel.y; if(this.x<0||this.x>canvas.width)this.dead=true;} draw(){ctx.fillStyle=this.isEnemy?'orange':'yellow';ctx.beginPath();ctx.arc(this.x,this.y,this.radius,0,Math.PI*2);ctx.fill();} }
        class Particle { constructor(x,y,c){this.x=x;this.y=y;this.c=c;this.vx=(Math.random()-0.5)*5;this.vy=(Math.random()-0.5)*5;this.life=20;} update(){this.x+=this.vx;this.y+=this.vy;this.life--;} draw(){ctx.globalAlpha=this.life/20;ctx.fillStyle=this.c;ctx.fillRect(this.x,this.y,3,3);ctx.globalAlpha=1;} }
        class Pet { constructor(t,i){this.type=t;this.x=player.x;this.y=player.y;this.off=i*10;} update(){this.x+=(player.x-this.x)*0.05; this.y+=(player.y-this.y)*0.05;} draw(){ctx.fillStyle='cyan';ctx.beginPath();ctx.arc(this.x+this.off,this.y-20,5,0,Math.PI*2);ctx.fill();} }
        class DropItem { constructor(x,y,t,at){this.x=x;this.y=y;this.type=t;this.artifactType=at||'rusty_gear';} draw(){ctx.fillStyle=this.type==='coin'?'gold':'lime';ctx.beginPath();ctx.arc(this.x,this.y,10,0,Math.PI*2);ctx.fill();} }

        function renderShop() {
            const acc = document.getElementById('accessories-list'); acc.innerHTML='';
            ['none','santa_hat','helmet','vest','nvg','crown'].forEach(i=>{ let d=document.createElement('div'); d.className='shop-item'; d.innerHTML=`<span>${LANG[curLang].items[i]}</span>`; acc.appendChild(d); });
        }
        function createParticles(x,y,c){for(let i=0;i<5;i++)particles.push(new Particle(x,y,c));}
        function addXp(amt){playerStats.xp+=amt; if(playerStats.xp>=playerStats.nextLevelXp){playerStats.level++; playerStats.xp=0; player.hp=player.maxHp; document.getElementById('levelup-notify').style.opacity=1; setTimeout(()=>document.getElementById('levelup-notify').style.opacity=0,2000);} updateUI();}
        function gameOver(win){ gameState='GAMEOVER'; alert(win?"VICTORY":"DEFEAT"); showMainMenu(); }
        function showMainMenu(){ gameState='MENU'; document.getElementById('menu-overlay').style.display='flex'; document.getElementById('game-ui').style.display='none'; }
        function playCustomMap() { if(customMap.spawns.length===0)alert("No spawns!"); else startMission('CUSTOM', {}); }
        function loadGame(){ try{let d=JSON.parse(localStorage.getItem('tacticalShooter_fixed')); if(d) { playerStats={...playerStats,...d.stats}; if(d.lang) curLang = d.lang; if(d.map) customMap=d.map;} applyLang(); }catch(e){applyLang();} }
        function saveGame(){ localStorage.setItem('tacticalShooter_fixed', JSON.stringify({stats: playerStats, lang: curLang, map: customMap})); }
        function updateUI(){ if(gameState==='PLAYING'){ document.getElementById('health-fill').style.width=(player.hp/player.maxHp)*100+'%'; document.getElementById('xp-fill').style.width=(playerStats.xp/playerStats.nextLevelXp)*100+'%'; document.getElementById('coin-counter').innerText='üí∞ '+playerStats.coins; } }
        function redeemCode() { let c = document.getElementById('promo-input').value.trim().toUpperCase(); if(c === '2KFNWKC') { megaEquipMode = true; alert("MEGA MODE!"); return; } }
        function selectPlatform(m) { controlMode = m; document.getElementById('platform-screen').style.display='none'; showMainMenu(); }
        
        function openSettings() { document.getElementById('settings-screen').style.display='flex'; }
        function closeSettings() { document.getElementById('settings-screen').style.display='none'; }
        function openShop() { document.getElementById('shop-screen').style.display='flex'; renderShop(); }
        function closeShop() { document.getElementById('shop-screen').style.display='none'; }
        function openEditor() { gameState='EDITOR'; document.getElementById('menu-overlay').style.display='none'; }
        
        window.addEventListener('keydown',e=>keys[e.code]=true); window.addEventListener('keyup',e=>keys[e.code]=false);
        window.addEventListener('mousemove',e=>{mouse.x=e.clientX;mouse.y=e.clientY});
        window.addEventListener('mousedown',()=>mouse.down=true); window.addEventListener('mouseup',()=>mouse.down=false);
        
        document.addEventListener('touchstart',e=>{
            if(controlMode!=='MOBILE'||gameState!=='PLAYING')return;
            for(let i=0;i<e.changedTouches.length;i++){
                let t=e.changedTouches[i];
                if(t.target.id==='mobile-grenade-btn')continue;
                if(t.clientX<window.innerWidth/2) { joystickLeft.active=true; joystickLeft.id=t.identifier; joystickLeft.sx=t.clientX; joystickLeft.sy=t.clientY; }
                else { joystickRight.active=true; joystickRight.id=t.identifier; joystickRight.sx=t.clientX; joystickRight.sy=t.clientY; }
            }
        },{passive:false});
        document.addEventListener('touchmove',e=>{
            if(controlMode!=='MOBILE'||gameState!=='PLAYING')return; e.preventDefault();
            for(let i=0;i<e.changedTouches.length;i++){
                let t=e.changedTouches[i];
                if(t.identifier===joystickLeft.id){
                     let dx=t.clientX-joystickLeft.sx, dy=t.clientY-joystickLeft.sy;
                     let d=Math.min(Math.hypot(dx,dy),40); let a=Math.atan2(dy,dx);
                     joystickLeft.x=Math.cos(a)*(d/40); joystickLeft.y=Math.sin(a)*(d/40);
                     document.getElementById('knob-left').style.transform=`translate(-50%,-50%) translate(${joystickLeft.x*40}px,${joystickLeft.y*40}px)`;
                }
                if(t.identifier===joystickRight.id){
                     let dx=t.clientX-joystickRight.sx, dy=t.clientY-joystickRight.sy;
                     let d=Math.min(Math.hypot(dx,dy),40); let a=Math.atan2(dy,dx);
                     joystickRight.x=Math.cos(a)*(d/40); joystickRight.y=Math.sin(a)*(d/40);
                     document.getElementById('knob-right').style.transform=`translate(-50%,-50%) translate(${joystickRight.x*40}px,${joystickRight.y*40}px)`;
                }
            }
        },{passive:false});
        document.addEventListener('touchend',e=>{
             for(let i=0;i<e.changedTouches.length;i++){
                let t=e.changedTouches[i];
                if(t.identifier===joystickLeft.id){joystickLeft.active=false; joystickLeft.x=0; joystickLeft.y=0; document.getElementById('knob-left').style.transform='translate(-50%,-50%)';}
                if(t.identifier===joystickRight.id){joystickRight.active=false; document.getElementById('knob-right').style.transform='translate(-50%,-50%)';}
             }
        });
        function throwGrenadeMobile(){if(player)player.shoot();}

        function loop() { requestAnimationFrame(loop); if(gameState==='PLAYING') { updateGame(); drawGame(); } }
        loop();
    </script>
</body>
</html>
