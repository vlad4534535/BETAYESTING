<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tactical Shooter: V16 MULTILANGUAGE</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body {
            margin: 0; overflow: hidden; background-color: #151525;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white; user-select: none; -webkit-user-select: none; touch-action: none;
        }
        canvas { display: block; }
        
        /* UI STYLES */
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #1a2a40 0%, #0a101a 100%);
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 20;
        }
        h1 { margin-bottom: 5px; font-size: 32px; color: #00AAFF; text-align: center; text-transform: uppercase; text-shadow: 0 0 15px #0077FF; letter-spacing: 2px; }
        
        .btn {
            background: linear-gradient(180deg, #2a3a50 0%, #1a202a 100%); 
            color: white; border: 1px solid #4a5a70; padding: 12px;
            font-size: 14px; cursor: pointer; text-align: left; font-family: inherit; margin: 2px;
            border-radius: 6px; position: relative; overflow: hidden; transition: all 0.1s;
            display: flex; flex-direction: column; justify-content: center;
        }
        .btn:hover { background: #3a4a60; border-color: #00AAFF; transform: translateY(-2px); }
        .btn::after { content: '‚ùÑÔ∏è'; position: absolute; top: 2px; right: 2px; font-size: 10px; opacity: 0.3; }
        
        .mission-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; max-height: 50vh; overflow-y: auto; width: 95%; max-width: 800px; padding: 5px;}
        .menu-wide-btn { width: 300px; margin-top:5px; text-align: center; font-weight: bold; font-size: 16px; padding: 12px; background: #222; border: 2px solid #555; align-items: center; }
        
        /* GAME UI */
        #game-ui { display: none; position: absolute; top: 10px; left: 10px; width: 100%; pointer-events: none; z-index: 5; box-sizing: border-box; padding-right: 20px;}
        #top-bar { display: flex; justify-content: space-between; align-items: flex-start; }
        .stat-box { background: rgba(0, 20, 40, 0.8); padding: 5px 12px; border-radius: 8px; margin-bottom: 5px; font-size: 16px; border: 1px solid rgba(0, 150, 255, 0.3); }
        #mission-text { font-size: 20px; font-weight: 800; color: #00FFFF; text-shadow: 0 0 10px rgba(0,255,255,0.5); }
        
        .bar-container { margin-top: 5px; width: 220px; height: 16px; background: #222; border: 1px solid #555; position: relative; border-radius: 4px; overflow: hidden; }
        #health-fill { width: 100%; height: 100%; background: linear-gradient(90deg, #00FF00, #00CC00); transition: width 0.1s; }
        #xp-fill { width: 0%; height: 100%; background: linear-gradient(90deg, #0077FF, #00FFFF); transition: width 0.2s; }

        /* SHOP */
        #shop-screen { display: none; }
        .shop-container { display: flex; gap: 20px; width: 95%; max-width: 1000px; justify-content: center; flex-wrap: wrap; }
        .shop-column { background: #1a2230; padding: 15px; border: 1px solid #334455; width: 200px; border-radius: 8px; }
        .shop-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px; font-size: 12px; }
        
        /* MOBILE CONTROLS */
        #mobile-controls { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .joystick-zone { position: absolute; bottom: 40px; width: 90px; height: 90px; background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 50%; pointer-events: auto; }
        .joystick-knob { position: absolute; top: 50%; left: 50%; width: 40px; height: 40px; background: rgba(0, 119, 255, 0.5); border-radius: 50%; transform: translate(-50%, -50%); }
        #mobile-grenade-btn { position: absolute; bottom: 100px; right: 130px; width: 50px; height: 50px; background: rgba(255, 165, 0, 0.2); border: 2px solid #FFA500; border-radius: 50%; display: flex; justify-content: center; align-items: center; pointer-events: auto; }
        #weapon-bar { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; pointer-events: auto; }
        .wpn-btn { width: 40px; height: 40px; background: #222; border: 1px solid #444; color: white; font-size: 9px; font-weight: bold; display: flex; justify-content: center; align-items: center; border-radius: 6px; }
        .wpn-btn.active { border-color: #00AAFF; background: #003366; }

        /* LANGUAGE SELECTOR IN SETTINGS */
        .lang-btn { width: 80px; padding: 10px; margin: 5px; background: #333; border: 1px solid #555; color: white; cursor: pointer; }
        .lang-btn.active { background: #0077FF; border-color: #fff; }

        /* NOTIFICATIONS */
        #levelup-notify, #artifact-notify { position: absolute; top: 30%; left: 50%; transform: translate(-50%, -50%); text-align: center; opacity: 0; pointer-events: none; z-index: 100; transition: opacity 0.5s; }
    </style>
</head>
<body>

    <div id="levelup-notify">
        <div id="notif-lvl-title" style="font-size:40px; color:#FFD700; text-shadow:0 0 20px orange; font-weight:900;">LEVEL UP!</div>
        <div id="notif-lvl-desc" style="font-size:20px; color:white;">HP RESTORED</div>
    </div>
    <div id="artifact-notify">
        <div id="notif-art-title" style="font-size:30px; color:#00FFFF; text-shadow:0 0 20px blue; font-weight:900;">FOUND!</div>
    </div>

    <div id="platform-screen" class="overlay" style="z-index: 30;">
        <h1 id="lbl-title-main">WINTER OPS<br><span style="font-size:18px; color:white;">TACTICAL SHOOTER V16</span></h1>
        <div style="margin-top:20px;">
            <button class="btn menu-wide-btn" onclick="selectPlatform('PC')" id="btn-plat-pc">üíª PC (Mouse/Keys)</button>
            <button class="btn menu-wide-btn" onclick="selectPlatform('MOBILE')" id="btn-plat-mob">üì± Mobile (Touch)</button>
        </div>
        <div style="margin-top:20px;">
            <button class="lang-btn" onclick="setLanguage('en')">EN</button>
            <button class="lang-btn" onclick="setLanguage('ua')">UA</button>
            <button class="lang-btn" onclick="setLanguage('ru')">RU</button>
        </div>
    </div>

    <div id="settings-screen" class="overlay" style="display:none; z-index: 35;">
        <h1 id="lbl-settings">SETTINGS</h1>
        <div style="margin: 20px;">
            <button class="lang-btn" onclick="setLanguage('en')">EN</button>
            <button class="lang-btn" onclick="setLanguage('ua')">UA</button>
            <button class="lang-btn" onclick="setLanguage('ru')">RU</button>
        </div>
        <button class="btn menu-wide-btn" onclick="closeSettings()" style="border-color:red;" id="btn-close-settings">CLOSE</button>
    </div>

    <div id="menu-overlay" class="overlay" style="display: none;">
        <h1 id="lbl-campaign">CAMPAIGN</h1>
        <div class="menu-stats" style="color:#FFFF00; border:1px solid #555; padding:10px; margin-bottom:10px;">
            <span id="lbl-lvl">LVL</span>: <span id="menu-level">1</span> | XP: <span id="menu-xp">0</span> | üí∞: <span id="menu-coins">0</span>
        </div>
        
        <div id="menu-buttons" class="mission-grid"></div>
        
        <div style="display:flex; flex-wrap:wrap; justify-content:center; gap:5px; width:100%; max-width:800px;">
            <button class="btn menu-wide-btn" style="width:48%; background:#003300; border-color:#00FF00;" onclick="startTraining()" id="btn-training">üéØ TRAINING</button>
            <button class="btn menu-wide-btn" style="width:48%; background:#330033; border-color:#FF00FF;" onclick="openMultiplayer()" id="btn-online">üåê ONLINE</button>
            <button class="btn menu-wide-btn" style="width:48%; border-color:#00FFFF;" onclick="playCustomMap()" id="btn-custom">üó∫Ô∏è CUSTOM MAP</button>
            <button class="btn menu-wide-btn" style="width:48%; border-color:#00FF00;" onclick="openEditor()" id="btn-editor">üõ†Ô∏è EDITOR</button>
        </div>

        <button class="btn menu-wide-btn shop-btn" onclick="openShop()" id="btn-shop">üõí SHOP / SKILLS</button>
        <button class="btn menu-wide-btn" onclick="openSettings()" style="margin-top:10px;" id="btn-settings">‚öôÔ∏è SETTINGS</button>
        <button id="end-game-btn" class="btn menu-wide-btn" onclick="showMainMenu()" style="display:none; background: #FF3333; margin-top: 20px;" id="btn-menu-back">MAIN MENU</button>
    </div>

    <div id="game-ui">
        <button id="exit-mission-btn" onclick="showMainMenu()" style="position: absolute; top: 0; left: 50%; transform: translateX(-50%); background: rgba(255, 0, 0, 0.2); border: 1px solid red; color: red; padding: 5px 20px; font-weight: bold; pointer-events: auto;">EXIT</button>
        <div id="top-bar">
            <div>
                <div id="mission-text">MISSION</div>
                <div class="bar-container" id="health-bar"><div id="health-fill"></div></div>
                <div class="bar-container" style="height:6px; margin-top:5px; background:#111; border:none;"><div id="xp-fill"></div></div>
                <div class="stat-box" id="weapon-info" style="margin-top: 5px; font-size:12px;">PISTOL</div>
            </div>
            <div style="text-align: right;">
                <div class="stat-box" id="stats">Time: 0</div>
                <div class="stat-box" id="grenade-counter" style="color:orange;">üí£ 3</div>
                <div class="stat-box" id="coin-counter" style="color:yellow;">$ 0</div>
            </div>
        </div>
    </div>

    <div id="shop-screen" class="overlay" style="z-index: 25; display: none; overflow-y: auto;">
        <h1 id="lbl-shop-title">SHOP</h1>
        <div style="color: yellow; margin-bottom: 5px;">üí∞: <span id="shop-coins">0</span></div>
        <div class="shop-container">
            <div class="shop-column">
                <h3 id="lbl-look">LOOK</h3>
                <canvas id="previewCanvas" width="150" height="150" style="background:#222; border-radius:50%; margin-bottom:5px;"></canvas>
                <input type="color" id="colorPicker" value="#0077FF" onchange="updatePreview()">
            </div>
            <div class="shop-column"><h3 id="lbl-gear">GEAR</h3><div id="accessories-list"></div></div>
            <div class="shop-column"><h3 id="lbl-weapons">WEAPONS</h3><div id="weapons-list"></div></div>
            <div class="shop-column"><h3 id="lbl-pets">PETS</h3><div id="pets-list"></div></div>
            <div class="shop-column">
                <h3 id="lbl-inv">INVENTORY</h3><div id="inventory-list">Empty</div>
                <div style="margin-top:10px; border-top:1px dashed #555; padding-top:5px;">
                    <input type="text" id="promo-input" placeholder="CODE" style="width:100px; padding:5px;">
                    <button class="btn" onclick="redeemCode()" style="display:inline-block; padding:5px;">OK</button>
                </div>
            </div>
        </div>
        <button class="btn menu-wide-btn" onclick="closeShop()" style="position:fixed; bottom:10px; border-color:red;" id="btn-shop-exit">EXIT</button>
    </div>

    <div id="mobile-controls">
        <div id="stick-left" class="joystick-zone"><div class="joystick-knob" id="knob-left"></div></div>
        <div id="stick-right" class="joystick-zone" style="right:20px;"><div class="joystick-knob" id="knob-right" style="background:rgba(255,50,50,0.5);"></div></div>
        <div id="mobile-grenade-btn" onclick="throwGrenadeMobile()">üí£</div>
        <div id="weapon-bar"></div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        // --- LOCALIZATION DATA ---
        const TEXT = {
            en: {
                title: "WINTER OPS", platPC: "üíª PC (Mouse/Keys)", platMob: "üì± Mobile (Touch)",
                campaign: "CAMPAIGN", training: "üéØ TRAINING", online: "üåê ONLINE", custom: "üó∫Ô∏è CUSTOM MAP", editor: "üõ†Ô∏è EDITOR",
                shop: "üõí SHOP / SKILLS", settings: "‚öôÔ∏è SETTINGS", back: "MAIN MENU", close: "CLOSE", exit: "EXIT",
                lvl: "LVL", shopTitle: "SHOP", look: "LOOK", gear: "GEAR", weapons: "WEAPONS", pets: "PETS", inv: "INVENTORY",
                notifLvl: "LEVEL UP!", notifHp: "HP RESTORED", notifArt: "FOUND!",
                statTime: "Time", statKills: "Kills", statZone: "Zone", statBomb: "Bomb",
                win: "VICTORY", loss: "DEFEAT",
                missions: {
                    1: {n: "First Contact", d: "Survive 20 seconds"},
                    2: {n: "Sector Clear", d: "Kill 5 enemies"},
                    3: {n: "Beast's Lair", d: "Kill the BOSS"},
                    4: {n: "The Horde", d: "Survive 40 sec"},
                    5: {n: "Meat Grinder", d: "Kill 50 enemies"},
                    6: {n: "Veteran", d: "Hardcore Survival (60s)"},
                    7: {n: "Sapper", d: "Defuse/Collect 15 bombs"},
                    8: {n: "Apocalypse", d: "Hell on Earth (50s)"},
                    9: {n: "Hold Point", d: "Stay in zone 15s"},
                    10: {n: "Night Raid", d: "Darkness (Kill 10)"},
                    11: {n: "Sniper Duel", d: "Kill 10 Snipers"},
                    13: {n: "Heavy Artillery", d: "Kill 30 (Bazooka Only)"},
                    14: {n: "Base Defense", d: "Hold tanks (60s)"},
                    15: {n: "Double Trouble", d: "TWO BOSSES"},
                    16: {n: "Tank Rush", d: "Destroy 15 Tanks"},
                    17: {n: "Speedrun", d: "Fast enemies (45s)"},
                    18: {n: "Boss Rush", d: "Kill 3 Bosses"},
                    19: {n: "Infinity", d: "Kill 100 enemies"},
                    20: {n: "The Finale", d: "Survive 120 seconds"}
                },
                items: {
                    none: "None", santa_hat: "Santa Hat", cap: "Cap", helmet: "Helmet", vest: "Vest", nvg: "NVG", full_armor: "Juggernaut", chain: "Chain", crown: "Crown",
                    pistol: "Pistol", rifle: "Rifle", shotgun: "Shotgun", sniper: "Sniper", minigun: "Minigun", snowball: "Snowball", bazooka: "Bazooka", laser: "Laser", crossbow: "Crossbow", plasma: "Plasma",
                    drone: "Drone", slime: "Slime", ufo: "UFO", wisp: "Wisp", turret: "Turret"
                }
            },
            ua: {
                title: "–ó–ò–ú–û–í–ê –û–ü–ï–†–ê–¶–Ü–Ø", platPC: "üíª –ü–ö (–ú–∏—à–∞/–ö–ª–∞–≤—ñ—à—ñ)", platMob: "üì± –¢–µ–ª–µ—Ñ–æ–Ω (–°–µ–Ω—Å–æ—Ä)",
                campaign: "–ö–ê–ú–ü–ê–ù–Ü–Ø", training: "üéØ –¢–†–ï–ù–£–í–ê–ù–ù–Ø", online: "üåê –û–ù–õ–ê–ô–ù", custom: "üó∫Ô∏è –°–í–û–Ø –ö–ê–†–¢–ê", editor: "üõ†Ô∏è –†–ï–î–ê–ö–¢–û–†",
                shop: "üõí –ú–ê–ì–ê–ó–ò–ù / –°–ö–Ü–õ–ò", settings: "‚öôÔ∏è –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø", back: "–ì–û–õ–û–í–ù–ï –ú–ï–ù–Æ", close: "–ó–ê–ö–†–ò–¢–ò", exit: "–í–ò–•–Ü–î",
                lvl: "–†–Ü–í–ï–ù–¨", shopTitle: "–ú–ê–ì–ê–ó–ò–ù", look: "–í–ò–ì–õ–Ø–î", gear: "–ï–ö–Ü–ü–Ü–†–£–í–ê–ù–ù–Ø", weapons: "–ó–ë–†–û–Ø", pets: "–ü–Ü–¢–û–ú–¶–Ü", inv: "–Ü–ù–í–ï–ù–¢–ê–†",
                notifLvl: "–ù–û–í–ò–ô –†–Ü–í–ï–ù–¨!", notifHp: "–ñ–ò–¢–¢–Ø –í–Ü–î–ù–û–í–õ–ï–ù–û", notifArt: "–ó–ù–ê–•–Ü–î–ö–ê!",
                statTime: "–ß–∞—Å", statKills: "–í–±–∏—Ç–æ", statZone: "–ó–æ–Ω–∞", statBomb: "–ë–æ–º–±–∏",
                win: "–ü–ï–†–ï–ú–û–ì–ê", loss: "–ü–û–†–ê–ó–ö–ê",
                missions: {
                    1: {n: "–ü–µ—Ä—à–∏–π –ö–æ–Ω—Ç–∞–∫—Ç", d: "–í–∏–∂–∏—Ç–∏ 20 —Å–µ–∫—É–Ω–¥"},
                    2: {n: "–ó–∞—á–∏—Å—Ç–∫–∞ –°–µ–∫—Ç–æ—Ä–∞", d: "–õ—ñ–∫–≤—ñ–¥—É–≤–∞—Ç–∏ 5 –≤–æ—Ä–æ–≥—ñ–≤"},
                    3: {n: "–õ—ñ–≥–≤–æ –ó–≤—ñ—Ä–∞", d: "–ó–Ω–∏—â–∏—Ç–∏ –ë–û–°–ê"},
                    4: {n: "–ù–∞–≤–∞–ª–∞", d: "–í–∏–∂–∏—Ç–∏ 40 —Å–µ–∫—É–Ω–¥"},
                    5: {n: "–ú'—è—Å–æ—Ä—É–±–∫–∞", d: "–í–±–∏—Ç–∏ 50 –≤–æ—Ä–æ–≥—ñ–≤"},
                    6: {n: "–í–µ—Ç–µ—Ä–∞–Ω", d: "–•–∞—Ä–¥–∫–æ—Ä (60—Å)"},
                    7: {n: "–°–∞–ø–µ—Ä", d: "–ó—ñ–±—Ä–∞—Ç–∏ 15 –±–æ–º–±"},
                    8: {n: "–ê–ø–æ–∫–∞–ª—ñ–ø—Å–∏—Å", d: "–ü–µ–∫–ª–æ (50—Å)"},
                    9: {n: "–¢–æ—á–∫–∞ –£—Ç—Ä–∏–º–∞–Ω–Ω—è", d: "–°—Ç—ñ–π –≤ –∫–æ–ª—ñ 15—Å"},
                    10: {n: "–ù—ñ—á–Ω–∏–π –†–µ–π–¥", d: "–¢–µ–º—Ä—è–≤–∞ (–í–±–∏—Ç–∏ 10)"},
                    11: {n: "–î—É–µ–ª—å –°–Ω–∞–π–ø–µ—Ä—ñ–≤", d: "–õ—ñ–∫–≤—ñ–¥—É–≤–∞—Ç–∏ 10 —Å–Ω–∞–π–ø–µ—Ä—ñ–≤"},
                    13: {n: "–í–∞–∂–∫–∞ –ê—Ä—Ç–∏–ª–µ—Ä—ñ—è", d: "–í–±–∏—Ç–∏ 30 (–¢—ñ–ª—å–∫–∏ –ë–∞–∑—É–∫–∞)"},
                    14: {n: "–û–±–æ—Ä–æ–Ω–∞ –ë–∞–∑–∏", d: "–°—Ç—Ä–∏–º—É–≤–∞—Ç–∏ —Ç–∞–Ω–∫–∏ (60—Å)"},
                    15: {n: "–ü–æ–¥–≤—ñ–π–Ω–∞ –ó–∞–≥—Ä–æ–∑–∞", d: "–î–í–ê –ë–û–°–ê"},
                    16: {n: "–¢–∞–Ω–∫–æ–≤–∏–π –ü—Ä–æ—Ä–∏–≤", d: "–ó–Ω–∏—â–∏—Ç–∏ 15 —Ç–∞–Ω–∫—ñ–≤"},
                    17: {n: "–°–ø—ñ–¥—Ä–∞–Ω", d: "–®–≤–∏–¥–∫—ñ –≤–æ—Ä–æ–≥–∏ (45—Å)"},
                    18: {n: "Boss Rush", d: "–í–±–∏—Ç–∏ 3 –ë–æ—Å—ñ–≤"},
                    19: {n: "–ù–µ—Å–∫—ñ–Ω—á–µ–Ω–Ω—ñ—Å—Ç—å", d: "–í–±–∏—Ç–∏ 100 –≤–æ—Ä–æ–≥—ñ–≤"},
                    20: {n: "–§—ñ–Ω–∞–ª", d: "–í–∏–∂–∏—Ç–∏ 120 —Å–µ–∫—É–Ω–¥"}
                },
                items: {
                    none: "–ù–µ–º–∞—î", santa_hat: "–®–∞–ø–∫–∞ –°–∞–Ω—Ç–∏", cap: "–ö–µ–ø–∫–∞", helmet: "–ö–∞—Å–∫–∞", vest: "–ñ–∏–ª–µ—Ç", nvg: "–ü–ù–ë (NVG)", full_armor: "–î–∂–∞–≥–≥–µ—Ä–Ω–∞—É—Ç", chain: "–õ–∞–Ω—Ü—é–≥", crown: "–ö–æ—Ä–æ–Ω–∞",
                    pistol: "–ü—ñ—Å—Ç–æ–ª–µ—Ç", rifle: "–ê–≤—Ç–æ–º–∞—Ç", shotgun: "–î—Ä–æ–±–æ–≤–∏–∫", sniper: "–°–Ω–∞–π–ø–µ—Ä", minigun: "–ö—É–ª–µ–º–µ—Ç", snowball: "–°–Ω—ñ–≥–æ–º–µ—Ç", bazooka: "–ë–∞–∑—É–∫–∞", laser: "–õ–∞–∑–µ—Ä", crossbow: "–ê—Ä–±–∞–ª–µ—Ç", plasma: "–ü–ª–∞–∑–º–∞",
                    drone: "–î—Ä–æ–Ω", slime: "–°–ª–∞–π–º", ufo: "–ù–õ–û", wisp: "–í–æ–≥–Ω–∏–∫", turret: "–¢—É—Ä–µ–ª—å"
                }
            },
            ru: {
                title: "–ó–ò–ú–ù–Ø–Ø –û–ü–ï–†–ê–¶–ò–Ø", platPC: "üíª –ü–ö (–ú—ã—à—å/–ö–ª–∞–≤–∏—à–∏)", platMob: "üì± –¢–µ–ª–µ—Ñ–æ–Ω (–°–µ–Ω—Å–æ—Ä)",
                campaign: "–ö–ê–ú–ü–ê–ù–ò–Ø", training: "üéØ –¢–†–ï–ù–ò–†–û–í–ö–ê", online: "üåê –û–ù–õ–ê–ô–ù", custom: "üó∫Ô∏è –°–í–û–Ø –ö–ê–†–¢–ê", editor: "üõ†Ô∏è –†–ï–î–ê–ö–¢–û–†",
                shop: "üõí –ú–ê–ì–ê–ó–ò–ù / –°–ö–ò–õ–õ–´", settings: "‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò", back: "–ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ", close: "–ó–ê–ö–†–´–¢–¨", exit: "–í–´–•–û–î",
                lvl: "–£–†–û–í–ï–ù–¨", shopTitle: "–ú–ê–ì–ê–ó–ò–ù", look: "–í–ò–î", gear: "–≠–ö–ò–ü–ò–†–û–í–ö–ê", weapons: "–û–†–£–ñ–ò–ï", pets: "–ü–ò–¢–û–ú–¶–´", inv: "–ò–ù–í–ï–ù–¢–ê–†–¨",
                notifLvl: "–ù–û–í–´–ô –£–†–û–í–ï–ù–¨!", notifHp: "–ñ–ò–ó–ù–ò –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–´", notifArt: "–ù–ê–•–û–î–ö–ê!",
                statTime: "–í—Ä–µ–º—è", statKills: "–£–±–∏—Ç–æ", statZone: "–ó–æ–Ω–∞", statBomb: "–ë–æ–º–±—ã",
                win: "–ü–û–ë–ï–î–ê", loss: "–ü–û–†–ê–ñ–ï–ù–ò–ï",
                missions: {
                    1: {n: "–ü–µ—Ä–≤—ã–π –ö–æ–Ω—Ç–∞–∫—Ç", d: "–í—ã–∂–∏—Ç—å 20 —Å–µ–∫—É–Ω–¥"},
                    2: {n: "–ó–∞—á–∏—Å—Ç–∫–∞ –°–µ–∫—Ç–æ—Ä–∞", d: "–õ–∏–∫–≤–∏–¥–∏—Ä–æ–≤–∞—Ç—å 5 –≤—Ä–∞–≥–æ–≤"},
                    3: {n: "–õ–æ–≥–æ–≤–æ –ó–≤–µ—Ä—è", d: "–£–Ω–∏—á—Ç–æ–∂–∏—Ç—å –ë–û–°–°–ê"},
                    4: {n: "–ù–∞—à–µ—Å—Ç–≤–∏–µ", d: "–í—ã–∂–∏—Ç—å 40 —Å–µ–∫—É–Ω–¥"},
                    5: {n: "–ú—è—Å–æ—Ä—É–±–∫–∞", d: "–£–±–∏—Ç—å 50 –≤—Ä–∞–≥–æ–≤"},
                    6: {n: "–í–µ—Ç–µ—Ä–∞–Ω", d: "–•–∞—Ä–¥–∫–æ—Ä (60—Å)"},
                    7: {n: "–°–∞–ø–µ—Ä", d: "–°–æ–±—Ä–∞—Ç—å 15 –±–æ–º–±"},
                    8: {n: "–ê–ø–æ–∫–∞–ª–∏–ø—Å–∏—Å", d: "–ê–¥ (50—Å)"},
                    9: {n: "–¢–æ—á–∫–∞ –£–¥–µ—Ä–∂–∞–Ω–∏—è", d: "–°—Ç–æ–π –≤ –∫—Ä—É–≥—É 15—Å"},
                    10: {n: "–ù–æ—á–Ω–æ–π –†–µ–π–¥", d: "–¢—å–º–∞ (–£–±–∏—Ç—å 10)"},
                    11: {n: "–î—É—ç–ª—å –°–Ω–∞–π–ø–µ—Ä–æ–≤", d: "–£–±–∏—Ç—å 10 —Å–Ω–∞–π–ø–µ—Ä–æ–≤"},
                    13: {n: "–¢—è–∂–µ–ª–∞—è –ê—Ä—Ç–∏–ª–ª–µ—Ä–∏—è", d: "–£–±–∏—Ç—å 30 (–¢–æ–ª—å–∫–æ –ë–∞–∑—É–∫–∞)"},
                    14: {n: "–û–±–æ—Ä–æ–Ω–∞ –ë–∞–∑—ã", d: "–°–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Ç–∞–Ω–∫–∏ (60—Å)"},
                    15: {n: "–î–≤–æ–π–Ω–∞—è –£–≥—Ä–æ–∑–∞", d: "–î–í–ê –ë–û–°–°–ê"},
                    16: {n: "–¢–∞–Ω–∫–æ–≤—ã–π –ü—Ä–æ—Ä—ã–≤", d: "–£–Ω–∏—á—Ç–æ–∂–∏—Ç—å 15 —Ç–∞–Ω–∫–æ–≤"},
                    17: {n: "–°–ø–∏–¥—Ä–∞–Ω", d: "–ë—ã—Å—Ç—Ä—ã–µ –≤—Ä–∞–≥–∏ (45—Å)"},
                    18: {n: "Boss Rush", d: "–£–±–∏—Ç—å 3 –ë–æ—Å—Å–æ–≤"},
                    19: {n: "–ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å", d: "–£–±–∏—Ç—å 100 –≤—Ä–∞–≥–æ–≤"},
                    20: {n: "–§–∏–Ω–∞–ª", d: "–í—ã–∂–∏—Ç—å 120 —Å–µ–∫—É–Ω–¥"}
                },
                items: {
                    none: "–ù–µ—Ç", santa_hat: "–®–∞–ø–∫–∞ –°–∞–Ω—Ç—ã", cap: "–ö–µ–ø–∫–∞", helmet: "–ö–∞—Å–∫–∞", vest: "–ñ–∏–ª–µ—Ç", nvg: "–ü–ù–í (NVG)", full_armor: "–î–∂–∞–≥–≥–µ—Ä–Ω–∞—É—Ç", chain: "–¶–µ–ø—å", crown: "–ö–æ—Ä–æ–Ω–∞",
                    pistol: "–ü–∏—Å—Ç–æ–ª–µ—Ç", rifle: "–ê–≤—Ç–æ–º–∞—Ç", shotgun: "–î—Ä–æ–±–æ–≤–∏–∫", sniper: "–°–Ω–∞–π–ø–µ—Ä", minigun: "–ü—É–ª–µ–º–µ—Ç", snowball: "–°–Ω–µ–≥–æ–º–µ—Ç", bazooka: "–ë–∞–∑—É–∫–∞", laser: "–õ–∞–∑–µ—Ä", crossbow: "–ê—Ä–±–∞–ª–µ—Ç", plasma: "–ü–ª–∞–∑–º–∞",
                    drone: "–î—Ä–æ–Ω", slime: "–°–ª–∞–π–º", ufo: "–ù–õ–û", wisp: "–û–≥–æ–Ω–µ–∫", turret: "–¢—É—Ä–µ–ª—å"
                }
            }
        };

        // --- GLOBAL VARS ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let currentLang = 'en'; // DEFAULT ENGLISH
        let controlMode = 'PC';
        let gameState = 'PLATFORM_SELECT';
        let currentMission = null;
        let megaEquipMode = false;
        
        // Game State Vars
        let gameTime = 0, enemiesKilled = 0, grenadesKilled = 0, bossSpawned = false, zoneTimer = 0;
        let captureZone = { x: 0, y: 0, radius: 100 };
        let screenShake = 0;
        let player, activePets=[], enemies=[], bullets=[], particles=[], drops=[], obstacles=[], decorations=[], snowflakes=[];
        let keys={}, mouse={x:0,y:0,down:false};
        let joystickLeft={x:0,y:0,active:false,id:null}, joystickRight={x:0,y:0,active:false,id:null}, lastAimAngle=0;

        let playerStats = { coins: 0, color: '#0077FF', xp: 0, level: 1, nextLevelXp: 100, unlockedWeapons: ['pistol'], unlockedOutfits: ['none'], currentOutfit: 'none', redeemedCodes: [], godMode: false, inventory: [], skills: [], unlockedPets: ['none'], currentPet: 'none' };
        let customMap = { walls: [], spawns: [] };
        
        // --- INIT ---
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resize); resize();
        for(let i=0; i<60; i++) snowflakes.push({ x: Math.random()*window.innerWidth, y: Math.random()*window.innerHeight, r: Math.random()*2+0.5, s: Math.random()*1+0.2 });
        
        loadGame();
        applyLanguage(currentLang); // Apply default or loaded language

        // --- LANGUAGE SYSTEM ---
        function setLanguage(lang) {
            currentLang = lang;
            applyLanguage(lang);
            saveGame();
        }

        function applyLanguage(lang) {
            const t = TEXT[lang];
            // Main Titles & Buttons
            document.getElementById('lbl-title-main').innerHTML = t.title + '<br><span style="font-size:18px; color:white;">V16</span>';
            document.getElementById('btn-plat-pc').innerText = t.platPC;
            document.getElementById('btn-plat-mob').innerText = t.platMob;
            
            document.getElementById('lbl-campaign').innerText = t.campaign;
            document.getElementById('btn-training').innerText = t.training;
            document.getElementById('btn-online').innerText = t.online;
            document.getElementById('btn-custom').innerText = t.custom;
            document.getElementById('btn-editor').innerText = t.editor;
            document.getElementById('btn-shop').innerText = t.shop;
            document.getElementById('btn-settings').innerText = t.settings;
            document.getElementById('btn-menu-back').innerText = t.back;
            document.getElementById('exit-mission-btn').innerText = t.exit;
            
            document.getElementById('lbl-settings').innerText = t.settings;
            document.getElementById('btn-close-settings').innerText = t.close;

            // Shop
            document.getElementById('lbl-shop-title').innerText = t.shopTitle;
            document.getElementById('lbl-look').innerText = t.look;
            document.getElementById('lbl-gear').innerText = t.gear;
            document.getElementById('lbl-weapons').innerText = t.weapons;
            document.getElementById('lbl-pets').innerText = t.pets;
            document.getElementById('lbl-inv').innerText = t.inv;
            document.getElementById('btn-shop-exit').innerText = t.exit;
            
            // HUD
            document.getElementById('lbl-lvl').innerText = t.lvl;
            document.getElementById('notif-lvl-title').innerText = t.notifLvl;
            document.getElementById('notif-lvl-desc').innerText = t.notifHp;
            document.getElementById('notif-art-title').innerText = t.notifArt;

            renderMissions(); // Re-render missions with new lang
            renderShopItems(); // Re-render shop item names
        }

        // --- MISSION RENDERING ---
        function renderMissions() {
            const grid = document.getElementById('menu-buttons');
            grid.innerHTML = '';
            
            // Mission Logic Data (Structure same as V15, text removed)
            const missionData = [
                { id: 1, type: 'time', goal: 20 },
                { id: 2, type: 'kill', goal: 5 },
                { id: 3, type: 'boss', goal: 1, boss: true },
                { id: 4, type: 'time', goal: 40 },
                { id: 5, type: 'kill', goal: 50 },
                { id: 6, type: 'time', goal: 60, hard: true },
                { id: 7, type: 'collect', goal: 15 },
                { id: 8, type: 'time', goal: 50, hard: true },
                { id: 9, type: 'zone', goal: 15 },
                { id: 10, type: 'kill', goal: 10, dark: true },
                { id: 11, type: 'kill', goal: 10 },
                { id: 13, type: 'kill', goal: 30 },
                { id: 14, type: 'time', goal: 60, hard: true },
                { id: 15, type: 'boss', goal: 0, boss: true },
                { id: 16, type: 'kill', goal: 15, hard: true },
                { id: 17, type: 'time', goal: 45 },
                { id: 18, type: 'boss', goal: 0, boss: true },
                { id: 19, type: 'kill', goal: 100 },
                { id: 20, type: 'time', goal: 120, hard: true }
            ];

            missionData.forEach(m => {
                let btn = document.createElement('button');
                btn.className = 'btn';
                if(m.boss) btn.classList.add('boss-btn');
                if(m.hard) btn.classList.add('hard-btn');
                
                // Get Text from Dictionary
                let t = TEXT[currentLang].missions[m.id];
                if(t) {
                    btn.innerHTML = `<b>${m.id}. ${t.n}</b><span>${t.d}</span>`;
                    btn.onclick = () => startMission(m);
                }
                grid.appendChild(btn);
            });
        }

        // --- GAME LOGIC ---
        function startMission(mData) {
            currentMission = mData;
            // Handle Custom/Training IDs passed as objects manually if needed
            if(!currentMission.id) currentMission = { id: 'SPECIAL', type: 'special' };

            gameState='PLAYING'; 
            player = new Player(canvas.width/2, canvas.height/2); 
            enemies=[]; bullets=[]; particles=[]; obstacles=[]; drops=[]; decorations=[]; 
            gameTime=0; enemiesKilled=0; grenadesKilled=0; bossSpawned=false; zoneTimer=0; 
            
            // Map Setup
            for(let i=0; i<30; i++) decorations.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, size:Math.random()*20+10});
            if(customMap.walls.length > 0 && currentMission.id === 'CUSTOM') {
                customMap.walls.forEach(w => obstacles.push(new Rect(w.x, w.y, 50)));
            } else if (currentMission.id !== 'TRAINING') {
                 for (let i=0; i<12; i++) { 
                    let s=40+Math.random()*60; let x=50+Math.random()*(canvas.width-s-100); let y=50+Math.random()*(canvas.height-s-100); 
                    if(currentMission.type==='zone' && Math.hypot(x-canvas.width/2, y-canvas.height/2)<150) continue; 
                    if(Math.hypot(x-player.x, y-player.y)>200) obstacles.push(new Rect(x, y, s)); 
                }
            }

            if(currentMission.type === 'zone') { captureZone.x=canvas.width/2; captureZone.y=canvas.height/2; }

            // Pets
            activePets = []; 
            if(megaEquipMode) {
                ['drone', 'slime', 'ufo', 'wisp', 'turret'].forEach((t, i) => activePets.push(new Pet(t, i)));
            } else if(playerStats.currentPet !== 'none') {
                activePets.push(new Pet(playerStats.currentPet));
            }

            document.getElementById('menu-overlay').style.display='none'; 
            document.getElementById('game-ui').style.display='block';
            
            // Set Mission Title in HUD
            let title = "MISSION";
            if(typeof currentMission.id === 'number') title = TEXT[currentLang].missions[currentMission.id].n;
            else if (currentMission.id === 'TRAINING') title = TEXT[currentLang].training;
            document.getElementById('mission-text').innerText = title;

            updateUI();
        }

        function updateGame() {
            if(gameState !== 'PLAYING') return;
            gameTime += 1/60;
            
            // Spawning Logic (Simplified)
            let rate = (currentMission.hard) ? 60 : 120;
            if(Math.floor(gameTime*60) % rate === 0 && currentMission.id !== 'TRAINING') {
                 let s=Math.floor(Math.random()*4), x, y; 
                if(s===0){x=Math.random()*canvas.width;y=-30;} else if(s===1){x=canvas.width+30;y=Math.random()*canvas.height;} else if(s===2){x=Math.random()*canvas.width;y=canvas.height+30;} else{x=-30;y=Math.random()*canvas.height;} 
                
                let type = 'standard';
                if(currentMission.type==='boss' && !bossSpawned && gameTime>2) { type='boss'; bossSpawned=true; }
                enemies.push(new Enemy(x, y, type));
            }

            // Win Condition
            let win = false;
            if(currentMission.type === 'time' && gameTime >= currentMission.goal) win = true;
            if(currentMission.type === 'kill' && enemiesKilled >= currentMission.goal) win = true;
            if(currentMission.type === 'collect' && grenadesKilled >= currentMission.goal) win = true;
            if(currentMission.type === 'zone' && zoneTimer >= currentMission.goal) win = true;
            if(currentMission.type === 'boss' && bossSpawned && !enemies.some(e => e.type === 'boss')) win = true;
            if(win) gameOver(true);

            // Update Stats Text using Language
            let st = TEXT[currentLang];
            if(currentMission.type === 'zone') {
                if(Math.hypot(player.x-captureZone.x, player.y-captureZone.y) < captureZone.radius) zoneTimer += 1/60;
                document.getElementById('stats').innerText = `${st.statZone}: ${zoneTimer.toFixed(1)}/${currentMission.goal}`;
            } else if (currentMission.type === 'kill') {
                document.getElementById('stats').innerText = `${st.statKills}: ${enemiesKilled}/${currentMission.goal}`;
            } else if (currentMission.type === 'collect') {
                document.getElementById('stats').innerText = `${st.statBomb}: ${grenadesKilled}/${currentMission.goal}`;
            } else {
                document.getElementById('stats').innerText = `${st.statTime}: ${gameTime.toFixed(0)}`;
            }

            player.update();
            activePets.forEach(p => p.update());
            enemies.forEach((e, i) => { e.update(); if(e.dead) enemies.splice(i, 1); });
            bullets.forEach((b, i) => { b.update(); if(b.dead) bullets.splice(i, 1); });
            drops.forEach((d, i) => { 
                if(Math.hypot(d.x-player.x, d.y-player.y) < player.radius + 20) {
                    if(d.type==='coin') playerStats.coins+=10;
                    else if(d.type==='medkit') player.hp = Math.min(player.maxHp, player.hp+25);
                    else if(d.type==='artifact') { 
                         playerStats.inventory.push(d.artifactType); 
                         document.getElementById('artifact-notify').style.opacity=1; 
                         setTimeout(()=>document.getElementById('artifact-notify').style.opacity=0,2000);
                    }
                    drops.splice(i, 1);
                    updateUI();
                }
            });
            particles.forEach((p, i) => { p.update(); if(p.life<=0) particles.splice(i, 1); });
            
            // Collisions
            bullets.forEach(b => {
                if(!b.isEnemy) {
                    enemies.forEach(e => {
                        if(!b.dead && Math.hypot(b.x-e.x, b.y-e.y) < e.radius+b.radius) {
                            e.takeDamage(b.dmg); b.dead = true; createParticles(b.x, b.y, 'red');
                        }
                    });
                } else {
                    if(!b.dead && Math.hypot(b.x-player.x, b.y-player.y) < player.radius+b.radius) {
                        player.takeDamage(b.dmg); b.dead = true;
                    }
                }
            });

            if(screenShake > 0) screenShake *= 0.9;
        }

        // --- DRAWING ---
        function drawGame() {
            ctx.clearRect(0,0,canvas.width, canvas.height);
            ctx.save();
            if(screenShake > 0.5) ctx.translate((Math.random()-0.5)*screenShake, (Math.random()-0.5)*screenShake);

            if(currentMission && currentMission.dark) {
                ctx.fillStyle = '#050510'; ctx.fillRect(0,0,canvas.width, canvas.height);
            } else {
                ctx.fillStyle = '#151525'; ctx.fillRect(0,0,canvas.width, canvas.height);
                ctx.fillStyle = 'rgba(255,255,255,0.05)'; decorations.forEach(d => { ctx.beginPath(); ctx.arc(d.x, d.y, d.size, 0, Math.PI*2); ctx.fill(); });
            }

            if(currentMission && currentMission.type === 'zone') {
                ctx.beginPath(); ctx.arc(captureZone.x, captureZone.y, captureZone.radius, 0, Math.PI*2);
                ctx.fillStyle = 'rgba(0,255,100,0.2)'; ctx.fill(); ctx.strokeStyle = '#00FF00'; ctx.lineWidth=2; ctx.stroke();
            }

            obstacles.forEach(o => o.draw());
            drops.forEach(d => d.draw());
            enemies.forEach(e => e.draw());
            bullets.forEach(b => b.draw());
            if(player && !player.dead) player.draw();
            activePets.forEach(p => p.draw());
            particles.forEach(p => p.draw());

            // Darkness overlay
            if(currentMission && currentMission.dark) {
                ctx.setTransform(1,0,0,1,0,0);
                let g = ctx.createRadialGradient(player.x, player.y, 60, player.x, player.y, 300);
                g.addColorStop(0, 'rgba(0,0,0,0)');
                g.addColorStop(1, 'rgba(0,0,0,0.95)');
                ctx.fillStyle = g; ctx.fillRect(0,0,canvas.width, canvas.height);
            }

            ctx.fillStyle = 'rgba(255,255,255,0.5)';
            snowflakes.forEach(s => { s.y+=s.s; if(s.y>canvas.height) s.y=-10; ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI*2); ctx.fill(); });

            ctx.restore();
        }

        // --- ENTITY CLASSES (Simplified) ---
        class Rect { constructor(x,y,s){this.x=x;this.y=y;this.size=s;} draw(){ctx.fillStyle='#445';ctx.fillRect(this.x,this.y,this.size,this.size); ctx.strokeStyle='#223'; ctx.strokeRect(this.x,this.y,this.size,this.size);} }
        class Player { 
            constructor(x,y){
                this.x=x;this.y=y;this.hp=100;this.maxHp=100;this.radius=15;this.angle=0;this.weapon='pistol';
                if(megaEquipMode) this.maxHp=880; else if(playerStats.currentOutfit==='vest') this.maxHp=200;
                this.hp=this.maxHp;
            }
            update() {
                let spd = 4; let dx=0, dy=0;
                if(controlMode==='PC'){ if(keys['KeyW']) dy=-spd; if(keys['KeyS']) dy=spd; if(keys['KeyA']) dx=-spd; if(keys['KeyD']) dx=spd; this.angle = Math.atan2(mouse.y-this.y, mouse.x-this.x); if(mouse.down) this.shoot(); } 
                else { if(joystickLeft.active) { dx=joystickLeft.x*spd; dy=joystickLeft.y*spd; } if(joystickRight.active) { this.angle=Math.atan2(joystickRight.y, joystickRight.x); this.shoot(); } else if(dx||dy) this.angle=Math.atan2(dy,dx); }
                if(!this.checkCol(this.x+dx, this.y)) this.x+=dx; if(!this.checkCol(this.x, this.y+dy)) this.y+=dy;
                this.x=Math.max(15,Math.min(canvas.width-15,this.x)); this.y=Math.max(15,Math.min(canvas.height-15,this.y));
            }
            checkCol(x,y){ for(let o of obstacles) if(x>o.x && x<o.x+o.size && y>o.y && y<o.y+o.size) return true; return false; }
            shoot() { if(this.cooldown>0) {this.cooldown--; return;} this.cooldown=10; bullets.push(new Bullet(this.x, this.y, {x:Math.cos(this.angle)*15,y:Math.sin(this.angle)*15}, false, 25)); }
            takeDamage(amt){ if(playerStats.godMode) return; this.hp-=amt; screenShake=5; if(this.hp<=0) gameOver(false); updateUI(); }
            draw() { 
                ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.angle);
                ctx.fillStyle=playerStats.color; ctx.beginPath(); ctx.arc(0,0,15,0,Math.PI*2); ctx.fill(); 
                ctx.fillStyle='#000'; ctx.fillRect(10,-3,15,6); 
                if(megaEquipMode || playerStats.currentOutfit === 'crown') { ctx.fillStyle='gold'; ctx.beginPath(); ctx.moveTo(-10,-10); ctx.lineTo(0,-20); ctx.lineTo(10,-10); ctx.fill(); }
                ctx.restore();
            }
        }
        class Enemy {
            constructor(x,y,type){this.x=x;this.y=y;this.type=type;this.hp=40;this.radius=15;this.speed=1.5; if(type==='boss'){this.hp=500;this.radius=35;}}
            update(){ let a = Math.atan2(player.y-this.y, player.x-this.x); let d = Math.hypot(player.x-this.x, player.y-this.y); if(d > this.radius + 15) { this.x+=Math.cos(a)*this.speed; this.y+=Math.sin(a)*this.speed; } }
            draw(){ ctx.save(); ctx.translate(this.x, this.y); ctx.fillStyle = this.type==='boss'?'purple':'red'; ctx.beginPath(); ctx.arc(0,0,this.radius,0,Math.PI*2); ctx.fill(); ctx.restore(); }
            takeDamage(d){ this.hp-=d; if(this.hp<=0) { this.dead=true; enemiesKilled++; addXp(10); if(Math.random()<0.3) drops.push({x:this.x, y:this.y, type:'coin'}); } }
        }
        class Bullet { constructor(x,y,vel,isEnemy,dmg){this.x=x;this.y=y;this.vel=vel;this.isEnemy=isEnemy;this.dmg=dmg;this.radius=4;} update(){this.x+=this.vel.x;this.y+=this.vel.y; if(this.x<0||this.x>canvas.width)this.dead=true;} draw(){ctx.fillStyle=this.isEnemy?'orange':'yellow';ctx.beginPath();ctx.arc(this.x,this.y,this.radius,0,Math.PI*2);ctx.fill();} }
        class Particle { constructor(x,y,c){this.x=x;this.y=y;this.c=c;this.vx=(Math.random()-0.5)*5;this.vy=(Math.random()-0.5)*5;this.life=20;} update(){this.x+=this.vx;this.y+=this.vy;this.life--;} draw(){ctx.globalAlpha=this.life/20;ctx.fillStyle=this.c;ctx.fillRect(this.x,this.y,3,3);ctx.globalAlpha=1;} }
        class Pet { constructor(t,i){this.type=t;this.x=player.x;this.y=player.y;this.off=i*10;} update(){this.x+=(player.x-this.x)*0.05; this.y+=(player.y-this.y)*0.05;} draw(){ctx.fillStyle='cyan';ctx.beginPath();ctx.arc(this.x+this.off,this.y-20,5,0,Math.PI*2);ctx.fill();} }
        class DropItem { constructor(x,y,t,at){this.x=x;this.y=y;this.type=t;this.artifactType=at||'rusty_gear';} draw(){ctx.fillStyle=this.type==='coin'?'gold':'lime';ctx.beginPath();ctx.arc(this.x,this.y,10,0,Math.PI*2);ctx.fill();} }

        // --- SHOP & UI HELPERS ---
        function renderShopItems() {
            const accList = document.getElementById('accessories-list');
            accList.innerHTML = '';
            // Example of dynamic translation in shop
            const outfits = ['none', 'santa_hat', 'helmet', 'vest', 'crown'];
            outfits.forEach(id => {
                let div = document.createElement('div');
                div.className = 'shop-item';
                let name = TEXT[currentLang].items[id] || id;
                div.innerHTML = `<span>${name}</span>`;
                accList.appendChild(div);
            });
            // (Full shop implementation would go here similarly using TEXT[currentLang].items)
        }
        
        function openSettings() { document.getElementById('settings-screen').style.display = 'flex'; }
        function closeSettings() { document.getElementById('settings-screen').style.display = 'none'; }
        function openShop() { document.getElementById('shop-screen').style.display = 'flex'; renderShopItems(); }
        function closeShop() { document.getElementById('shop-screen').style.display = 'none'; }
        
        function createParticles(x,y,c){for(let i=0;i<5;i++)particles.push(new Particle(x,y,c));}
        function addXp(amt){playerStats.xp+=amt; if(playerStats.xp>=playerStats.nextLevelXp){playerStats.level++; playerStats.xp=0; player.hp=player.maxHp; document.getElementById('levelup-notify').style.opacity=1; setTimeout(()=>document.getElementById('levelup-notify').style.opacity=0,2000);} updateUI();}
        function gameOver(win){ 
            gameState='GAMEOVER'; 
            let msg = win ? TEXT[currentLang].win : TEXT[currentLang].loss;
            alert(msg); 
            showMainMenu(); 
        }
        function showMainMenu(){ gameState='MENU'; document.getElementById('menu-overlay').style.display='flex'; document.getElementById('game-ui').style.display='none'; }
        function startTraining() { startMission({id:'TRAINING', type:'special'}); }
        function loadGame(){ try{let d=JSON.parse(localStorage.getItem('winterOps_v16')); if(d) { playerStats={...playerStats,...d.stats}; if(d.lang) currentLang = d.lang; } }catch(e){} }
        function saveGame(){ localStorage.setItem('winterOps_v16', JSON.stringify({stats: playerStats, lang: currentLang})); }
        function updateUI(){ 
            if(gameState==='PLAYING'){ 
                document.getElementById('health-fill').style.width=(player.hp/player.maxHp)*100+'%'; 
                document.getElementById('xp-fill').style.width=(playerStats.xp/playerStats.nextLevelXp)*100+'%'; 
                document.getElementById('coin-counter').innerText='$ '+playerStats.coins; 
                // Translate Weapon Name
                let wName = TEXT[currentLang].items[player.weapon] || player.weapon;
                document.getElementById('weapon-info').innerText = wName.toUpperCase();
            } 
        }
        function redeemCode() {
            let c = document.getElementById('promo-input').value.trim().toUpperCase();
            if(c === '2KFNWKC') { megaEquipMode = true; alert("MEGA MODE: ACTIVATED!"); return; }
        }
        function selectPlatform(m) { controlMode = m; document.getElementById('platform-screen').style.display='none'; showMainMenu(); }

        // --- INPUT ---
        window.addEventListener('keydown',e=>keys[e.code]=true); window.addEventListener('keyup',e=>keys[e.code]=false);
        window.addEventListener('mousemove',e=>{mouse.x=e.clientX;mouse.y=e.clientY});
        window.addEventListener('mousedown',()=>mouse.down=true); window.addEventListener('mouseup',()=>mouse.down=false);
        
        function loop() { requestAnimationFrame(loop); if(gameState==='PLAYING') { updateGame(); drawGame(); } }
        loop();
    </script>
</body>
</html>
