<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ULTIMATE STRIKE 3D</title>
    <style>
        /* === 1. –û–°–ù–û–í–ù–û–ô –°–¢–ò–õ–¨ (AAA UI) === */
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@400;700&display=swap');
        
        body { margin: 0; overflow: hidden; background: #050505; font-family: 'Roboto', sans-serif; user-select: none; color: white; }
        
        /* –°—Ç–µ–∫–ª—è–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        .glass-panel {
            background: rgba(20, 30, 50, 0.7);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            border-radius: 16px;
        }

        /* –≠–∫—Ä–∞–Ω—ã */
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; z-index: 10; }
        .active { display: flex; }

        /* –ú–ï–ù–Æ */
        #menu-screen { 
            background: radial-gradient(circle at center, #1b2838 0%, #000 100%); 
            align-items: center; justify-content: center; 
        }
        
        /* –í–µ—Ä—Ö–Ω–∏–π –±–∞—Ä (–ü—Ä–æ—Ñ–∏–ª—å) */
        .top-bar { 
            position: absolute; top: 0; width: 100%; height: 70px; 
            display: flex; justify-content: space-between; align-items: center; padding: 0 20px; box-sizing: border-box; 
            background: linear-gradient(180deg, rgba(0,0,0,0.8), transparent);
        }
        .user-card { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .avatar { width: 45px; height: 45px; border-radius: 50%; border: 2px solid #00ccff; background: #333; overflow: hidden; display:flex; align-items:center; justify-content:center; font-size:20px;}
        .money-tag { background: rgba(0, 255, 100, 0.2); color: #0f0; padding: 5px 12px; border-radius: 8px; font-weight: bold; font-family: 'Orbitron'; }

        /* –ì–ª–∞–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ */
        .main-menu-box { width: 300px; display: flex; flex-direction: column; gap: 15px; }
        .btn {
            background: linear-gradient(90deg, #ff9d00, #ff5e00);
            border: none; padding: 18px; color: white; font-family: 'Orbitron'; font-size: 18px; 
            text-transform: uppercase; clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
            cursor: pointer; transition: 0.2s; letter-spacing: 2px; text-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        .btn:active { transform: scale(0.95); }
        .btn-blue { background: linear-gradient(90deg, #00c6ff, #0072ff); }
        .btn-dark { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); }

        /* –ú–ê–ì–ê–ó–ò–ù */
        .shop-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 20px; overflow-y: auto; height: 60%; }
        .shop-item { 
            display: flex; flex-direction: column; align-items: center; padding: 15px; 
            border: 1px solid transparent; cursor: pointer; transition: 0.2s;
        }
        .shop-item:hover { background: rgba(255,255,255,0.05); }
        .shop-item.owned { border-color: #00ff00; }
        .shop-item.selected { border-color: #ff9d00; background: rgba(255, 157, 0, 0.1); box-shadow: 0 0 15px rgba(255,157,0,0.2); }

        /* –ò–ì–†–û–í–û–ô HUD */
        #game-ui { pointer-events: none; }
        #crosshair { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            width: 20px; height: 20px; transition: transform 0.1s;
        }
        #crosshair::before, #crosshair::after { content:''; position: absolute; background: #0f0; box-shadow: 0 0 4px #000; }
        #crosshair::before { width: 2px; height: 20px; left: 9px; top: 0; }
        #crosshair::after { width: 20px; height: 2px; top: 9px; left: 0; }

        #kill-feed { position: absolute; top: 80px; right: 20px; display: flex; flex-direction: column; gap: 5px; align-items: flex-end; }
        .kill-msg { 
            background: linear-gradient(90deg, transparent, rgba(0,0,0,0.8)); 
            padding: 5px 15px; border-radius: 5px; font-size: 14px; animation: fadeOut 4s forwards; border-right: 3px solid #f00;
        }
        @keyframes fadeOut { 0% {opacity:1; transform: translateX(0);} 90% {opacity:1;} 100% {opacity:0; transform: translateX(20px);} }

        /* –ú–û–ë–ò–õ–¨–ù–û–ï –£–ü–†–ê–í–õ–ï–ù–ò–ï (–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ–µ) */
        .touch-control { 
            position: absolute; pointer-events: auto; touch-action: none; 
            display: none; justify-content: center; align-items: center;
        }
        .touch-btn { 
            width: 70px; height: 70px; border-radius: 50%; background: rgba(255,255,255,0.1); 
            border: 2px solid rgba(255,255,255,0.3); backdrop-filter: blur(4px);
        }
        .touch-btn:active { background: rgba(255,255,255,0.3); }
        
        #stick-zone { bottom: 50px; left: 50px; width: 140px; height: 140px; border-radius: 50%; background: rgba(255,255,255,0.05); }
        #stick-knob { width: 50px; height: 50px; background: rgba(255,255,255,0.5); border-radius: 50%; position: absolute; top: 45px; left: 45px; pointer-events: none; }
        
        /* –†–µ–∂–∏–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–Ω–æ–ø–æ–∫ */
        .edit-mode .touch-control { border: 2px dashed #0f0; background: rgba(0,255,0,0.1); }
    </style>
</head>
<body>

    <div id="menu-screen" class="screen active">
        <div class="top-bar">
            <div class="user-card" onclick="toggleEditName()">
                <div class="avatar" id="my-avatar">üë§</div>
                <div>
                    <div style="font-size: 12px; color: #aaa;">–ù–ò–ö–ù–ï–ô–ú</div>
                    <input type="text" id="nick-input" value="Player 1" style="background:transparent; border:none; color:white; font-weight:bold; font-size:16px; width: 100px;">
                </div>
            </div>
            <div class="money-tag">üíµ <span id="money-display">0</span></div>
        </div>

        <h1 style="font-family: 'Orbitron'; font-size: 50px; color: #00ccff; text-shadow: 0 0 30px #00ccff; margin-bottom: 40px;">POLY<span style="color:white">WAR</span></h1>

        <div class="main-menu-box">
            <button class="btn" onclick="openLobby()">‚öîÔ∏è –ò–ì–†–ê–¢–¨</button>
            <button class="btn btn-dark" onclick="openShop()">üõí –ú–ê–ì–ê–ó–ò–ù</button>
            <button class="btn btn-dark" onclick="toggleSettings()">‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò HUD</button>
        </div>
        
        <div id="settings-panel" class="glass-panel" style="display:none; padding:20px; margin-top:10px;">
            <p>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞:</p>
            <button class="btn btn-blue" onclick="toggleEditMode()" style="font-size:14px; padding:10px;">üñê –î–≤–∏–≥–∞—Ç—å –∫–Ω–æ–ø–∫–∏</button>
            <input type="range" min="1" max="10" value="5" onchange="updateSens(this.value)" style="width:100%; margin-top:10px;">
            <div style="font-size:12px; text-align:center;">–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</div>
        </div>
    </div>

    <div id="shop-screen" class="screen glass-panel" style="margin: 20px; width: calc(100% - 40px); height: calc(100% - 40px); z-index: 15;">
        <h2 style="text-align: center; font-family: 'Orbitron';">–ê–†–°–ï–ù–ê–õ</h2>
        <div class="shop-grid" id="shop-container">
            </div>
        <button class="btn btn-dark" style="position: absolute; bottom: 20px; width: 90%; left: 5%;" onclick="closeShop()">–ù–ê–ó–ê–î</button>
    </div>

    <div id="lobby-screen" class="screen" style="background:rgba(0,0,0,0.9); z-index: 20; justify-content: center; align-items: center;">
        <div class="glass-panel" style="padding: 40px; text-align: center;">
            <h2 style="color: #ff9d00;">–ú–£–õ–¨–¢–ò–ü–õ–ï–ï–†</h2>
            <button class="btn btn-blue" onclick="startHost()">–°–û–ó–î–ê–¢–¨ –ò–ì–†–£</button>
            <p style="color:#aaa">- –∏–ª–∏ -</p>
            <input type="text" id="join-id" placeholder="–í–≤–µ–¥–∏ ID –î—Ä—É–≥–∞" style="padding: 10px; border-radius: 5px; border: none; text-align: center; font-size: 16px;">
            <button class="btn" onclick="startJoin()" style="margin-top: 10px;">–ü–û–î–ö–õ–Æ–ß–ò–¢–¨–°–Ø</button>
            <div id="connection-log" style="margin-top: 20px; color: yellow; font-size: 12px; max-width: 300px; word-wrap: break-word;"></div>
            <button class="btn btn-dark" onclick="location.reload()" style="margin-top: 20px; padding: 10px;">‚ùå –û–¢–ú–ï–ù–ê</button>
        </div>
    </div>

    <div id="game-ui" class="screen">
        <div class="top-bar" style="background: none; pointer-events: none;">
            <div style="background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 20px;">
                <span id="score-my">0</span> : <span id="score-enemy">0</span>
            </div>
            <div id="ping-meter" style="color: #0f0; font-size: 12px;">PING: 20ms</div>
        </div>

        <div id="kill-feed"></div>
        <div id="crosshair"></div>

        <div id="controls-layer">
            <div id="stick-zone" class="touch-control"><div id="stick-knob"></div></div>
            <div id="btn-fire" class="touch-control touch-btn" style="bottom: 80px; right: 50px; background: rgba(255,0,0,0.3);">üî•</div>
            <div id="btn-jump" class="touch-control touch-btn" style="bottom: 180px; right: 30px; width: 50px; height: 50px;">‚¨ÜÔ∏è</div>
            <div id="btn-reload" class="touch-control touch-btn" style="bottom: 50px; right: 140px; width: 50px; height: 50px;">R</div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <script>
        /* === –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò === */
        const GAME = {
            money: parseInt(localStorage.getItem('pw_money')) || 1000,
            skin: localStorage.getItem('pw_skin') || 'soldier',
            nick: localStorage.getItem('pw_nick') || 'Soldier',
            sens: 0.003,
            isMobile: /Android|iPhone|iPad/i.test(navigator.userAgent),
            state: 'menu' // menu, lobby, game
        };

        const SKINS = [
            { id: 'soldier', name: '–†–µ–∫—Ä—É—Ç', color: 0x556655, price: 0 },
            { id: 'specops', name: '–°–ø–µ—Ü–Ω–∞–∑', color: 0x0044ff, price: 500 },
            { id: 'golden', name: '–ó–æ–ª–æ—Ç–æ–π', color: 0xffd700, price: 2000 },
            { id: 'neon', name: '–ö–∏–±–µ—Ä', color: 0x00ffcc, price: 1500 }
        ];

        /* === 1. –õ–û–ì–ò–ö–ê –ò–ù–¢–ï–†–§–ï–ô–°–ê === */
        const UI = {
            updateHeader: () => {
                document.getElementById('money-display').innerText = GAME.money;
                document.getElementById('nick-input').value = GAME.nick;
                const s = SKINS.find(x => x.id === GAME.skin);
                document.getElementById('my-avatar').style.background = '#' + s.color.toString(16);
            },
            initShop: () => {
                const con = document.getElementById('shop-container');
                con.innerHTML = '';
                SKINS.forEach(skin => {
                    const el = document.createElement('div');
                    const owned = GAME.money >= skin.price || skin.price === 0; // —É–ø—Ä–æ—â–µ–Ω–∏–µ: –∫—É–ø–ª–µ–Ω–æ –µ—Å–ª–∏ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥ (–¥–ª—è –¥–µ–º–æ)
                    el.className = `shop-item ${GAME.skin === skin.id ? 'selected' : ''}`;
                    el.innerHTML = `
                        <div style="width:50px; height:50px; background:#${skin.color.toString(16)}; margin-bottom:10px;"></div>
                        <b>${skin.name}</b>
                        <span style="color:${owned ? '#0f0' : '#fff'}">${skin.price === 0 ? 'FREE' : skin.price + '$'}</span>
                    `;
                    el.onclick = () => {
                        GAME.skin = skin.id;
                        localStorage.setItem('pw_skin', skin.id);
                        UI.initShop();
                        UI.updateHeader();
                    };
                    con.appendChild(el);
                });
            }
        };

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∏–∫–∞
        document.getElementById('nick-input').addEventListener('input', (e) => {
            GAME.nick = e.target.value;
            localStorage.setItem('pw_nick', GAME.nick);
        });

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è
        function openShop() { document.getElementById('shop-screen').classList.add('active'); UI.initShop(); }
        function closeShop() { document.getElementById('shop-screen').classList.remove('active'); }
        function openLobby() { document.getElementById('menu-screen').classList.remove('active'); document.getElementById('lobby-screen').classList.add('active'); }
        function toggleSettings() { 
            const p = document.getElementById('settings-panel');
            p.style.display = p.style.display==='none' ? 'block' : 'none';
        }
        function updateSens(val) { GAME.sens = val / 1000; }

        /* === 2. –°–ò–°–¢–ï–ú–ê –î–†–ê–ì-–ù-–î–†–û–ü –ö–ù–û–ü–û–ö === */
        let isEditMode = false;
        function toggleEditMode() {
            isEditMode = !isEditMode;
            document.getElementById('game-ui').style.display = 'block'; // –ü–æ–∫–∞–∑–∞—Ç—å HUD –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            document.body.classList.toggle('edit-mode');
            
            if(isEditMode) {
                // –í–∫–ª—é—á–∞–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
                document.querySelectorAll('.touch-control').forEach(el => {
                    el.style.display = 'flex';
                    let offsetX, offsetY;
                    el.ontouchstart = (e) => {
                        const t = e.touches[0];
                        const rect = el.getBoundingClientRect();
                        offsetX = t.clientX - rect.left;
                        offsetY = t.clientY - rect.top;
                    }
                    el.ontouchmove = (e) => {
                        e.preventDefault();
                        const t = e.touches[0];
                        el.style.left = (t.clientX - offsetX) + 'px';
                        el.style.top = (t.clientY - offsetY) + 'px';
                        el.style.bottom = 'auto'; el.style.right = 'auto'; // –°–±—Ä–æ—Å —è–∫–æ—Ä–µ–π
                    }
                });
            } else {
                document.getElementById('game-ui').style.display = 'none'; // –°–∫—Ä—ã—Ç—å
                // –¢—É—Ç –º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ localStorage
            }
        }

        /* === 3. –ò–ì–†–û–í–û–ô –î–í–ò–ñ–û–ö (THREE.JS) === */
        let scene, camera, renderer, clock;
        let myMesh, enemyMesh;
        let bullets = [], worldObjects = [];
        let peer, conn;
        let input = { x:0, y:0, jump:false, fire:false };
        
        // –ó–≤—É–∫–∏ (–°–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä)
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function sfx(type) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            
            const t = audioCtx.currentTime;
            if(type==='shoot') {
                o.type='sawtooth'; o.frequency.setValueAtTime(400, t); o.frequency.exponentialRampToValueAtTime(50, t+0.1);
                g.gain.setValueAtTime(0.2, t); g.gain.exponentialRampToValueAtTime(0.01, t+0.1);
                o.start(); o.stop(t+0.1);
            } else if(type==='hit') {
                o.type='sine'; o.frequency.setValueAtTime(800, t);
                g.gain.setValueAtTime(0.3, t); g.gain.linearRampToValueAtTime(0, t+0.1);
                o.start(); o.stop(t+0.1);
            }
        }

        function initGame() {
            // –°–∫—Ä—ã—Ç—å –≤—Å–µ UI, –ø–æ–∫–∞–∑–∞—Ç—å –∏–≥—Ä—É
            document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
            document.getElementById('game-ui').classList.add('active');
            if(GAME.isMobile) document.querySelectorAll('.touch-control').forEach(e=>e.style.display='flex');

            // –°—Ü–µ–Ω–∞
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0b1015);
            scene.fog = new THREE.Fog(0x0b1015, 0, 50);

            camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 100);
            renderer = new THREE.WebGLRenderer({antialias:true});
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            clock = new THREE.Clock();

            // –°–≤–µ—Ç
            const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 0.8);
            scene.add(hemi);
            const dir = new THREE.DirectionalLight(0xffffff, 0.5);
            dir.position.set(10,20,10); scene.add(dir);

            // –ú–∏—Ä
            createLevel();

            // –ú–æ–π –∏–≥—Ä–æ–∫ (–∫–∞–º–µ—Ä–∞)
            camera.position.set(0, 1.6, 5);
            createWeapon();

            // –í—Ä–∞–≥ (–º–æ–¥–µ–ª—å)
            enemyMesh = createPlayerModel(0xff0000);
            scene.add(enemyMesh);
            enemyMesh.position.y = -100; // –°–ø—Ä—è—Ç–∞—Ç—å

            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            setupControls();

            animate();
        }

        function createLevel() {
            // –ü–æ–ª
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(100,100), new THREE.MeshPhongMaterial({color:0x222222, depthWrite:false}));
            floor.rotation.x = -Math.PI/2;
            scene.add(floor);
            
            // –°–µ—Ç–∫–∞
            scene.add(new THREE.GridHelper(100, 50, 0x333333, 0x111111));

            // –°—Ç–µ–Ω—ã
            const wallMat = new THREE.MeshPhongMaterial({color:0x444455});
            const boxes = [
                {x:5,z:5,w:4,h:2}, {x:-5,z:-5,w:4,h:2}, {x:0,z:-10,w:10,h:4}, {x:10,z:0,w:2,h:3}
            ];
            boxes.forEach(b => {
                const mesh = new THREE.Mesh(new THREE.BoxGeometry(b.w, b.h*2, b.w), wallMat);
                mesh.position.set(b.x, b.h, b.z);
                scene.add(mesh);
                worldObjects.push(new THREE.Box3().setFromObject(mesh));
            });
        }

        function createPlayerModel(color) {
            const g = new THREE.Group();
            const mat = new THREE.MeshPhongMaterial({color: color});
            // –¢–µ–ª–æ
            const body = new THREE.Mesh(new THREE.BoxGeometry(0.6, 0.8, 0.4), mat); body.position.y=0.9; g.add(body);
            // –ì–æ–ª–æ–≤–∞
            const head = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.4, 0.4), new THREE.MeshPhongMaterial({color:0xffccaa})); head.position.y=1.6; g.add(head);
            // –†—É–∫–∏
            const arm = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.8, 0.2), mat); arm.position.set(0.4, 0.9, 0); g.add(arm);
            const arm2 = arm.clone(); arm2.position.set(-0.4, 0.9, 0); g.add(arm2);
            return g;
        }

        function createWeapon() {
            const gun = new THREE.Group();
            const mat = new THREE.MeshPhongMaterial({color:0x111});
            const body = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.15, 0.6), mat);
            body.position.set(0.2, -0.2, -0.4);
            gun.add(body);
            camera.add(gun);
            scene.add(camera);
        }

        /* === 4. –°–ï–¢–ï–í–û–ô –ö–û–î (P2P) === */
        function startHost() {
            peer = new Peer();
            peer.on('open', id => {
                document.getElementById('connection-log').innerHTML = `–ö–û–î –ö–û–ú–ù–ê–¢–´:<br><b style="font-size:20px; color:#fff; user-select:text;">${id}</b><br>(—Å–∫–∏–Ω—å –¥—Ä—É–≥—É)`;
            });
            peer.on('connection', c => {
                conn = c;
                setupConnection();
            });
        }

        function startJoin() {
            const id = document.getElementById('join-id').value;
            if(!id) return alert("–í–≤–µ–¥–∏ ID!");
            peer = new Peer();
            peer.on('open', () => {
                conn = peer.connect(id);
                setupConnection();
            });
        }

        function setupConnection() {
            document.getElementById('connection-log').innerText = "–°–û–ï–î–ò–ù–ï–ù–ò–ï... –ó–ê–ü–£–°–ö";
            
            conn.on('open', () => {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∫–∏–Ω –∏ –Ω–∏–∫
                conn.send({type:'init', skin: GAME.skin, nick: GAME.nick});
                setTimeout(initGame, 1000);
            });

            conn.on('data', d => {
                if(d.type==='init') {
                    // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–∫–∏–Ω –≤—Ä–∞–≥–∞
                    const s = SKINS.find(x=>x.id===d.skin) || SKINS[0];
                    enemyMesh.children.forEach(c => { if(c.geometry.type==='BoxGeometry' && c.position.y < 1.5) c.material.color.setHex(s.color); });
                    document.getElementById('score-enemy').innerText = d.nick; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–∞–±–ª–æ —Å—á–µ—Ç–∞ –¥–ª—è –Ω–∏–∫–∞ –ø–æ–∫–∞
                }
                if(d.type==='move') {
                    enemyMesh.position.set(d.x, d.y, d.z);
                    enemyMesh.rotation.y = d.ry;
                }
                if(d.type==='shoot') {
                    sfx('shoot');
                    // –í–∏–∑—É–∞–ª –≤—ã—Å—Ç—Ä–µ–ª–∞ –≤—Ä–∞–≥–∞ (—É–ø—Ä–æ—â–µ–Ω–æ)
                }
                if(d.type==='hit') {
                    // –ú–µ–Ω—è —É–±–∏–ª–∏
                    document.body.style.boxShadow = "inset 0 0 50px red";
                    setTimeout(()=>document.body.style.boxShadow="none", 200);
                }
            });
        }

        /* === 5. –ò–ì–†–û–í–û–ô –¶–ò–ö–õ === */
        let velocity = new THREE.Vector3();
        
        function animate() {
            requestAnimationFrame(animate);
            const dt = clock.getDelta();

            // –§–∏–∑–∏–∫–∞
            velocity.y -= 20 * dt; // –ì—Ä–∞–≤–∏—Ç–∞—Ü–∏—è
            
            const speed = 8;
            const dir = new THREE.Vector3();
            const fwd = new THREE.Vector3(0,0,-1).applyEuler(new THREE.Euler(0, camera.rotation.y, 0));
            const right = new THREE.Vector3(1,0,0).applyEuler(new THREE.Euler(0, camera.rotation.y, 0));

            if(input.y < 0) dir.add(fwd); if(input.y > 0) dir.sub(fwd);
            if(input.x < 0) dir.sub(right); if(input.x > 0) dir.add(right);
            
            // –ü–ª–∞–≤–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã –æ—Ä—É–∂–∏—è
            if(dir.length()>0) {
                const t = Date.now() * 0.01;
                camera.children[0].position.y = -0.2 + Math.sin(t)*0.01;
                camera.children[0].position.x = 0.2 + Math.cos(t*0.5)*0.01;
            }

            camera.position.add(dir.normalize().multiplyScalar(speed * dt));
            
            // –ü–æ–ª
            if(camera.position.y < 1.6) { camera.position.y=1.6; velocity.y=0; }
            
            // –°—Ç—Ä–µ–ª—å–±–∞
            if(input.fire) {
                input.fire = false;
                shoot();
            }

            // –°–µ—Ç—å: –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–∑–∏—Ü–∏–∏
            if(conn && conn.open) {
                conn.send({type:'move', x:camera.position.x, y:camera.position.y-1.6, z:camera.position.z, ry:camera.rotation.y});
            }

            renderer.render(scene, camera);
        }

        function shoot() {
            sfx('shoot');
            // –ê–Ω–∏–º–∞—Ü–∏—è –æ—Ä—É–∂–∏—è
            camera.children[0].position.z = 0.2; 
            setTimeout(()=>camera.children[0].position.z = -0.4, 100);

            // Raycast
            const ray = new THREE.Raycaster();
            ray.setFromCamera(new THREE.Vector2(0,0), camera);
            const hits = ray.intersectObject(enemyMesh, true);
            
            if(hits.length > 0) {
                sfx('hit');
                conn.send({type:'hit'});
                // –•–∏—Ç–º–∞—Ä–∫–µ—Ä
                const ch = document.getElementById('crosshair');
                ch.style.transform = 'translate(-50%, -50%) rotate(45deg) scale(1.5)';
                setTimeout(()=>ch.style.transform = 'translate(-50%, -50%) rotate(0deg) scale(1)', 100);
            }
            conn.send({type:'shoot'});
        }

        /* === 6. –£–ü–†–ê–í–õ–ï–ù–ò–ï === */
        function setupControls() {
            if(GAME.isMobile) {
                // –î–∂–æ–π—Å—Ç–∏–∫
                const stick = document.getElementById('stick-zone');
                const knob = document.getElementById('stick-knob');
                let startT;
                stick.addEventListener('touchstart', e => startT = e.changedTouches[0]);
                stick.addEventListener('touchmove', e => {
                    e.preventDefault();
                    const t = e.changedTouches[0];
                    let dx = t.clientX - startT.clientX;
                    let dy = t.clientY - startT.clientY;
                    // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫—Ä—É–≥–∞
                    const dist = Math.sqrt(dx*dx+dy*dy);
                    if(dist>40) { dx=(dx/dist)*40; dy=(dy/dist)*40; }
                    knob.style.transform = `translate(${dx}px, ${dy}px)`;
                    input.x = dx/40; input.y = dy/40;
                });
                stick.addEventListener('touchend', ()=>{ knob.style.transform=''; input.x=0; input.y=0; });

                // –ö–Ω–æ–ø–∫–∏
                document.getElementById('btn-fire').addEventListener('touchstart', (e)=>{e.preventDefault(); input.fire=true;});
                
                // –í—Ä–∞—â–µ–Ω–∏–µ –∫–∞–º–µ—Ä–æ–π (–ø—Ä–∞–≤–∞—è —á–∞—Å—Ç—å —ç–∫—Ä–∞–Ω–∞)
                let lastX, lastY;
                document.addEventListener('touchstart', e=>{ 
                    const t=e.touches[0]; if(t.clientX > window.innerWidth/2) { lastX=t.clientX; lastY=t.clientY; }
                });
                document.addEventListener('touchmove', e=>{
                    const t=e.touches[0]; 
                    if(t.clientX > window.innerWidth/2 && e.target.id !== 'btn-fire') {
                        const dx = t.clientX - lastX;
                        const dy = t.clientY - lastY;
                        camera.rotation.y -= dx * GAME.sens;
                        camera.rotation.x -= dy * GAME.sens;
                        lastX=t.clientX; lastY=t.clientY;
                    }
                });

            } else {
                // –ü–ö
                document.body.onclick = () => document.body.requestPointerLock();
                document.addEventListener('mousemove', e => {
                    if(document.pointerLockElement) {
                        camera.rotation.y -= e.movementX * 0.002;
                        camera.rotation.x -= e.movementY * 0.002;
                    }
                });
                document.addEventListener('mousedown', () => input.fire=true);
                document.addEventListener('keydown', e => {
                    if(e.code==='KeyW') input.y=-1; if(e.code==='KeyS') input.y=1;
                    if(e.code==='KeyA') input.x=-1; if(e.code==='KeyD') input.x=1;
                });
                document.addEventListener('keyup', e => {
                    if(['KeyW','KeyS'].includes(e.code)) input.y=0;
                    if(['KeyA','KeyD'].includes(e.code)) input.x=0;
                });
            }
        }
        
        // –ó–∞–ø—É—Å–∫ UI
        UI.updateHeader();

    </script>
</body>
</html>
