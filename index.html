<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tactical Shooter: MEGA MODE</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body {
            margin: 0; overflow: hidden; background-color: #1a1a2e;
            font-family: 'Courier New', Courier, monospace;
            color: white; user-select: none; -webkit-user-select: none; touch-action: none;
        }
        canvas { display: block; }
        
        /* UI CLASSES */
        .btn {
            background: #222; color: white; border: 2px solid #0077FF; padding: 10px;
            font-size: 14px; cursor: pointer; text-align: center; font-family: inherit; margin: 2px;
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            transition: transform 0.1s; min-height: 50px;
        }
        .btn:hover { background: #0077FF; color: black; transform: scale(1.02); }
        .btn span.desc { font-size: 10px; color: #ccc; margin-top: 3px; display: block; font-weight: normal; }
        .btn:hover span.desc { color: #222; }

        .boss-btn { border-color: #A020F0; color: #E0E0E0; }
        .hard-btn { border-color: #FF3333; color: #FFAAAA; }
        .special-btn { border-color: #00FFCC; color: #AAFFFF; }
        
        /* LAYOUTS */
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 20, 40, 0.95); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 20;
        }
        .mission-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; margin-bottom: 10px; max-height: 60vh; overflow-y: auto; width: 95%; max-width: 800px;}
        
        /* OTHERS (Original Styles Kept) */
        #game-ui { display: none; position: absolute; top: 10px; left: 10px; pointer-events: none; width: 100%; padding-right: 20px; box-sizing: border-box; z-index: 5; }
        #exit-mission-btn { position: absolute; top: 0; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.6); border: 1px solid #FF3333; color: #FF3333; cursor: pointer; pointer-events: auto; padding: 5px 15px; font-weight: bold; font-size: 12px; z-index: 100; }
        #top-bar { display: flex; justify-content: space-between; align-items: flex-start; }
        .stat-box { background: rgba(0,0,0,0.6); padding: 5px 10px; border-radius: 5px; margin-bottom: 5px; font-size: 16px; border: 1px solid rgba(255,255,255,0.2); }
        #mission-text { font-size: 18px; font-weight: bold; color: #77DDFF; text-shadow: 1px 1px 0 #000; }
        .bar-container { margin-top: 5px; width: 200px; height: 15px; background: #444; border: 2px solid #fff; position: relative; }
        #health-fill { width: 100%; height: 100%; background: #00FF00; transition: width 0.1s; }
        #xp-bar-container { margin-top: 5px; height: 10px; border-color: #0077FF; }
        #xp-fill { width: 0%; height: 100%; background: #0077FF; transition: width 0.2s; }
        #level-text { position: absolute; top: -20px; left: 0; font-size: 14px; color: #0077FF; font-weight: bold; }
        
        /* SHOP & MENUS */
        .shop-container { display: flex; gap: 20px; width: 95%; max-width: 1000px; justify-content: center; flex-wrap: wrap; }
        .shop-column { background: #223; padding: 15px; border: 2px solid #558; width: 200px; }
        .shop-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 5px; font-size: 12px;}
        .buy-btn { background: #222; border: 1px solid #FFFF00; color: #FFFF00; padding: 5px; cursor: pointer; font-size: 10px; }
        .buy-btn.owned { background: #004400; border-color: #00FF00; color: white; cursor: default; }
        .buy-btn.equipped { background: #00FF00; color: black; font-weight: bold; }
        .buy-btn:disabled { opacity: 0.5; cursor: not-allowed; border-color: #555; color: #555; }
        
        /* CHEAT & MOBILE */
        #cheat-toggle-btn { display: none; position: absolute; top: 100px; left: 50px; width: 50px; height: 50px; background: white; border-radius: 50%; z-index: 1000; justify-content: center; align-items: center; font-size: 30px; cursor: pointer; box-shadow: 0 0 10px white; }
        #cheat-menu { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0, 0, 0, 0.9); border: 2px solid white; padding: 20px; z-index: 1001; text-align: center; border-radius: 10px; width: 250px; }
        #mobile-controls { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .joystick-zone { position: absolute; bottom: 40px; width: 90px; height: 90px; background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 50%; pointer-events: auto; }
        #stick-left { left: 20px; } #stick-right { right: 20px; }
        .joystick-knob { position: absolute; top: 50%; left: 50%; width: 40px; height: 40px; background: rgba(0, 119, 255, 0.5); border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; }
        #mobile-grenade-btn { position: absolute; bottom: 100px; right: 130px; width: 50px; height: 50px; background: rgba(255, 165, 0, 0.3); border: 2px solid #FFA500; border-radius: 50%; color: #FFA500; font-size: 20px; display: flex; justify-content: center; align-items: center; pointer-events: auto; cursor: pointer; }
        #weapon-bar { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; pointer-events: auto; }
        .wpn-btn { width: 35px; height: 35px; background: #333; border: 1px solid #666; color: white; font-size: 9px; font-weight: bold; display: flex; justify-content: center; align-items: center; border-radius: 5px; cursor: pointer; }
        .wpn-btn.active { border-color: #0077FF; background: #004488; }
        
        /* RESPONSIVE */
        @media (max-width: 768px) {
            .mission-grid { grid-template-columns: 1fr 1fr; }
            .shop-container { flex-direction: column; align-items: center; padding-bottom: 80px; }
            .shop-column { width: 90%; }
        }
    </style>
</head>
<body>

    <div id="levelup-notify" style="position: absolute; top: 30%; left: 50%; transform: translate(-50%, -50%); opacity: 0; transition: opacity 0.5s; z-index: 100; text-align: center; width: 100%; color: gold; font-weight: bold; font-size: 30px; pointer-events: none;">LEVEL UP!</div>
    <div id="artifact-notify" style="position: absolute; top: 30%; left: 50%; transform: translate(-50%, -50%); opacity: 0; transition: opacity 0.5s; z-index: 100; text-align: center; width: 100%; color: cyan; font-weight: bold; font-size: 24px; pointer-events: none;">FOUND!</div>

    <div id="cheat-toggle-btn" onclick="document.getElementById('cheat-menu').style.display='block'">üéÖ</div>
    <div id="cheat-menu">
        <h3 style="color:white; margin:0 0 10px 0;">SANTA CHEATS</h3>
        <div style="margin: 10px 0; color: white;">AIMBOT <input type="checkbox" onchange="cheats.aim=this.checked"></div>
        <div style="margin: 10px 0; color: white;">ESP (WH) <input type="checkbox" onchange="cheats.wh=this.checked"></div>
        <div style="margin: 10px 0; color: white;">AUTO-LOOT <input type="checkbox" onchange="cheats.loot=this.checked"></div>
        <div style="margin: 10px 0; color: white;">WALLBANG <input type="checkbox" onchange="cheats.wallbang=this.checked"></div>
        <button class="btn" style="width:100%; border-color:red;" onclick="document.getElementById('cheat-menu').style.display='none'">CLOSE</button>
    </div>

    <div id="platform-screen" class="overlay" style="z-index: 30;">
        <h1 style="color: #00AAFF; text-align: center;">TACTICAL SHOOTER<br>MEGA MODE</h1>
        <h2 id="lbl-choose-ctrl" style="color: #aaa;">Choose Control / –û–±–µ—Ä—ñ—Ç—å –∫–µ—Ä—É–≤–∞–Ω–Ω—è</h2>
        <button class="btn" style="width: 200px; padding: 20px; font-size: 18px;" onclick="selectPlatform('PC')">üíª PC (Mouse)</button>
        <button class="btn" style="width: 200px; padding: 20px; font-size: 18px;" onclick="selectPlatform('MOBILE')">üì± Mobile (Touch)</button>
    </div>

    <div id="settings-screen" class="overlay" style="display: none;">
        <div class="shop-column" style="width: 300px; text-align: center;">
            <h1 id="lbl-settings">SETTINGS</h1>
            <div style="margin: 20px;">
                <button class="btn" style="width: 100%; margin-bottom: 10px;" onclick="setLang('en')">üá∫üá∏ ENGLISH</button>
                <button class="btn" style="width: 100%; margin-bottom: 10px;" onclick="setLang('uk')">üá∫üá¶ –£–ö–†–ê–á–ù–°–¨–ö–ê</button>
            </div>
            <button id="btn-hud-edit" class="btn" style="width: 100%; display:none;" onclick="startHudEdit()">üì± HUD EDITOR</button>
            <button class="btn" style="width: 100%; margin-top:20px; border-color:red;" onclick="document.getElementById('settings-screen').style.display='none'">OK</button>
        </div>
    </div>

    <div id="menu-overlay" class="overlay" style="display: none;">
        <h1 id="menu-title" style="color: #00AAFF; text-shadow: 0 0 10px white;">MISSION MENU</h1>
        <div style="color: #FFFF00; margin-bottom: 20px; border: 1px solid #555; padding: 10px;">
            LVL: <span id="menu-level">1</span> | XP: <span id="menu-xp">0</span> | üí∞: <span id="menu-coins">0</span>
        </div>
        
        <div id="menu-buttons" class="mission-grid">
            </div>

        <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; width: 100%; max-width: 800px;">
            <button class="btn" id="btn-skills" style="border-color: #FF00AA; min-width: 150px;" onclick="openSkills()">üß† SKILLS</button>
            <button class="btn" id="btn-multi" style="border-color: #FF00FF; min-width: 150px;" onclick="openMultiplayer()">üåê ONLINE</button>
            <button class="btn" id="btn-custom" style="border-color: #00FFFF; min-width: 150px;" onclick="playCustomMap()">üó∫Ô∏è CUSTOM MAP</button>
            <button class="btn" id="btn-shop" style="border-color: #FFFF00; min-width: 150px;" onclick="openShop()">üõí SHOP</button>
            <button class="btn" id="btn-editor" style="border-color: #00FF00; min-width: 150px;" onclick="openEditor()">üõ†Ô∏è EDITOR</button>
            <button class="btn" id="btn-settings" style="border-color: #FFF; min-width: 150px;" onclick="openSettings()">‚öôÔ∏è SETTINGS</button>
        </div>
        <button id="end-game-btn" class="btn" onclick="showMainMenu()" style="display:none; background: #FF3333; margin-top: 20px; width: 200px;">MAIN MENU</button>
    </div>

    <div id="game-ui">
        <button id="exit-mission-btn" onclick="showMainMenu()">MENU</button>
        <div id="top-bar">
            <div>
                <div id="mission-text">Goal...</div>
                <div class="bar-container"><div id="health-fill"></div></div>
                <div class="bar-container" id="xp-bar-container"><div id="level-text">L1</div><div id="xp-fill"></div></div>
                <div class="stat-box" id="weapon-info" style="margin-top: 5px;">Weapon</div>
            </div>
            <div style="text-align: right;">
                <div class="stat-box" id="stats">Time: 0.0</div>
                <div class="stat-box" id="grenade-counter">üí£: 3</div>
                <div class="stat-box" id="coin-counter">üí∞: 0</div>
            </div>
        </div>
    </div>

    <div id="shop-screen" class="overlay" style="display: none; overflow-y: auto;">
        <h1 id="lbl-shop">SHOP</h1>
        <div style="color: yellow; margin-bottom: 5px;">üí∞: <span id="shop-coins">0</span></div>
        <div class="shop-container">
            <div class="shop-column">
                <h3 id="lbl-look">LOOK</h3>
                <canvas id="previewCanvas" width="150" height="150" style="border: 1px solid #555; background: #222;"></canvas>
                <input type="color" id="colorPicker" value="#0077FF" onchange="updatePreview()">
            </div>
            <div class="shop-column">
                <h3 id="lbl-acc">OUTFIT</h3>
                <div id="accessories-list"></div>
            </div>
            <div class="shop-column">
                <h3 id="lbl-wpn">WEAPONS</h3>
                <div id="weapons-list"></div>
                <input type="text" id="promo-input" placeholder="CODE" style="width: 60%; background: #111; color: white; border: 1px solid blue;">
                <button onclick="redeemCode()">OK</button>
            </div>
            <div class="shop-column">
                <h3 id="lbl-pets">PETS</h3>
                <div id="pets-list"></div>
            </div>
        </div>
        <button class="btn" onclick="closeShop()" style="width: 200px; margin-top: 10px;">EXIT</button>
    </div>

    <div id="skills-screen" class="overlay" style="display: none;">
        <h1 id="lbl-skills">PASSIVE SKILLS</h1>
        <div style="color: yellow; margin-bottom: 5px;">üí∞: <span id="skill-coins">0</span></div>
        <div class="shop-container" id="skills-list" style="justify-content: center;"></div>
        <button class="btn" onclick="closeSkills()" style="width: 200px; margin-top: 10px;">EXIT</button>
    </div>

    <div id="hud-edit-overlay" style="display: none; position: absolute; top:0; left:0; width:100%; height:100%; z-index: 40; background: rgba(0,0,0,0.5);">
        <div style="position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px;">
            <button class="btn" style="background: green;" onclick="saveHud()">SAVE</button>
            <button class="btn" style="background: red;" onclick="resetHud()">RESET</button>
        </div>
        <h2 style="position:absolute; top:20%; width:100%; text-align:center;">DRAG TO MOVE</h2>
    </div>
    <div id="mobile-controls">
        <div id="stick-left" class="joystick-zone hud-draggable"><div class="joystick-knob" id="knob-left"></div></div>
        <div id="stick-right" class="joystick-zone hud-draggable"><div class="joystick-knob" id="knob-right"></div></div>
        <div id="mobile-grenade-btn" class="hud-draggable" onclick="throwGrenadeMobile()">üí£</div>
        <div id="weapon-bar" class="hud-draggable"></div>
    </div>

    <div id="editor-ui" style="display: none; position: absolute; bottom: 10px; left: 10px; z-index: 50; gap: 5px;">
        <div class="btn" onclick="setEditorTool(1)">‚¨ú</div>
        <div class="btn" onclick="setEditorTool(2)">üëæ</div>
        <div class="btn" onclick="setEditorTool(0)">‚ùå</div>
        <div class="btn" onclick="saveCustomMap()">SAVE</div>
        <div class="btn" onclick="exitEditor()" style="color:red;">EXIT</div>
    </div>

    <div id="multiplayer-screen" class="overlay" style="display: none;">
        <h1>MULTIPLAYER (P2P)</h1>
        <div class="shop-column" style="width: 400px; text-align: center;">
            <h3>Your ID:</h3>
            <div id="my-peer-id" onclick="copyId()" style="color:yellow; cursor:pointer; border:1px dashed #555; padding:5px;">Loading...</div>
            <div id="mp-status" style="color: lime; margin: 10px;">...</div>
            <hr>
            <h3>Join Friend:</h3>
            <input type="text" id="join-peer-id" placeholder="Friend ID" style="padding:10px; width:80%;">
            <button class="btn" style="width:100%; margin-top:10px;" onclick="joinPeerGame()">CONNECT</button>
        </div>
        <button class="btn" style="margin-top:20px; border-color:red;" onclick="closeMultiplayer()">BACK</button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        // --- LOCALIZATION SYSTEM ---
        let curLang = 'en'; // Default English
        
        const LANG = {
            en: {
                menuTitle: "MISSION MENU",
                settings: "SETTINGS",
                shop: "SHOP",
                skills: "SKILLS",
                online: "ONLINE",
                editor: "MAP EDITOR",
                custom: "CUSTOM MAP",
                look: "LOOK",
                outfit: "OUTFIT",
                weapons: "WEAPONS",
                pets: "PETS",
                goal: "Goal",
                time: "Time",
                exit: "EXIT",
                back: "BACK",
                victory: "VICTORY!",
                defeat: "DEFEAT!",
                mainMenu: "MAIN MENU",
                // Missions
                m1_n: "The Trench", m1_d: "Survive 20 seconds",
                m2_n: "Cleanup", m2_d: "Kill 5 Enemies",
                m3_n: "The Boss", m3_d: "Defeat the Boss",
                m4_n: "The Horde", m4_d: "Survive 40 seconds",
                m5_n: "Meat Grinder", m5_d: "Kill 50 Enemies",
                m6_n: "Hardcore", m6_d: "Survive 60s (Fast Enemies)",
                m7_n: "Demolition", m7_d: "15 Grenade Kills",
                m8_n: "Apocalypse", m8_d: "Survive 50s (Chaos)",
                m9_n: "Capture", m9_d: "Hold Center for 15s",
                m10_n: "Darkness", m10_d: "Survive in the dark",
                m11_n: "Sniper Valley", m11_d: "Kill 10 (Long Range)",
                m12_n: "Training", m12_d: "Practice Mode",
                m13_n: "Bazooka Range", m13_d: "Kill 30 Enemies",
                m14_n: "Line Defense", m14_d: "Survive 60s vs Tanks",
                m15_n: "Dual Boss", m15_d: "Defeat 2 Bosses",
                m16_n: "Tank Rush", m16_d: "Destroy 15 Tanks",
                m17_n: "Speedrun", m17_d: "Survive 45s (Super Speed)",
                m18_n: "Boss Rush", m18_d: "Defeat 3 Bosses",
                // Items
                w_pistol: "Pistol", w_rifle: "Rifle", w_shotgun: "Shotgun", w_sniper: "Sniper", 
                w_minigun: "Minigun", w_snowball: "Snowball", w_bazooka: "Bazooka", w_laser: "Laser", w_crossbow: "Crossbow", w_plasma: "Plasma",
                o_none: "None", o_santa: "Santa Hat", o_cap: "Cap", o_helmet: "Helmet", o_vest: "Vest", o_nvg: "NVG Goggles", o_full: "Juggernaut", o_chain: "Gold Chain", o_crown: "King Crown",
                p_none: "None", p_drone: "Drone", p_slime: "Slime", p_ufo: "UFO", p_wisp: "Wisp", p_turret: "Turret",
                // Skills
                sk_speed: "Speedrunner", sk_speed_d: "+15% Move Speed",
                sk_rico: "Ricochet", sk_rico_d: "50% Bullet Bounce",
                sk_vamp: "Vampire", sk_vamp_d: "5% Heal on Kill",
                sk_mag: "Magnet", sk_mag_d: "+50% Loot Range",
                sk_reg: "Regen", sk_reg_d: "Heal 1HP/2s",
                sk_tough: "Toughness", sk_tough_d: "-20% Damage Taken"
            },
            uk: {
                menuTitle: "–ú–ï–ù–Æ –ú–Ü–°–Ü–ô",
                settings: "–ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø",
                shop: "–ú–ê–ì–ê–ó–ò–ù",
                skills: "–ù–ê–í–ò–ß–ö–ò",
                online: "–û–ù–õ–ê–ô–ù",
                editor: "–†–ï–î–ê–ö–¢–û–†",
                custom: "–°–í–û–Ø –ö–ê–†–¢–ê",
                look: "–í–ò–ì–õ–Ø–î",
                outfit: "–û–î–Ø–ì",
                weapons: "–ó–ë–†–û–Ø",
                pets: "–ü–Ü–¢–û–ú–¶–Ü",
                goal: "–¶—ñ–ª—å",
                time: "–ß–∞—Å",
                exit: "–í–ò–•–Ü–î",
                back: "–ù–ê–ó–ê–î",
                victory: "–ü–ï–†–ï–ú–û–ì–ê!",
                defeat: "–ü–û–†–ê–ó–ö–ê!",
                mainMenu: "–ì–û–õ–û–í–ù–ï –ú–ï–ù–Æ",
                // Missions
                m1_n: "–û–∫–æ–ø", m1_d: "–í–∏–∂–∏—Ç–∏ 20 —Å–µ–∫—É–Ω–¥",
                m2_n: "–ó–∞—á–∏—Å—Ç–∫–∞", m2_d: "–í–±–∏—Ç–∏ 5 –≤–æ—Ä–æ–≥—ñ–≤",
                m3_n: "–ë–æ—Å", m3_d: "–í–±–∏—Ç–∏ –ë–æ—Å–∞",
                m4_n: "–û—Ä–¥–∞", m4_d: "–í–∏–∂–∏—Ç–∏ 40 —Å–µ–∫—É–Ω–¥",
                m5_n: "–ú'—è—Å–æ—Ä—É–±–∫–∞", m5_d: "–í–±–∏—Ç–∏ 50 –≤–æ—Ä–æ–≥—ñ–≤",
                m6_n: "–•–∞—Ä–¥–∫–æ—Ä", m6_d: "–í–∏–∂–∏—Ç–∏ 60—Å (–®–≤–∏–¥–∫—ñ)",
                m7_n: "–ü—ñ–¥—Ä–∏–≤–Ω–∏–∫", m7_d: "15 –≤–±–∏–≤—Å—Ç–≤ –≥—Ä–∞–Ω–∞—Ç–æ—é",
                m8_n: "–ê–ø–æ–∫–∞–ª—ñ–ø—Å–∏—Å", m8_d: "–í–∏–∂–∏—Ç–∏ 50—Å (–•–∞–æ—Å)",
                m9_n: "–ó–∞—Ö–≤–∞—Ç", m9_d: "–í—Ç—Ä–∏–º–∞—Ç–∏ —Ü–µ–Ω—Ç—Ä 15—Å",
                m10_n: "–¢–µ–º—Ä—è–≤–∞", m10_d: "–í–∏–∂–∏—Ç–∏ —É —Ç–µ–º—Ä—è–≤—ñ",
                m11_n: "–°–Ω–∞–π–ø–µ—Ä", m11_d: "–í–±–∏—Ç–∏ 10 (–î–∞–ª–µ–∫–æ)",
                m12_n: "–¢—Ä–µ–Ω—É–≤–∞–Ω–Ω—è", m12_d: "–¢–µ—Å—Ç–æ–≤–∏–π —Ä–µ–∂–∏–º",
                m13_n: "–ë–∞–∑—É–∫–∞", m13_d: "–í–±–∏—Ç–∏ 30 –≤–æ—Ä–æ–≥—ñ–≤",
                m14_n: "–û–±–æ—Ä–æ–Ω–∞", m14_d: "–í–∏–∂–∏—Ç–∏ 60—Å –ø—Ä–æ—Ç–∏ —Ç–∞–Ω–∫—ñ–≤",
                m15_n: "–ü–æ–¥–≤—ñ–π–Ω–∏–π –ë–æ—Å", m15_d: "–í–±–∏—Ç–∏ 2 –ë–æ—Å—ñ–≤",
                m16_n: "–¢–∞–Ω–∫–æ–≤–∏–π –†–∞—à", m16_d: "–ó–Ω–∏—â–∏—Ç–∏ 15 –¢–∞–Ω–∫—ñ–≤",
                m17_n: "–°–ø—ñ–¥—Ä–∞–Ω", m17_d: "–í–∏–∂–∏—Ç–∏ 45—Å (–î—É–∂–µ —à–≤–∏–¥–∫–æ)",
                m18_n: "–ë–æ—Å –†–∞—à", m18_d: "–í–±–∏—Ç–∏ 3 –ë–æ—Å—ñ–≤",
                // Items
                w_pistol: "–ü—ñ—Å—Ç–æ–ª–µ—Ç", w_rifle: "–ê–≤—Ç–æ–º–∞—Ç", w_shotgun: "–î—Ä–æ–±–æ–≤–∏–∫", w_sniper: "–°–Ω–∞–π–ø–µ—Ä", 
                w_minigun: "–ö—É–ª–µ–º–µ—Ç", w_snowball: "–°–Ω—ñ–≥–æ–º–µ—Ç", w_bazooka: "–ë–∞–∑—É–∫–∞", w_laser: "–õ–∞–∑–µ—Ä", w_crossbow: "–ê—Ä–±–∞–ª–µ—Ç", w_plasma: "–ü–ª–∞–∑–º–∞",
                o_none: "–ë–µ–∑ –æ–¥—è–≥—É", o_santa: "–®–∞–ø–∫–∞ –°–∞–Ω—Ç–∏", o_cap: "–ö–µ–ø–∫–∞", o_helmet: "–ö–∞—Å–∫–∞", o_vest: "–ñ–∏–ª–µ—Ç", o_nvg: "–û–∫—É–ª—è—Ä–∏ –ù–ë", o_full: "–î–∂–∞–≥–≥–µ—Ä–Ω–∞—É—Ç", o_chain: "–õ–∞–Ω—Ü—é–≥", o_crown: "–ö–æ—Ä–æ–Ω–∞",
                p_none: "–ù–µ–º–∞—î", p_drone: "–î—Ä–æ–Ω", p_slime: "–°–ª–∞–π–º", p_ufo: "–ù–õ–û", p_wisp: "–í–æ–≥–Ω–∏–∫", p_turret: "–¢—É—Ä–µ–ª—å",
                // Skills
                sk_speed: "–°–ø—ñ–¥—Ä–∞–Ω–Ω–µ—Ä", sk_speed_d: "+15% –®–≤–∏–¥–∫–æ—Å—Ç—ñ",
                sk_rico: "–†–∏–∫–æ—à–µ—Ç", sk_rico_d: "50% –í—ñ–¥—Å–∫–æ–∫ –∫—É–ª—å",
                sk_vamp: "–í–∞–º–ø—ñ—Ä", sk_vamp_d: "5% –õ—ñ–∫—É–≤–∞–Ω–Ω—è –∑–∞ –≤–±–∏–≤—Å—Ç–≤–æ",
                sk_mag: "–ú–∞–≥–Ω—ñ—Ç", sk_mag_d: "+50% –†–∞–¥—ñ—É—Å –ø—ñ–¥–±–æ—Ä—É",
                sk_reg: "–†–µ–≥–µ–Ω–µ—Ä–∞—Ü—ñ—è", sk_reg_d: "1 HP –∫–æ–∂–Ω—ñ 2—Å",
                sk_tough: "–°—Ç—ñ–π–∫—ñ—Å—Ç—å", sk_tough_d: "-20% –®–∫–æ–¥–∏ –ø–æ —Å–æ–±—ñ"
            }
        };

        const MISSIONS = [
            { id: 1, kName: 'm1_n', kDesc: 'm1_d', style: '' },
            { id: 2, kName: 'm2_n', kDesc: 'm2_d', style: '' },
            { id: 3, kName: 'm3_n', kDesc: 'm3_d', style: 'boss-btn' },
            { id: 4, kName: 'm4_n', kDesc: 'm4_d', style: '' },
            { id: 5, kName: 'm5_n', kDesc: 'm5_d', style: '' },
            { id: 6, kName: 'm6_n', kDesc: 'm6_d', style: 'hard-btn' },
            { id: 7, kName: 'm7_n', kDesc: 'm7_d', style: '' },
            { id: 8, kName: 'm8_n', kDesc: 'm8_d', style: 'hard-btn' },
            { id: 9, kName: 'm9_n', kDesc: 'm9_d', style: 'special-btn' },
            { id: 10, kName: 'm10_n', kDesc: 'm10_d', style: 'special-btn' },
            { id: 11, kName: 'm11_n', kDesc: 'm11_d', style: 'special-btn' },
            { id: 13, kName: 'm13_n', kDesc: 'm13_d', style: 'special-btn' },
            { id: 14, kName: 'm14_n', kDesc: 'm14_d', style: 'hard-btn' },
            { id: 15, kName: 'm15_n', kDesc: 'm15_d', style: 'boss-btn' },
            { id: 16, kName: 'm16_n', kDesc: 'm16_d', style: 'hard-btn' },
            { id: 17, kName: 'm17_n', kDesc: 'm17_d', style: 'special-btn' },
            { id: 18, kName: 'm18_n', kDesc: 'm18_d', style: 'boss-btn' },
            { id: 12, kName: 'm12_n', kDesc: 'm12_d', style: 'border-color: #00FF00; color: #AAFFAA;' }
        ];

        function getTxt(key) { return LANG[curLang][key] || key; }

        function setLang(l) {
            curLang = l;
            updateTexts();
            renderMissions();
            if(gameState === 'MENU' || gameState === 'PLATFORM_SELECT') { } 
            else { showMainMenu(); } // Refresh UI
        }

        function updateTexts() {
            document.getElementById('menu-title').innerText = getTxt('menuTitle');
            document.getElementById('lbl-settings').innerText = getTxt('settings');
            document.getElementById('lbl-shop').innerText = getTxt('shop');
            document.getElementById('lbl-skills').innerText = getTxt('skills');
            document.getElementById('lbl-look').innerText = getTxt('look');
            document.getElementById('lbl-acc').innerText = getTxt('outfit');
            document.getElementById('lbl-wpn').innerText = getTxt('weapons');
            document.getElementById('lbl-pets').innerText = getTxt('pets');
            
            // Buttons
            document.getElementById('btn-skills').innerText = "üß† " + getTxt('skills');
            document.getElementById('btn-multi').innerText = "üåê " + getTxt('online');
            document.getElementById('btn-custom').innerText = "üó∫Ô∏è " + getTxt('custom');
            document.getElementById('btn-shop').innerText = "üõí " + getTxt('shop');
            document.getElementById('btn-editor').innerText = "üõ†Ô∏è " + getTxt('editor');
            document.getElementById('btn-settings').innerText = "‚öôÔ∏è " + getTxt('settings');
            document.getElementById('end-game-btn').innerText = getTxt('mainMenu');
            document.getElementById('exit-mission-btn').innerText = getTxt('back');
        }

        function renderMissions() {
            const container = document.getElementById('menu-buttons');
            container.innerHTML = '';
            MISSIONS.forEach(m => {
                let btn = document.createElement('button');
                btn.className = 'btn ' + m.style;
                btn.onclick = () => startMission(m.id);
                btn.innerHTML = `${getTxt(m.kName)}<span class="desc">${getTxt(m.kDesc)}</span>`;
                container.appendChild(btn);
            });
        }

        // --- CORE VARIABLES ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let playerStats = { totalKills: 0, coins: 0, color: '#0077FF', xp: 0, level: 1, nextLevelXp: 100, unlockedWeapons: ['pistol'], unlockedOutfits: ['none'], currentOutfit: 'none', unlockedPets:['none'], currentPet:'none', skills:[], redeemedCodes: [], godMode: false };
        let controlMode = 'PC'; let gameState = 'PLATFORM_SELECT';
        let hudLayout = {}; let customMap = { walls: [], spawns: [] };
        
        let player, enemies = [], bullets = [], particles = [], obstacles = [], drops = [], activePets = [];
        let gameTime = 0, enemiesKilled = 0, currentMissionId = 0, bossSpawned = false, zoneTimer = 0;
        let keys = {}, mouse = {x:0, y:0, down:false};
        let joystickLeft = {x:0, y:0, active:false}, joystickRight = {x:0, y:0, active:false};
        
        // --- DATA OBJECTS (For Shop) ---
        const SHOP_DATA = {
            outfits: [
                {id:'none', k:'o_none', p:0}, {id:'santa_hat', k:'o_santa', p:0}, {id:'cap', k:'o_cap', p:150},
                {id:'helmet', k:'o_helmet', p:1500}, {id:'vest', k:'o_vest', p:3000}, {id:'nvg', k:'o_nvg', p:5000},
                {id:'full_armor', k:'o_full', p:8000}, {id:'chain', k:'o_chain', p:500}, {id:'crown', k:'o_crown', p:20000}
            ],
            weapons: [
                {id:'minigun', k:'w_minigun', p:1000, lvl:5}, {id:'bazooka', k:'w_bazooka', p:5000, lvl:8},
                {id:'crossbow', k:'w_crossbow', p:8000, lvl:10}, {id:'laser', k:'w_laser', p:10000, lvl:12},
                {id:'plasma', k:'w_plasma', p:15000, lvl:18}
            ],
            pets: [
                {id:'none', k:'p_none', p:0}, {id:'drone', k:'p_drone', p:5000, lvl:15}, {id:'slime', k:'p_slime', p:12000, lvl:18},
                {id:'ufo', k:'p_ufo', p:20000, lvl:20}, {id:'wisp', k:'p_wisp', p:25000, lvl:22}, {id:'turret', k:'p_turret', p:30000, lvl:25}
            ],
            skills: [
                {id:'speed', k:'sk_speed', d:'sk_speed_d', p:2000, lvl:3},
                {id:'ricochet', k:'sk_rico', d:'sk_rico_d', p:5000, lvl:5},
                {id:'vampire', k:'sk_vamp', d:'sk_vamp_d', p:8000, lvl:8},
                {id:'magnet', k:'sk_mag', d:'sk_mag_d', p:3000, lvl:10},
                {id:'regen', k:'sk_reg', d:'sk_reg_d', p:15000, lvl:12},
                {id:'toughness', k:'sk_tough', d:'sk_tough_d', p:25000, lvl:20}
            ]
        };

        // --- INIT & RESIZE ---
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resize); resize();
        updateTexts(); renderMissions(); // Init UI

        function selectPlatform(mode) {
            controlMode = mode;
            document.getElementById('platform-screen').style.display='none';
            loadGame(); showMainMenu();
            if(mode==='MOBILE') {
                document.getElementById('mobile-controls').style.display='block';
                document.getElementById('btn-hud-edit').style.display='inline-block';
            }
        }

        // --- GAME LOGIC ---
        function startMission(id) {
            currentMissionId = id; gameState = 'PLAYING';
            player = new Player(canvas.width/2, canvas.height/2);
            enemies=[]; bullets=[]; obstacles=[]; drops=[]; activePets=[];
            gameTime=0; enemiesKilled=0; bossSpawned=false; zoneTimer=0;
            
            // Generate Obstacles
            if(id !== 12 && id !== 'CUSTOM') {
                for(let i=0; i<12; i++) {
                    let s=40+Math.random()*60, x=Math.random()*(canvas.width-s), y=Math.random()*(canvas.height-s);
                    if(Math.hypot(x-player.x, y-player.y)>200) obstacles.push({x,y,size:s});
                }
            } else if (id === 'CUSTOM') {
                customMap.walls.forEach(w => obstacles.push({x:w.x, y:w.y, size:50}));
            }

            // Spawn Pet
            if(playerStats.currentPet !== 'none') activePets.push(new Pet(playerStats.currentPet));

            // Set Title text based on language
            let mData = MISSIONS.find(m=>m.id===id);
            let goalText = mData ? getTxt(mData.kDesc) : getTxt('goal');
            if(id==='CUSTOM') goalText = getTxt('custom');
            document.getElementById('mission-text').innerText = goalText;

            document.getElementById('menu-overlay').style.display='none';
            document.getElementById('game-ui').style.display='block';
            updateGameUI();
        }

        function updateGame() {
            if(gameState !== 'PLAYING') return;
            gameTime += 1/60;
            
            // Spawning Logic
            if(currentMissionId !== 'CUSTOM' && currentMissionId !== 12) {
                // Boss Spawn
                if((currentMissionId===3 || currentMissionId===15 || currentMissionId===18) && !bossSpawned && gameTime>1) {
                    enemies.push(new Enemy(0, -50, 'boss'));
                    if(currentMissionId===15) enemies.push(new Enemy(canvas.width, -50, 'boss'));
                    if(currentMissionId===18) { enemies.push(new Enemy(canvas.width, -50, 'boss')); enemies.push(new Enemy(canvas.width/2, canvas.height+50, 'boss')); }
                    bossSpawned=true;
                }
                // Regular Spawn
                let rate = 120;
                if([4,6,8,11,16,17,18].includes(currentMissionId)) rate = 60;
                if(Math.floor(gameTime*60)%rate === 0) {
                    let type = 'standard';
                    if(currentMissionId===16 || (currentMissionId===14 && Math.random()>0.7)) type='tank';
                    let x=Math.random()*canvas.width, y=-30; 
                    if(Math.random()>0.5){x=-30; y=Math.random()*canvas.height;}
                    enemies.push(new Enemy(x, y, type));
                }
            }

            // Entity Updates
            player.update();
            activePets.forEach(p=>p.update());
            bullets.forEach((b,i) => {
                b.update();
                if(b.dead) bullets.splice(i,1);
            });
            enemies.forEach((e,i) => {
                e.update();
                if(e.dead) enemies.splice(i,1);
            });
            
            // Win/Loss Conditions
            if(player.hp <= 0) gameOver(false);
            
            // Mission Specific Logic (Simplified for brevity but matching original)
            let win = false;
            if(currentMissionId===1 && gameTime>=20) win=true;
            if(currentMissionId===2 && enemiesKilled>=5) win=true;
            if((currentMissionId===3||currentMissionId===15) && bossSpawned && enemies.length===0) win=true;
            if(currentMissionId===4 && gameTime>=40) win=true;
            if(currentMissionId===5 && enemiesKilled>=50) win=true;
            if(currentMissionId===6 && gameTime>=60) win=true;
            if(currentMissionId===13 && enemiesKilled>=30) win=true;
            if(currentMissionId===9) {
                if(Math.hypot(player.x-canvas.width/2, player.y-canvas.height/2) < 100) zoneTimer += 1/60;
                document.getElementById('stats').innerText = `Zone: ${zoneTimer.toFixed(1)}/15`;
                if(zoneTimer>=15) win=true;
            } else {
                document.getElementById('stats').innerText = `${getTxt('time')}: ${gameTime.toFixed(0)}`;
            }

            if(win) gameOver(true);
        }

        function drawGame() {
            ctx.fillStyle = '#1a1a2e'; ctx.fillRect(0,0,canvas.width, canvas.height);
            // Draw Dark Mode
            if(currentMissionId===10) {
                let g = ctx.createRadialGradient(player.x, player.y, 50, player.x, player.y, 300);
                g.addColorStop(0, '#222'); g.addColorStop(1, '#000');
                ctx.fillStyle=g; ctx.fillRect(0,0,canvas.width, canvas.height);
            }
            // Objects
            ctx.fillStyle='#445'; obstacles.forEach(o=>ctx.fillRect(o.x,o.y,o.size,o.size));
            if(currentMissionId===9) { ctx.beginPath(); ctx.arc(canvas.width/2, canvas.height/2, 100, 0, Math.PI*2); ctx.strokeStyle='cyan'; ctx.stroke(); }
            
            enemies.forEach(e=>e.draw());
            bullets.forEach(b=>b.draw());
            if(player.hp>0) player.draw();
            activePets.forEach(p=>p.draw());
        }

        function loop() { requestAnimationFrame(loop); updateGame(); drawGame(); }
        loop();

        function gameOver(win) {
            gameState = 'MENU'; saveGame();
            document.getElementById('menu-overlay').style.display='flex';
            document.getElementById('menu-buttons').style.display='none';
            document.getElementById('end-game-btn').style.display='block';
            document.getElementById('game-ui').style.display='none';
            
            let t = document.getElementById('menu-title');
            t.innerText = win ? getTxt('victory') : getTxt('defeat');
            t.style.color = win ? '#00FF00' : 'red';
            
            if(win) {
                playerStats.coins += 100;
                addXp(50);
            }
        }

        function showMainMenu() {
            gameState = 'MENU';
            document.getElementById('menu-overlay').style.display='flex';
            document.getElementById('menu-buttons').style.display='grid';
            document.getElementById('end-game-btn').style.display='none';
            document.getElementById('game-ui').style.display='none';
            document.getElementById('menu-title').innerText = getTxt('menuTitle');
            document.getElementById('menu-title').style.color = '#00AAFF';
            updateMenuStats();
        }

        // --- CLASSES ---
        class Player {
            constructor(x,y) { 
                this.x=x; this.y=y; this.hp=100; this.maxHp=100; this.angle=0; this.weapon='pistol'; this.cooldown=0;
                if(playerStats.currentOutfit==='vest') this.hp+=100; // Simplified outfit logic
                this.maxHp=this.hp;
            }
            update() {
                let spd = 4.5;
                let dx=0, dy=0;
                if(controlMode==='PC') {
                    this.angle = Math.atan2(mouse.y-this.y, mouse.x-this.x);
                    if(keys['KeyW']) dy=-spd; if(keys['KeyS']) dy=spd; if(keys['KeyA']) dx=-spd; if(keys['KeyD']) dx=spd;
                    if(mouse.down && this.cooldown<=0) this.shoot();
                } else {
                    if(joystickLeft.active) { dx=joystickLeft.x*spd; dy=joystickLeft.y*spd; }
                    if(joystickRight.active) { this.angle = Math.atan2(joystickRight.y, joystickRight.x); if(this.cooldown<=0) this.shoot(); }
                }
                // Collision
                if(!checkWall(this.x+dx, this.y)) this.x+=dx;
                if(!checkWall(this.x, this.y+dy)) this.y+=dy;
                if(this.cooldown>0) this.cooldown--;
                updateGameUI();
            }
            shoot() {
                bullets.push(new Bullet(this.x, this.y, Math.cos(this.angle)*15, Math.sin(this.angle)*15, false));
                this.cooldown = 15;
            }
            draw() {
                ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.angle);
                ctx.fillStyle=playerStats.color; ctx.beginPath(); ctx.arc(0,0,15,0,Math.PI*2); ctx.fill(); ctx.stroke();
                ctx.fillStyle='black'; ctx.fillRect(10,-3,15,6);
                ctx.restore();
            }
        }

        class Enemy {
            constructor(x,y,type) { this.x=x; this.y=y; this.type=type; this.hp=type==='boss'?500:40; this.maxHp=this.hp; this.radius=type==='boss'?30:15; }
            update() {
                let a = Math.atan2(player.y-this.y, player.x-this.x);
                let spd = this.type==='boss'?1.5:2;
                this.x+=Math.cos(a)*spd; this.y+=Math.sin(a)*spd;
            }
            draw() {
                ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI*2);
                ctx.fillStyle = this.type==='boss'?'purple':'red'; ctx.fill(); ctx.stroke();
                // HP Bar
                ctx.fillStyle='red'; ctx.fillRect(this.x-15, this.y-25, 30, 4);
                ctx.fillStyle='lime'; ctx.fillRect(this.x-15, this.y-25, 30*(this.hp/this.maxHp), 4);
            }
        }

        class Bullet {
            constructor(x,y,vx,vy,isEnemy) { this.x=x; this.y=y; this.vx=vx; this.vy=vy; this.isEnemy=isEnemy; this.dead=false; }
            update() { 
                this.x+=this.vx; this.y+=this.vy;
                if(checkWall(this.x, this.y) || this.x<0 || this.x>canvas.width) this.dead=true;
                // Hit Logic
                if(!this.isEnemy) {
                    enemies.forEach(e=>{
                        if(Math.hypot(this.x-e.x, this.y-e.y) < e.radius+5) {
                            e.hp-=20; this.dead=true;
                            if(e.hp<=0 && enemies.includes(e)) { 
                                enemies.splice(enemies.indexOf(e),1); 
                                enemiesKilled++; playerStats.coins+=10; addXp(10);
                            }
                        }
                    });
                }
            }
            draw() { ctx.fillStyle='yellow'; ctx.beginPath(); ctx.arc(this.x,this.y,4,0,Math.PI*2); ctx.fill(); }
        }

        class Pet {
            constructor(id) { this.id=id; this.x=player.x; this.y=player.y; this.a=0; this.cd=0; }
            update() {
                let tx = player.x + Math.cos(gameTime*2)*40;
                let ty = player.y + Math.sin(gameTime*2)*40;
                this.x += (tx-this.x)*0.1; this.y += (ty-this.y)*0.1;
                // Attack nearest
                if(this.cd>0)this.cd--;
                if(enemies.length>0 && this.cd<=0) {
                    let e = enemies[0];
                    bullets.push(new Bullet(this.x, this.y, (e.x-this.x)*0.1, (e.y-this.y)*0.1, false));
                    this.cd=60;
                }
            }
            draw() { ctx.fillStyle='cyan'; ctx.beginPath(); ctx.arc(this.x, this.y, 8, 0, Math.PI*2); ctx.fill(); }
        }

        function checkWall(x,y) {
            return obstacles.some(o => x>o.x && x<o.x+o.size && y>o.y && y<o.y+o.size);
        }

        // --- SHOP RENDERER (LOCALIZED) ---
        function openShop() { 
            document.getElementById('menu-overlay').style.display='none'; 
            document.getElementById('shop-screen').style.display='flex';
            document.getElementById('shop-coins').innerText=playerStats.coins;
            
            renderShopList('accessories-list', SHOP_DATA.outfits, 'outfit');
            renderShopList('weapons-list', SHOP_DATA.weapons, 'weapon');
            renderShopList('pets-list', SHOP_DATA.pets, 'pet');
            updatePreview();
        }
        function renderShopList(divId, items, type) {
            const container = document.getElementById(divId); container.innerHTML='';
            items.forEach(i => {
                let div = document.createElement('div'); div.className='shop-item';
                let owned = (type==='outfit'?playerStats.unlockedOutfits:type==='weapon'?playerStats.unlockedWeapons:playerStats.unlockedPets).includes(i.id);
                let btnTxt = owned ? "OWNED" : i.p+"$";
                let name = getTxt(i.k);
                div.innerHTML = `<span>${name}</span> <button class="buy-btn ${owned?'owned':''}" onclick="buyItem('${type}','${i.id}',${i.p})">${btnTxt}</button>`;
                container.appendChild(div);
            });
        }
        function buyItem(type, id, price) {
            if(playerStats.coins >= price) {
                playerStats.coins-=price;
                if(type==='outfit') { playerStats.unlockedOutfits.push(id); playerStats.currentOutfit=id; }
                if(type==='weapon') { playerStats.unlockedWeapons.push(id); }
                if(type==='pet') { playerStats.unlockedPets.push(id); playerStats.currentPet=id; }
                saveGame(); openShop(); // Refresh
            }
        }
        function closeShop() { document.getElementById('shop-screen').style.display='none'; showMainMenu(); }
        function updatePreview() {
            const pCtx = document.getElementById('previewCanvas').getContext('2d');
            pCtx.clearRect(0,0,150,150); pCtx.fillStyle=document.getElementById('colorPicker').value;
            pCtx.beginPath(); pCtx.arc(75,75,30,0,Math.PI*2); pCtx.fill(); pCtx.stroke();
            playerStats.color = document.getElementById('colorPicker').value;
        }

        // --- XP & SAVE SYSTEM ---
        function addXp(amount) { playerStats.xp+=amount; if(playerStats.xp>=playerStats.nextLevelXp){playerStats.level++; playerStats.xp=0; playerStats.nextLevelXp*=1.2; saveGame();}}
        function updateMenuStats() { document.getElementById('menu-level').innerText=playerStats.level; document.getElementById('menu-coins').innerText=playerStats.coins; }
        function updateGameUI() { if(player) { document.getElementById('health-fill').style.width=(player.hp/player.maxHp*100)+'%'; } }
        function saveGame() { localStorage.setItem('ts_mega_v2', JSON.stringify(playerStats)); updateMenuStats(); }
        function loadGame() { let d=localStorage.getItem('ts_mega_v2'); if(d) playerStats=JSON.parse(d); updateMenuStats(); }

        // --- INPUT HANDLERS ---
        window.addEventListener('keydown', e=>keys[e.code]=true);
        window.addEventListener('keyup', e=>keys[e.code]=false);
        window.addEventListener('mousemove', e=>{mouse.x=e.clientX; mouse.y=e.clientY;});
        window.addEventListener('mousedown', ()=>mouse.down=true);
        window.addEventListener('mouseup', ()=>mouse.down=false);
        
        // Touch (Simplified joystick logic for brevity - assume standard stick logic)
        document.addEventListener('touchstart', e=>{
            if(controlMode==='MOBILE' && gameState==='PLAYING') {
                [...e.changedTouches].forEach(t=>{
                    if(t.clientX < window.innerWidth/2) { joystickLeft.active=true; joystickLeft.id=t.identifier; joystickLeft.sx=t.clientX; joystickLeft.sy=t.clientY; }
                    else { joystickRight.active=true; joystickRight.id=t.identifier; joystickRight.sx=t.clientX; joystickRight.sy=t.clientY; }
                });
            }
        });
        document.addEventListener('touchmove', e=>{
            if(controlMode==='MOBILE' && gameState==='PLAYING') {
                [...e.changedTouches].forEach(t=>{
                    if(t.identifier===joystickLeft.id) { 
                        let dx = t.clientX-joystickLeft.sx, dy=t.clientY-joystickLeft.sy;
                        let dist = Math.min(40, Math.hypot(dx,dy));
                        let angle = Math.atan2(dy,dx);
                        joystickLeft.x = Math.cos(angle)*(dist/40); joystickLeft.y = Math.sin(angle)*(dist/40);
                        document.getElementById('knob-left').style.transform = `translate(-50%,-50%) translate(${joystickLeft.x*40}px, ${joystickLeft.y*40}px)`;
                    }
                    if(t.identifier===joystickRight.id) {
                        let dx = t.clientX-joystickRight.sx, dy=t.clientY-joystickRight.sy;
                        joystickRight.x=dx; joystickRight.y=dy; // Raw vector for angle
                        document.getElementById('knob-right').style.transform = `translate(-50%,-50%) translate(${Math.cos(Math.atan2(dy,dx))*40}px, ${Math.sin(Math.atan2(dy,dx))*40}px)`;
                    }
                });
            }
        });
        document.addEventListener('touchend', e=>{
             [...e.changedTouches].forEach(t=>{
                 if(t.identifier===joystickLeft.id) { joystickLeft.active=false; joystickLeft.x=0; joystickLeft.y=0; document.getElementById('knob-left').style.transform='translate(-50%,-50%)'; }
                 if(t.identifier===joystickRight.id) { joystickRight.active=false; document.getElementById('knob-right').style.transform='translate(-50%,-50%)'; }
             });
        });

        // --- EDITOR & MULTIPLAYER STUBS (To prevent errors) ---
        function openEditor() { alert("Editor requires PC mouse"); }
        function openSkills() { document.getElementById('skills-screen').style.display='flex'; }
        function closeSkills() { document.getElementById('skills-screen').style.display='none'; }
        function openMultiplayer() { alert("Multiplayer connecting..."); }
    </script>
</body>
</html>
