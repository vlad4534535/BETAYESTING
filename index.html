<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PolyStrike: EVOLUTION</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;900&family=Rubik:wght@400;700&display=swap');
        
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Rubik', sans-serif; user-select: none; color: white; }
        
        /* === UI –≠–õ–ï–ú–ï–ù–¢–´ === */
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; z-index: 10; align-items: center; justify-content: center; background: radial-gradient(circle, #1a202c 0%, #000 100%); }
        .active { display: flex; }

        .panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 40px; border-radius: 20px; text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); width: 90%; max-width: 400px;
        }

        h1 { font-family: 'Orbitron'; font-size: 40px; margin-bottom: 30px; color: #00e5ff; text-transform: uppercase; letter-spacing: 3px; text-shadow: 0 0 20px rgba(0, 229, 255, 0.5); }
        
        .btn {
            background: linear-gradient(135deg, #00e5ff, #0077ff);
            border: none; padding: 15px 30px; margin: 10px; color: #fff;
            font-family: 'Orbitron'; font-size: 16px; font-weight: bold;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
            cursor: pointer; transition: 0.2s; width: 100%; letter-spacing: 1px;
        }
        .btn:active { transform: scale(0.95); }
        .btn-sec { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); }
        .btn-big { height: 80px; font-size: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; }

        /* –ò–ì–†–û–í–û–ô –ò–ù–¢–ï–†–§–ï–ô–° */
        #game-ui { pointer-events: none; background: transparent; justify-content: flex-start; }
        
        .top-hud { 
            position: absolute; top: 20px; width: 90%; display: flex; justify-content: space-between; 
            background: rgba(0,0,0,0.6); padding: 10px 20px; border-radius: 15px; border: 1px solid #333;
        }
        .hp-bar { width: 150px; height: 10px; background: #333; border-radius: 5px; overflow: hidden; margin-top: 5px; }
        .hp-fill { width: 100%; height: 100%; background: #0f0; transition: 0.2s; }

        #crosshair { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 6px; height: 6px; background: #0f0; border-radius: 50%; box-shadow: 0 0 5px #0f0; }

        /* –ú–û–ë–ò–õ–¨–ù–û–ï –£–ü–†–ê–í–õ–ï–ù–ò–ï */
        .controls { position: absolute; width: 100%; height: 100%; pointer-events: none; display: none; }
        .touch-btn { position: absolute; pointer-events: auto; background: rgba(255,255,255,0.15); border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; backdrop-filter: blur(5px); }
        .touch-btn:active { background: rgba(255,255,255,0.4); border-color: #fff; }

        #stick-zone { bottom: 50px; left: 50px; width: 140px; height: 140px; }
        #stick-knob { width: 50px; height: 50px; background: rgba(255,255,255,0.8); position: absolute; top: 45px; left: 45px; border-radius: 50%; pointer-events: none; }
    </style>
</head>
<body>

    <div id="device-screen" class="screen active">
        <h1>PolyStrike</h1>
        <div class="panel">
            <h3>–í–´–ë–ï–†–ò –£–°–¢–†–û–ô–°–¢–í–û</h3>
            <button class="btn btn-big" onclick="selectDevice('PC')">üíª –ö–û–ú–ü–¨–Æ–¢–ï–†</button>
            <button class="btn btn-big" onclick="selectDevice('MOBILE')">üì± –¢–ï–õ–ï–§–û–ù</button>
        </div>
    </div>

    <div id="menu-screen" class="screen">
        <div class="top-hud" style="position:relative; width:300px; margin-bottom:20px;">
            <div id="profile-display">üë§ –ò–≥—Ä–æ–∫</div>
            <div style="color:#ffd700">üí∞ <span id="money-display">0</span></div>
        </div>
        
        <div class="panel">
            <input type="text" id="nick-input" placeholder="–í–≤–µ–¥–∏ –Ω–∏–∫" style="background:transparent; border:none; border-bottom:1px solid #fff; color:white; text-align:center; font-size:20px; width:80%; margin-bottom:20px;">
            <button class="btn" onclick="openLobby()">‚öîÔ∏è –ò–ì–†–ê–¢–¨ –û–ù–õ–ê–ô–ù</button>
            <button class="btn btn-sec" onclick="openShop()">üõí –°–ö–ò–ù–´</button>
        </div>
    </div>

    <div id="shop-screen" class="screen">
        <h2>–ì–ê–†–î–ï–†–û–ë</h2>
        <div class="panel" id="shop-container" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;"></div>
        <button class="btn btn-sec" style="margin-top:20px; width:200px;" onclick="toMenu()">–ù–ê–ó–ê–î</button>
    </div>

    <div id="lobby-screen" class="screen">
        <div class="panel">
            <h2>–°–ï–¢–ï–í–ê–Ø –ò–ì–†–ê</h2>
            <button class="btn" onclick="hostGame()">–°–û–ó–î–ê–¢–¨ –ò–ì–†–£ (HOST)</button>
            <p style="color:#888">- –∏–ª–∏ -</p>
            <input id="join-code" placeholder="–í—Å—Ç–∞–≤—å ID –¥—Ä—É–≥–∞" style="width:100%; padding:10px; text-align:center;">
            <button class="btn" onclick="joinGame()">–ü–û–î–ö–õ–Æ–ß–ò–¢–¨–°–Ø</button>
            <div id="status-log" style="color:#0ff; margin-top:15px; font-size:12px;"></div>
            <button class="btn btn-sec" onclick="toMenu()">–û–¢–ú–ï–ù–ê</button>
        </div>
    </div>

    <div id="game-ui" class="screen">
        <div class="top-hud">
            <div>
                <div style="font-size:12px; color:#aaa">–ó–î–û–†–û–í–¨–ï</div>
                <div class="hp-bar"><div class="hp-fill" id="hp-val"></div></div>
            </div>
            <div style="text-align:right">
                <div style="font-size:12px; color:#aaa">–°–ß–ï–¢</div>
                <span id="score-text" style="font-size:20px; font-weight:bold;">0 : 0</span>
            </div>
        </div>
        <div id="crosshair"></div>
        
        <div id="mobile-controls" class="controls">
            <div id="stick-zone" class="touch-btn"><div id="stick-knob"></div></div>
            <div id="btn-shoot" class="touch-btn" style="bottom:80px; right:40px; width:70px; height:70px; background:rgba(255,50,50,0.3);">üî•</div>
            <div id="btn-jump" class="touch-btn" style="bottom:170px; right:20px; width:50px; height:50px;">‚¨ÜÔ∏è</div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <script>
        /* === –ù–ê–°–¢–†–û–ô–ö–ò === */
        const CFG = {
            nick: localStorage.getItem('ps_nick') || 'Soldier',
            skin: localStorage.getItem('ps_skin') || 'classic',
            isMobile: false
        };

        const SKINS = {
            'classic': { color: 0x4caf50, name: '–ö–ª–∞—Å—Å–∏–∫' },
            'blue': { color: 0x2196f3, name: '–°–ø–µ—Ü–Ω–∞–∑' },
            'red': { color: 0xf44336, name: '–ù–∞–µ–º–Ω–∏–∫' },
            'dark': { color: 0x222222, name: '–ù–∏–Ω–¥–∑—è' }
        };

        /* === 1. –ì–ï–ù–ï–†–ê–¢–û–† –¢–ï–ö–°–¢–£–† (–õ–∏—Ü–∞ –∏ –ú–∏—Ä) === */
        function createFaceTexture() {
            const cvs = document.createElement('canvas');
            cvs.width = 128; cvs.height = 128;
            const ctx = cvs.getContext('2d');
            
            // –§–æ–Ω (–∫–æ–∂–∞)
            ctx.fillStyle = '#ffccaa'; 
            ctx.fillRect(0,0,128,128);
            
            // –ì–ª–∞–∑–∞
            ctx.fillStyle = '#000';
            ctx.fillRect(30, 40, 20, 20); // –õ–µ–≤—ã–π
            ctx.fillRect(78, 40, 20, 20); // –ü—Ä–∞–≤—ã–π
            
            // –†–æ—Ç
            ctx.fillRect(40, 90, 48, 10);

            const tex = new THREE.CanvasTexture(cvs);
            tex.magFilter = THREE.NearestFilter; // –ü–∏–∫—Å–µ–ª—å–Ω—ã–π —Å—Ç–∏–ª—å
            return tex;
        }

        function createGridTexture() {
            const cvs = document.createElement('canvas');
            cvs.width = 256; cvs.height = 256;
            const ctx = cvs.getContext('2d');
            ctx.fillStyle = '#111'; ctx.fillRect(0,0,256,256);
            ctx.strokeStyle = '#00ccff'; ctx.lineWidth = 2;
            ctx.strokeRect(0,0,256,256); // –†–∞–º–∫–∞
            ctx.fillStyle = 'rgba(0, 204, 255, 0.1)'; ctx.fillRect(10,10,236,236);
            
            const tex = new THREE.CanvasTexture(cvs);
            tex.wrapS = THREE.RepeatWrapping; tex.wrapT = THREE.RepeatWrapping;
            tex.repeat.set(50, 50);
            return tex;
        }

        /* === 2. –ò–ù–¢–ï–†–§–ï–ô–° === */
        function selectDevice(type) {
            CFG.isMobile = (type === 'MOBILE');
            document.getElementById('device-screen').classList.remove('active');
            document.getElementById('menu-screen').classList.add('active');
            
            if(CFG.isMobile) {
                document.getElementById('mobile-controls').style.display = 'block';
            }
        }

        function openShop() {
            document.getElementById('menu-screen').classList.remove('active');
            document.getElementById('shop-screen').classList.add('active');
            const con = document.getElementById('shop-container');
            con.innerHTML = '';
            for(let k in SKINS) {
                const s = SKINS[k];
                const btn = document.createElement('div');
                btn.className = 'btn btn-sec';
                btn.style.background = (CFG.skin === k) ? 'rgba(0,255,0,0.2)' : '';
                btn.innerHTML = `<div style="width:30px;height:30px;background:#${s.color.toString(16)};margin:0 auto"></div>${s.name}`;
                btn.onclick = () => { CFG.skin = k; localStorage.setItem('ps_skin', k); openShop(); };
                con.appendChild(btn);
            }
        }
        function toMenu() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('menu-screen').classList.add('active');
        }
        function openLobby() {
            CFG.nick = document.getElementById('nick-input').value || 'Soldier';
            localStorage.setItem('ps_nick', CFG.nick);
            document.getElementById('menu-screen').classList.remove('active');
            document.getElementById('lobby-screen').classList.add('active');
        }

        /* === 3. –ò–ì–†–û–í–û–ô –ú–ò–† (THREE.JS) === */
        let scene, camera, renderer, clock;
        let myMesh, enemyMesh;
        let peer, conn, myId;
        let input = { x:0, y:0, jump:0, shoot:0 };

        function init3D() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('game-ui').classList.add('active');

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x050a10);
            scene.fog = new THREE.Fog(0x050a10, 10, 60);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({antialias: true});
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);
            clock = new THREE.Clock();

            // === –£–õ–£–ß–®–ï–ù–ù–´–ô –ú–ò–† ===
            // –°–≤–µ—Ç
            const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6);
            scene.add(hemi);
            const sun = new THREE.DirectionalLight(0xffffff, 0.8);
            sun.position.set(20, 50, 20); sun.castShadow = true;
            scene.add(sun);

            // –ü–æ–ª —Å —Ç–µ–∫—Å—Ç—É—Ä–æ–π —Å–µ—Ç–∫–∏
            const gridTex = createGridTexture();
            const floor = new THREE.Mesh(
                new THREE.PlaneGeometry(200, 200), 
                new THREE.MeshPhongMaterial({ map: gridTex })
            );
            floor.rotation.x = -Math.PI/2;
            floor.receiveShadow = true;
            scene.add(floor);

            // –î–µ–∫–æ—Ä–∞—Ü–∏–∏ (–î–µ—Ä–µ–≤—å—è/–ö–æ–ª–æ–Ω–Ω—ã)
            const pillarGeo = new THREE.CylinderGeometry(1, 1, 6, 8);
            const pillarMat = new THREE.MeshPhongMaterial({ color: 0x334455 });
            for(let i=0; i<15; i++) {
                const m = new THREE.Mesh(pillarGeo, pillarMat);
                m.position.set(Math.random()*60-30, 3, Math.random()*60-30);
                m.castShadow = true; scene.add(m);
            }

            // –ò–≥—Ä–æ–∫ (–í—Ä–∞–≥)
            enemyMesh = createPlayer();
            scene.add(enemyMesh);
            enemyMesh.position.y = -100; // –°–ø—Ä—è—Ç–∞—Ç—å –¥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

            camera.position.set(0, 1.7, 0);

            if(CFG.isMobile) setupMobile();
            else setupPC();

            animate();
        }

        function createPlayer() {
            const root = new THREE.Group();
            const color = SKINS['classic'].color; // –î–µ—Ñ–æ–ª—Ç–Ω—ã–π
            const mat = new THREE.MeshPhongMaterial({ color: color });
            
            // –¢–µ–ª–æ
            const body = new THREE.Mesh(new THREE.BoxGeometry(0.6, 0.8, 0.4), mat);
            body.position.y = 0.9; root.add(body);
            
            // –ì–û–õ–û–í–ê –° –õ–ò–¶–û–ú
            const faceTex = createFaceTexture();
            const headMat = [
                new THREE.MeshPhongMaterial({color: 0xffccaa}), // –ø—Ä–∞–≤–æ
                new THREE.MeshPhongMaterial({color: 0xffccaa}), // –ª–µ–≤–æ
                new THREE.MeshPhongMaterial({color: 0xffccaa}), // –≤–µ—Ä—Ö
                new THREE.MeshPhongMaterial({color: 0xffccaa}), // –Ω–∏–∑
                new THREE.MeshPhongMaterial({map: faceTex}),    // –õ–ò–¶–û (–ü–µ—Ä–µ–¥)
                new THREE.MeshPhongMaterial({color: 0xffccaa})  // –∑–∞–¥
            ];
            const head = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.4, 0.4), headMat);
            head.position.y = 1.6; root.add(head);

            // –†—É–∫–∏
            const arm = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.7, 0.2), mat);
            arm.position.set(0.4, 0.9, 0); root.add(arm);
            const arm2 = arm.clone(); arm2.position.set(-0.4, 0.9, 0); root.add(arm2);

            return root;
        }

        /* === 4. –°–ï–¢–¨ (P2P) === */
        function hostGame() {
            peer = new Peer();
            peer.on('open', id => {
                document.getElementById('status-log').innerHTML = `–¢–≤–æ–π –∫–æ–¥: <b style="font-size:16px; color:white">${id}</b>`;
            });
            peer.on('connection', c => { conn = c; startNet(); });
        }
        function joinGame() {
            const id = document.getElementById('join-code').value;
            if(!id) return;
            peer = new Peer();
            peer.on('open', () => { conn = peer.connect(id); startNet(); });
        }

        function startNet() {
            document.getElementById('status-log').innerText = "–ü–û–î–ö–õ–Æ–ß–ï–ù–û!";
            setTimeout(() => {
                init3D();
                // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –º–æ–π —Å–∫–∏–Ω
                conn.send({ type: 'init', skin: CFG.skin, nick: CFG.nick });
            }, 1000);

            conn.on('data', d => {
                if(d.type === 'init') {
                    // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–∫–∏–Ω –≤—Ä–∞–≥–∞
                    const s = SKINS[d.skin];
                    enemyMesh.children[0].material.color.setHex(s.color); // –¢–µ–ª–æ
                    enemyMesh.children[2].material.color.setHex(s.color); // –†—É–∫–∏
                }
                if(d.type === 'move') {
                    enemyMesh.position.set(d.x, d.y, d.z);
                    enemyMesh.rotation.y = d.ry;
                }
            });
        }

        /* === 5. –§–ò–ó–ò–ö–ê –ò –¶–ò–ö–õ === */
        let velY = 0;
        let canJump = false;

        function animate() {
            requestAnimationFrame(animate);
            const dt = clock.getDelta();

            // –î–≤–∏–∂–µ–Ω–∏–µ
            const speed = 6;
            const dir = new THREE.Vector3();
            const fwd = new THREE.Vector3(0,0,-1).applyEuler(new THREE.Euler(0, camera.rotation.y, 0));
            const side = new THREE.Vector3(1,0,0).applyEuler(new THREE.Euler(0, camera.rotation.y, 0));

            if(input.y < 0) dir.add(fwd); if(input.y > 0) dir.sub(fwd);
            if(input.x < 0) dir.sub(side); if(input.x > 0) dir.add(side);

            camera.position.add(dir.normalize().multiplyScalar(speed * dt));

            // –ü—Ä—ã–∂–æ–∫/–ì—Ä–∞–≤–∏—Ç–∞—Ü–∏—è
            if(input.jump && canJump) { velY = 10; canJump = false; input.jump = false; }
            velY -= 25 * dt;
            camera.position.y += velY * dt;

            if(camera.position.y < 1.7) { camera.position.y = 1.7; velY = 0; canJump = true; }

            // –°–µ—Ç—å
            if(conn && conn.open) {
                conn.send({
                    type: 'move',
                    x: camera.position.x, 
                    y: camera.position.y - 1.7, // –ö–æ—Ä—Ä–µ–∫—Ü–∏—è –º–æ–¥–µ–ª–∏
                    z: camera.position.z,
                    ry: camera.rotation.y + Math.PI // –†–∞–∑–≤–æ—Ä–æ—Ç –ª–∏—Ü–∞
                });
            }

            renderer.render(scene, camera);
        }

        /* === 6. –£–ü–†–ê–í–õ–ï–ù–ò–ï === */
        function setupPC() {
            document.body.onclick = () => document.body.requestPointerLock();
            document.addEventListener('mousemove', e => {
                if(document.pointerLockElement) {
                    camera.rotation.y -= e.movementX * 0.002;
                    camera.rotation.x -= e.movementY * 0.002;
                }
            });
            document.addEventListener('keydown', e => {
                if(e.code=='KeyW') input.y=-1; if(e.code=='KeyS') input.y=1;
                if(e.code=='KeyA') input.x=-1; if(e.code=='KeyD') input.x=1;
                if(e.code=='Space') input.jump=true;
            });
            document.addEventListener('keyup', e => {
                if(['KeyW','KeyS'].includes(e.code)) input.y=0;
                if(['KeyA','KeyD'].includes(e.code)) input.x=0;
            });
        }

        function setupMobile() {
            const stick = document.getElementById('stick-zone');
            const knob = document.getElementById('stick-knob');
            let startT;

            stick.addEventListener('touchstart', e => startT = e.changedTouches[0]);
            stick.addEventListener('touchmove', e => {
                e.preventDefault();
                const t = e.changedTouches[0];
                let dx = t.clientX - startT.clientX;
                let dy = t.clientY - startT.clientY;
                if(Math.sqrt(dx*dx+dy*dy) > 40) { dx*=0.8; dy*=0.8; } // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ
                knob.style.transform = `translate(${dx}px, ${dy}px)`;
                input.x = dx/40; input.y = dy/40;
            });
            stick.addEventListener('touchend', () => { knob.style.transform=''; input.x=0; input.y=0; });

            // –ö–∞–º–µ—Ä–∞
            let lastX;
            document.addEventListener('touchstart', e => { if(e.touches[0].clientX > window.innerWidth/2) lastX = e.touches[0].clientX; });
            document.addEventListener('touchmove', e => {
                const t = e.touches[0];
                if(t.clientX > window.innerWidth/2) {
                    camera.rotation.y -= (t.clientX - lastX) * 0.005;
                    lastX = t.clientX;
                }
            });
            document.getElementById('btn-jump').addEventListener('touchstart', (e)=>{ e.preventDefault(); input.jump=true; });
        }
    </script>
</body>
</html>
