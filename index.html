<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tactical Shooter: FIXED MULTI & UI</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body {
            margin: 0; overflow: hidden; background-color: #1a1a2e;
            font-family: 'Courier New', Courier, monospace;
            color: white; user-select: none; -webkit-user-select: none; touch-action: none;
        }
        canvas { display: block; }
        
        /* --- PC UI (DEFAULT - COMPACT) --- */
        #game-ui {
            display: none; position: absolute; top: 10px; left: 10px; pointer-events: none;
            width: 100%; box-sizing: border-box; padding-right: 20px; z-index: 5;
        }
        #top-bar { display: flex; justify-content: space-between; align-items: flex-start; }
        
        .stat-box {
            background: rgba(0,0,0,0.6); padding: 5px 10px; border-radius: 4px;
            margin-bottom: 5px; font-size: 14px; border: 1px solid rgba(255,255,255,0.2);
        }
        
        /* –ú–µ–Ω—é - –ü–ö —Å—Ç–∏–ª—å (–º–∞–ª–µ–Ω—å–∫—ñ –∫–Ω–æ–ø–∫–∏) */
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 20, 40, 0.95); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 20;
        }
        h1 { margin-bottom: 10px; font-size: 24px; color: #00AAFF; text-align: center; text-transform: uppercase; text-shadow: 0 0 10px white; }
        
        .mission-grid { 
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; 
            margin-bottom: 10px; max-height: 60vh; overflow-y: auto; width: 600px;
        }

        .btn {
            background: #222; color: white; border: 1px solid #0077FF; padding: 6px 10px;
            font-size: 12px; cursor: pointer; text-align: center; font-family: inherit; margin: 2px;
            display: flex; align-items: center; justify-content: center; transition: all 0.2s;
        }
        .btn:hover { background: #0077FF; color: black; transform: scale(1.05); }
        
        /* –í–µ–ª–∏–∫—ñ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –Ω–∞ –ü–ö (–ú–∞–≥–∞–∑–∏–Ω, –ú—É–ª—å—Ç–∏–ø–ª–µ—î—Ä) */
        .big-menu-btn { width: 400px; font-size: 14px; padding: 8px; margin-top: 5px; }

        .boss-btn { border-color: #A020F0; color: #E0E0E0; }
        .hard-btn { border-color: #FF3333; color: #FFAAAA; }
        .special-btn { border-color: #00FFCC; color: #AAFFFF; }
        .shop-btn { border-color: #FFFF00; color: #FFFFAA; font-weight: bold;}
        .multi-btn { border-color: #FF00FF; color: #FFAAFF; }

        /* SHOP PC */
        #shop-screen { display: none; }
        .shop-container { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; }
        .shop-column { background: #223; padding: 10px; border: 1px solid #558; width: 220px; }
        .shop-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; border-bottom: 1px solid #444; padding-bottom: 2px; font-size: 11px; }
        .buy-btn { background: #222; border: 1px solid #FFFF00; color: #FFFF00; padding: 2px 5px; cursor: pointer; font-size: 10px; }

        /* --- MOBILE MODE OVERRIDES (BIG UI) --- */
        body.mobile-mode .btn { padding: 15px; font-size: 16px; width: 100%; border-width: 2px; }
        body.mobile-mode .mission-grid { grid-template-columns: 1fr 1fr; width: 95%; gap: 10px; }
        body.mobile-mode .big-menu-btn { width: 90%; font-size: 18px; padding: 15px; }
        body.mobile-mode .shop-container { flex-direction: column; align-items: center; width: 100%; padding-bottom: 80px; }
        body.mobile-mode .shop-column { width: 90%; margin-bottom: 10px; }
        body.mobile-mode .shop-item { font-size: 14px; padding: 10px 0; }
        body.mobile-mode .buy-btn { padding: 8px 15px; font-size: 12px; }
        body.mobile-mode h1 { font-size: 28px; margin-bottom: 20px; }
        
        /* Mobile Controls (Only visible in mobile mode) */
        #mobile-controls { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .joystick-zone { position: absolute; bottom: 40px; width: 90px; height: 90px; background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 50%; pointer-events: auto; }
        #stick-left { left: 20px; }
        #stick-right { right: 20px; }
        .joystick-knob { position: absolute; top: 50%; left: 50%; width: 40px; height: 40px; background: rgba(0, 119, 255, 0.5); border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; }
        #stick-right .joystick-knob { background: rgba(255, 51, 51, 0.5); }
        #mobile-grenade-btn { position: absolute; bottom: 100px; right: 130px; width: 50px; height: 50px; background: rgba(255, 165, 0, 0.3); border: 2px solid #FFA500; border-radius: 50%; color: #FFA500; font-size: 20px; display: flex; justify-content: center; align-items: center; pointer-events: auto; cursor: pointer; }
        #weapon-bar { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; pointer-events: auto; }
        .wpn-btn { width: 35px; height: 35px; background: #333; border: 1px solid #666; color: white; font-size: 9px; font-weight: bold; display: flex; justify-content: center; align-items: center; border-radius: 5px; font-family: inherit; cursor: pointer; }
        .wpn-btn.active { border-color: #0077FF; background: #004488; }
        
        /* Bars */
        .bar-container { width: 200px; height: 15px; background: #444; border: 1px solid #fff; position: relative; margin-top: 2px; }
        #health-fill { width: 100%; height: 100%; background: #00FF00; }
        #xp-bar-container { height: 8px; border-color: #0077FF; }
        #xp-fill { width: 0%; height: 100%; background: #0077FF; }

        /* Other UI */
        #dev-menu { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #200020; border: 3px solid #FF00FF; padding: 20px; z-index: 2000; width: 300px; text-align: center; }
        .dev-btn { width: 100%; margin: 5px 0; background: #400040; border: 1px solid #FF00FF; color: white; padding: 10px; cursor: pointer; }

        #multiplayer-screen { display: none; z-index: 28; }
        .server-box { background: #001122; border: 2px solid #FF00FF; padding: 20px; width: 90%; max-width: 500px; text-align: center; }
        #my-peer-id { color: yellow; font-size: 20px; border: 1px dashed #555; padding: 5px; margin: 10px 0; user-select: text; cursor: pointer;}
        #join-peer-id { background: #333; color: white; padding: 10px; border: 1px solid #555; width: 200px; margin-top: 10px; }

        #editor-ui { display: none; position: absolute; bottom: 10px; left: 10px; z-index: 50; display: flex; gap: 5px; }
        .tool-btn { width: 40px; height: 40px; background: #333; border: 1px solid #fff; font-size: 18px; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        .tool-btn.active { background: #0077FF; border-color: #00FFFF; }

        #levelup-notify { position: absolute; top: 30%; left: 50%; transform: translate(-50%, -50%); font-size: 40px; color: #FFD700; font-weight: bold; pointer-events: none; opacity: 0; transition: opacity 0.5s; z-index: 100; text-align: center; text-shadow: 0 0 10px black;}
    </style>
</head>
<body>

    <div id="dev-menu">
        <h2>üõ†Ô∏è DEV MENU</h2>
        <button class="dev-btn" onclick="devAction('coins')">+10,000 COINS</button>
        <button class="dev-btn" onclick="devAction('level')">+10 LEVELS</button>
        <button class="dev-btn" onclick="devAction('unlock')">UNLOCK ALL</button>
        <button class="dev-btn" onclick="devAction('god')">TOGGLE GODMODE</button>
        <button class="dev-btn" onclick="document.getElementById('dev-menu').style.display='none'" style="border-color: red;">CLOSE</button>
    </div>

    <div id="platform-screen" class="overlay" style="z-index: 30;">
        <h1>Tactical Shooter<br>‚ùÑÔ∏è New Year ‚ùÑÔ∏è</h1>
        <h2>–û–±–µ—Ä—ñ—Ç—å –∫–µ—Ä—É–≤–∞–Ω–Ω—è / Choose Control</h2>
        <button class="btn" style="width: 200px; padding: 15px; font-size: 16px;" onclick="selectPlatform('PC')">üíª PC (Mouse/Keys)</button>
        <button class="btn" style="width: 200px; padding: 15px; font-size: 16px;" onclick="selectPlatform('MOBILE')">üì± Mobile (Touch)</button>
    </div>

    <div id="editor-ui">
        <div class="tool-btn" id="tool-wall" onclick="setEditorTool(1)">‚¨ú</div>
        <div class="tool-btn" id="tool-spawn" onclick="setEditorTool(2)">üëæ</div>
        <div class="tool-btn" id="tool-erase" onclick="setEditorTool(0)">‚ùå</div>
        <div class="tool-btn" onclick="saveCustomMap()" style="font-size:10px;">SAVE</div>
        <div class="tool-btn" onclick="exitEditor()" style="font-size:10px; color:red;">EXIT</div>
    </div>

    <div id="multiplayer-screen" class="overlay">
        <h1>ONLINE MULTIPLAYER</h1>
        <div class="server-box">
            <h3 style="color:white">–¢–≤—ñ–π ID (–ù–∞–¥—ñ—à–ª–∏ –¥—Ä—É–≥—É):</h3>
            <div id="my-peer-id" onclick="copyId()">Loading...</div>
            <div id="mp-status" style="color:#00FF00; margin:10px 0; font-weight:bold;">Connecting to global server...</div>
            <hr style="border-color:#444">
            <h3 style="color:white">–ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è –¥–æ –¥—Ä—É–≥–∞:</h3>
            <input type="text" id="join-peer-id" placeholder="–í–≤–µ–¥–∏ ID –¥—Ä—É–≥–∞ —Ç—É—Ç">
            <button class="btn big-menu-btn" onclick="joinPeerGame()" style="background:#004400; width: 100%;">CONNECT & PLAY</button>
        </div>
        <button class="btn big-menu-btn" onclick="closeMultiplayer()" style="margin-top:20px; border-color:red;">BACK</button>
    </div>

    <div id="shop-screen" class="overlay" style="z-index: 25; display: none; overflow-y: auto;">
        <h1>–ú–ê–ì–ê–ó–ò–ù</h1>
        <div style="color: yellow; margin-bottom: 5px; font-size: 14px;">üí∞: <span id="shop-coins">0</span> | LVL: <span id="shop-level">1</span></div>
        <div class="shop-container">
            <div class="shop-column" style="display:flex; flex-direction:column; align-items:center;">
                <h3 id="lbl-look">–í–ò–ì–õ–Ø–î</h3>
                <canvas id="previewCanvas" width="120" height="120" style="border: 2px solid #555; background: #222; margin-bottom: 5px;"></canvas>
                <input type="color" id="colorPicker" value="#0077FF" onchange="updatePreview()">
                <div style="font-size:10px; color:#aaa; margin-top:5px;">–®–æ–ª–æ–º/–ñ–∏–ª–µ—Ç –¥–∞—é—Ç—å HP!</div>
            </div>
            <div class="shop-column">
                <h3 id="lbl-acc">–ê–ö–°–ï–°–£–ê–†–ò</h3>
                <div id="accessories-list"></div>
            </div>
            <div class="shop-column">
                <h3 id="lbl-wpn">–ó–ë–†–û–Ø</h3>
                <div id="weapons-list"></div>
                <div style="margin-top:10px; text-align:center;">
                    <input type="text" id="promo-input" placeholder="–ö–û–î" style="width:80px;">
                    <button class="btn" style="display:inline-block; width:auto; padding:2px 5px;" onclick="redeemCode()">OK</button>
                </div>
            </div>
        </div>
        <button class="btn big-menu-btn" onclick="closeShop()" style="position:fixed; bottom:10px; z-index:30;">EXIT</button>
    </div>

    <div id="menu-overlay" class="overlay" style="display: none;">
        <h1 id="menu-title">–ú–ï–ù–Æ –ú–Ü–°–Ü–ô</h1>
        <div class="menu-stats">
            LVL: <span id="menu-level">1</span> | XP: <span id="menu-xp">0</span> | üí∞: <span id="menu-coins">0</span>
        </div>
        
        <div id="menu-buttons" class="mission-grid">
            <button class="btn" onclick="startMission(1)">1: –û–∫–æ–ø</button>
            <button class="btn" onclick="startMission(2)">2: –ó–∞—á–∏—Å—Ç–∫–∞</button>
            <button class="btn boss-btn" onclick="startMission(3)">3: –ë–û–°</button>
            <button class="btn" onclick="startMission(4)">4: –û–†–î–ê</button>
            <button class="btn" onclick="startMission(5)">5: –ú'–Ø–°–û</button>
            <button class="btn hard-btn" onclick="startMission(6)">6: –•–ê–†–î</button>
            <button class="btn" onclick="startMission(7)">7: –ü–Ü–î–†–ò–í</button>
            <button class="btn hard-btn" onclick="startMission(8)">8: –ó–û–ú–ë–Ü</button>
            <button class="btn special-btn" onclick="startMission(9)">9: –ó–ê–•–í–ê–¢</button>
            <button class="btn special-btn" onclick="startMission(10)">10: –ù–Ü–ß</button>
            <button class="btn special-btn" onclick="startMission(11)">11: –°–ù–ê–ô–ü–ï–†</button>
            <button class="btn special-btn" onclick="startMission(13)">13: BAZOOKA</button>
            <button class="btn hard-btn" onclick="startMission(14)">14: –û–ë–û–†–û–ù–ê</button>
            <button class="btn boss-btn" onclick="startMission(15)">15: DUAL BOSS</button>
            <button class="btn" style="border-color: #00FF00; color: #AAFFAA;" onclick="startTraining()">–¢–†–ï–ù–£–í–ê–ù–ù–Ø</button>
        </div>
        <button class="btn multi-btn big-menu-btn" onclick="openMultiplayer()">üåê –û–ù–õ–ê–ô–ù (BETA)</button>
        <button class="btn big-menu-btn" style="border-color: #00FFFF; color: #AAFFFF;" onclick="playCustomMap()">üó∫Ô∏è CUSTOM MAP</button>
        <button class="btn shop-btn big-menu-btn" onclick="openShop()">üõí –ú–ê–ì–ê–ó–ò–ù</button>
        <button class="btn editor-btn big-menu-btn" onclick="openEditor()">üõ†Ô∏è –†–ï–î–ê–ö–¢–û–† –ö–ê–†–¢</button>
        <button id="end-game-btn" class="btn big-menu-btn" onclick="showMainMenu()" style="display:none; background: #FF3333; margin-top: 20px;">–í –ì–û–õ–û–í–ù–ï –ú–ï–ù–Æ</button>
    </div>

    <div id="game-ui">
        <div id="top-bar">
            <div>
                <div id="mission-text">–¶—ñ–ª—å...</div>
                <div class="bar-container" id="health-bar"><div id="health-fill"></div></div>
                <div class="bar-container" id="xp-bar-container">
                    <div id="level-text">L1</div>
                    <div id="xp-fill"></div>
                </div>
                <div class="stat-box" id="weapon-info" style="margin-top: 5px;">–ó–±—Ä–æ—è</div>
            </div>
            <div style="text-align: right;">
                <div class="stat-box" id="stats">–ß–∞—Å: 0.0</div>
                <div class="stat-box" id="grenade-counter">üí£: 3</div>
                <div class="stat-box" id="coin-counter">üí∞: 0</div>
            </div>
        </div>
    </div>
    
    <div id="levelup-notify">–ù–û–í–ò–ô –†–Ü–í–ï–ù–¨!<br><span style="font-size:20px; color:white;">HP Full!</span></div>

    <div id="mobile-controls">
        <div id="stick-left" class="joystick-zone"><div class="joystick-knob" id="knob-left"></div></div>
        <div id="stick-right" class="joystick-zone"><div class="joystick-knob" id="knob-right"></div></div>
        <div id="mobile-grenade-btn" onclick="throwGrenadeMobile()">üí£</div>
        <div id="weapon-bar"></div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        // --- GAME SYSTEM ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resize); resize();

        let playerStats = { totalKills: 0, coins: 0, color: '#0077FF', xp: 0, level: 1, nextLevelXp: 100, unlockedWeapons: ['pistol', 'rifle', 'shotgun', 'sniper'], unlockedOutfits: ['none'], currentOutfit: 'none', redeemedCodes: [], godMode: false };
        let customMap = { walls: [], spawns: [] };
        let controlMode = 'PC'; let gameState = 'PLATFORM_SELECT'; let currentMissionId = 0;
        let gameTime = 0; let enemiesKilled = 0; let grenadesKilled = 0; let bossSpawned = false;
        let zoneTimer = 0; let captureZone = { x: 0, y: 0, radius: 100 }; let screenShake = 0;
        let obstacles = []; let bullets = []; let enemies = []; let particles = []; let drops = []; let thrownGrenades = []; let decorations = []; let snowflakes = []; let player; 
        let remotePlayers = {}; 
        let keys = {}; let mouse = { x: 0, y: 0, down: false };
        let joystickLeft = { x: 0, y: 0, active: false, id: null }; let joystickRight = { x: 0, y: 0, active: false, id: null }; let lastAimAngle = 0;
        
        // --- MULTIPLAYER VARS ---
        let peer = null;
        let connections = [];
        let myPeerId = null;
        let isHost = false; // HOST SPAWNS ENEMIES

        // --- PLATFORM & UI ---
        function selectPlatform(mode) {
            controlMode = mode;
            document.getElementById('platform-screen').style.display = 'none';
            if(mode === 'MOBILE') {
                document.body.classList.add('mobile-mode');
                document.getElementById('mobile-controls').style.display='block';
                document.getElementById('weapon-info').style.display='none';
            } else {
                document.body.classList.remove('mobile-mode');
                document.getElementById('mobile-controls').style.display='none';
                document.getElementById('weapon-info').style.display='block';
            }
            loadGame(); showMainMenu(); setupMobileWeapons();
        }

        // --- DATA ---
        function getNextLevelXp(lvl) { return Math.floor(100 * Math.pow(1.2, lvl - 1)); }
        function levelUp() { playerStats.xp -= playerStats.nextLevelXp; playerStats.level++; playerStats.nextLevelXp = getNextLevelXp(playerStats.level); playerStats.coins += 50 * playerStats.level; if (player) player.hp = player.maxHp; showLevelUpEffect(); saveGame(); }
        function showLevelUpEffect() { const el = document.getElementById('levelup-notify'); el.style.opacity = 1; el.style.top = '40%'; setTimeout(() => { el.style.opacity = 0; el.style.top = '30%'; }, 2000); }
        function loadGame() {
            let saved = localStorage.getItem('tacticalShooterData_v6');
            if (saved) { 
                let parsed = JSON.parse(saved); 
                playerStats = { ...playerStats, ...parsed.stats }; 
                if(parsed.map) customMap = parsed.map;
                playerStats.nextLevelXp = getNextLevelXp(playerStats.level); 
                if(!playerStats.redeemedCodes) playerStats.redeemedCodes = []; 
            }
            updateMenuStats();
        }
        function saveGame() { localStorage.setItem('tacticalShooterData_v6', JSON.stringify({stats: playerStats, map: customMap})); updateMenuStats(); }
        function updateMenuStats() { document.getElementById('menu-coins').innerText = playerStats.coins; document.getElementById('menu-level').innerText = playerStats.level; document.getElementById('menu-xp').innerText = `${Math.floor(playerStats.xp)}/${playerStats.nextLevelXp}`; }

        // --- NETWORKING (P2P) ---
        function openMultiplayer() {
            document.getElementById('menu-overlay').style.display = 'none';
            document.getElementById('multiplayer-screen').style.display = 'flex';
            if(!peer) initPeer();
        }
        function closeMultiplayer() {
            document.getElementById('multiplayer-screen').style.display = 'none';
            document.getElementById('menu-overlay').style.display = 'flex';
        }
        function initPeer() {
            peer = new Peer();
            peer.on('open', (id) => {
                myPeerId = id;
                document.getElementById('my-peer-id').innerText = id;
                document.getElementById('mp-status').innerText = "Online. Waiting for players...";
                // By default, if I opened the menu and created the ID first, assume I can be host
                isHost = true; 
            });
            peer.on('connection', (conn) => {
                // Someone connected to ME. I am the HOST.
                isHost = true;
                setupConnection(conn);
                alert("Player Joined! You are HOST.");
            });
        }
        function copyId() { navigator.clipboard.writeText(myPeerId).then(()=>alert("ID copied!")); }
        function joinPeerGame() {
            let id = document.getElementById('join-peer-id').value.trim();
            if(!id) return;
            document.getElementById('mp-status').innerText = "Connecting to " + id + "...";
            let conn = peer.connect(id);
            // I am connecting to someone else. I am CLIENT.
            isHost = false; 
            setupConnection(conn);
        }
        function setupConnection(conn) {
            conn.on('open', () => {
                connections.push(conn);
                document.getElementById('mp-status').innerText = "CONNECTED!";
                startMission('ONLINE');
            });
            conn.on('data', (data) => { handleNetworkData(data); });
            conn.on('close', () => { alert("Connection Lost"); connections = connections.filter(c => c !== conn); });
        }
        function sendNetworkData(data) { connections.forEach(c => c.send(data)); }
        function handleNetworkData(data) {
            if(data.type === 'move') {
                remotePlayers[data.id] = data; 
                remotePlayers[data.id].lastUpdate = Date.now();
            } else if(data.type === 'shoot') {
                bullets.push(new Bullet(data.x, data.y, data.vel, false, data.dmg, 4, data.wType));
            } else if(data.type === 'spawnEnemy' && !isHost) {
                // CLIENT SPAWNS ENEMY COMMANDED BY HOST
                enemies.push(new Enemy(data.x, data.y, data.kind));
            }
        }

        // --- GAME CLASSES ---
        class Entity { constructor(x, y, radius, color, hp) { this.x=x; this.y=y; this.radius=radius; this.color=color; this.hp=hp; this.maxHp=hp; this.dead=false; this.cooldown=0; } move(dx, dy) { if (!this.checkWallCollision(this.x+dx, this.y)) this.x+=dx; if (!this.checkWallCollision(this.x, this.y+dy)) this.y+=dy; this.x=Math.max(this.radius, Math.min(canvas.width-this.radius, this.x)); this.y=Math.max(this.radius, Math.min(canvas.height-this.radius, this.y)); } checkWallCollision(x, y) { for (let obs of obstacles) { let cx=Math.max(obs.x, Math.min(x, obs.x+obs.size)); let cy=Math.max(obs.y, Math.min(y, obs.y+obs.size)); if ((x-cx)**2 + (y-cy)**2 < this.radius**2) return true; } return false; } }
        class Rect { constructor(x, y, size) { this.x = x; this.y = y; this.size = size; } draw() { ctx.fillStyle = '#556'; ctx.fillRect(this.x, this.y, this.size, this.size); ctx.strokeStyle='#223'; ctx.strokeRect(this.x, this.y, this.size, this.size); } }
        class Player extends Entity { 
            constructor(x, y) { 
                let hp = 100;
                if(playerStats.currentOutfit === 'helmet') hp += 50; if(playerStats.currentOutfit === 'vest') hp += 100; if(playerStats.currentOutfit === 'full_armor') hp += 250;
                super(x, y, 15, playerStats.color, hp); 
                this.weapon='pistol'; this.grenades=3; this.grenadeCooldown=0; this.angle=0; 
            }
            draw() { ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.angle); ctx.beginPath(); ctx.arc(0, 0, this.radius, 0, Math.PI*2); ctx.fillStyle=playerStats.color; ctx.fill(); ctx.stroke(); ctx.fillStyle='#000'; ctx.fillRect(10,-3,15,6); ctx.restore(); }
            update() { 
                if (this.cooldown > 0) this.cooldown--; if (this.grenadeCooldown > 0) this.grenadeCooldown--; if (playerStats.godMode) this.hp = this.maxHp;
                let dx=0, dy=0; 
                if (controlMode === 'PC') { 
                    if (keys['Digit1']) this.trySetWeapon('pistol'); if (keys['Digit2']) this.trySetWeapon('rifle'); if (keys['Digit3']) this.trySetWeapon('shotgun'); if (keys['Digit4']) this.trySetWeapon('sniper'); if (keys['Digit5']) this.trySetWeapon('minigun'); if (keys['Digit6']) this.trySetWeapon('snowball'); if (keys['Digit7']) this.trySetWeapon('bazooka'); if (keys['Digit8']) this.trySetWeapon('laser');
                    if (keys['Space']) this.throwGrenade(mouse.x, mouse.y); 
                    if (keys['KeyW'] || keys['ArrowUp']) dy = -4.5; if (keys['KeyS'] || keys['ArrowDown']) dy = 4.5; if (keys['KeyA'] || keys['ArrowLeft']) dx = -4.5; if (keys['KeyD'] || keys['ArrowRight']) dx = 4.5; 
                    this.angle = Math.atan2(mouse.y-this.y, mouse.x-this.x); lastAimAngle=this.angle; if (mouse.down) this.shootInput(this.angle);
                } else { 
                    if (joystickLeft.active) { dx = joystickLeft.x * 4.5; dy = joystickLeft.y * 4.5; } 
                    if (joystickRight.active) { this.angle = Math.atan2(joystickRight.y, joystickRight.x); lastAimAngle=this.angle; this.shootInput(this.angle); } else if (dx || dy) { this.angle = Math.atan2(dy, dx); } 
                } 
                this.move(dx, dy); 
                if(currentMissionId === 'ONLINE' && myPeerId) sendNetworkData({id: myPeerId, type: 'move', x: this.x, y: this.y, angle: this.angle, color: playerStats.color});
            }
            trySetWeapon(wpn) { if ((['minigun','bazooka','laser'].includes(wpn) && !playerStats.unlockedWeapons.includes(wpn))) return; if (playerStats.unlockedWeapons.includes(wpn)) { this.weapon = wpn; updateUI(); } }
            throwGrenade(tx, ty) { if (this.grenades > 0 && this.grenadeCooldown <= 0) { this.grenades--; this.grenadeCooldown=60; thrownGrenades.push(new GrenadeObj(this.x, this.y, tx, ty)); updateUI(); } } 
            shootInput(angle) { if(this.cooldown>0)return; let dmg=20, cd=20, sp=14, type='normal'; if(this.weapon==='rifle'){dmg=10;cd=6;} if(this.weapon==='shotgun'){this.spawnBullet(angle,0,15,45);this.spawnBullet(angle+0.15,0,15,45);this.spawnBullet(angle-0.15,0,15,45);return;} if(this.weapon==='sniper'){dmg=100;cd=60;sp=25;} if(this.weapon==='minigun'){dmg=8;cd=3;} if(this.weapon==='snowball'){dmg=10000;cd=30;type='snowball';} if(this.weapon==='bazooka'){dmg=200;cd=100;type='rocket';} if(this.weapon==='laser'){dmg=50;cd=10;sp=30;type='laser';} this.spawnBullet(angle,(this.weapon==='rifle'?Math.random()-0.5:0)*0.2, dmg, cd, sp, type); }
            spawnBullet(angle, spread, dmg, cd, speed, type) { 
                const vel = {x:Math.cos(angle+spread)*speed, y:Math.sin(angle+spread)*speed}; 
                bullets.push(new Bullet(this.x, this.y, vel, false, dmg, 4, type)); this.cooldown=cd;
                if(currentMissionId === 'ONLINE' && myPeerId) sendNetworkData({id: myPeerId, type: 'shoot', x: this.x, y: this.y, vel: vel, dmg: dmg, wType: type});
            }
        }
        class Enemy extends Entity { 
            constructor(x, y, type) { 
                let hp=40, c='#F33', s=1.5; if(type==='boss'){hp=600;c='#A0F';} if(type==='tank'){hp=200;c='#040';s=0.8;}
                super(x, y, type==='boss'?40:(type==='tank'?25:15), c, hp); this.type=type; this.speed=s;
            }
            draw() { ctx.save(); ctx.translate(this.x, this.y); ctx.beginPath(); ctx.arc(0,0,this.radius,0,Math.PI*2); ctx.fillStyle=this.color; ctx.fill(); ctx.stroke(); ctx.restore(); if(this.hp<this.maxHp){ctx.fillStyle='red';ctx.fillRect(this.x-15,this.y-this.radius-10,30,4);ctx.fillStyle='#0F0';ctx.fillRect(this.x-15,this.y-this.radius-10,30*(this.hp/this.maxHp),4);} }
            update() { 
                const dist=Math.hypot(player.x-this.x, player.y-this.y); const angle=Math.atan2(player.y-this.y, player.x-this.x);
                if(dist>this.radius+10) this.move(Math.cos(angle)*this.speed, Math.sin(angle)*this.speed);
            }
            takeDamage(amt) { this.hp-=amt; if(this.hp<=0 && !this.dead) { this.dead=true; playerStats.totalKills++; playerStats.xp+=10; if(playerStats.xp>=playerStats.nextLevelXp) levelUp(); updateUI(); } }
        }
        class Bullet { constructor(x,y,vel,isEnemy,dmg,r,type){this.x=x;this.y=y;this.vel=vel;this.isEnemy=isEnemy;this.dmg=dmg;this.radius=r;this.type=type;this.dead=false;} update(){this.x+=this.vel.x;this.y+=this.vel.y; if(this.x<0||this.x>canvas.width||this.y<0||this.y>canvas.height)this.dead=true;} draw(){ctx.beginPath();ctx.arc(this.x,this.y,this.radius,0,Math.PI*2);ctx.fillStyle=this.type==='laser'?'red':'yellow';ctx.fill();} }
        class GrenadeObj { constructor(x,y,tx,ty){this.x=x;this.y=y;this.dead=false;this.timer=60;let a=Math.atan2(ty-y,tx-x);let s=10;this.vx=Math.cos(a)*s;this.vy=Math.sin(a)*s;} update(){if(this.timer>0){this.x+=this.vx;this.y+=this.vy;this.timer--;this.vx*=0.9;this.vy*=0.9;}else{this.dead=true;enemies.forEach(e=>{if(Math.hypot(e.x-this.x,e.y-this.y)<120)e.takeDamage(150)}); createParticles(this.x,this.y,'orange');}} draw(){ctx.beginPath();ctx.arc(this.x,this.y,6,0,Math.PI*2);ctx.fillStyle='red';ctx.fill();} }
        function createParticles(x,y,c){for(let i=0;i<5;i++)particles.push({x,y,vx:(Math.random()-.5)*5,vy:(Math.random()-.5)*5,life:20,color:c});}

        // --- GAME LOOP ---
        function startMission(id) {
            currentMissionId=id; gameState='PLAYING'; player = new Player(canvas.width/2, canvas.height/2);
            enemies=[]; bullets=[]; obstacles=[]; particles=[]; drops=[]; thrownGrenades=[]; gameTime=0;
            if(id==='ONLINE') document.getElementById('multiplayer-screen').style.display='none';
            if(id==='CUSTOM') customMap.walls.forEach(w => obstacles.push(new Rect(w.x, w.y, 50)));
            else for(let i=0;i<12;i++) obstacles.push(new Rect(Math.random()*canvas.width, Math.random()*canvas.height, 40+Math.random()*60));
            document.getElementById('menu-overlay').style.display='none'; document.getElementById('game-ui').style.display='block';
            if(id===12) document.getElementById('training-ui').style.display='block';
            updateUI();
        }

        function updateGame() {
            if(gameState!=='PLAYING') return;
            gameTime+=1/60;
            player.update();
            
            // SPAWNING
            if(currentMissionId === 'ONLINE') {
                if(isHost && Math.floor(gameTime*60)%60===0) {
                    // HOST SPAWNS
                    let ex = Math.random()*canvas.width, ey = -30;
                    enemies.push(new Enemy(ex, ey, 'standard'));
                    sendNetworkData({type:'spawnEnemy', x:ex, y:ey, kind:'standard'});
                }
            } else {
                if(Math.floor(gameTime*60)%120===0 && currentMissionId!=='CUSTOM') enemies.push(new Enemy(Math.random()*canvas.width, -30, 'standard'));
            }

            enemies.forEach((e,i)=>{ e.update(); if(e.dead)enemies.splice(i,1); });
            bullets.forEach((b,i)=>{ 
                b.update(); 
                enemies.forEach(e=>{ if(!b.dead && Math.hypot(b.x-e.x, b.y-e.y)<e.radius+b.radius) { e.takeDamage(b.dmg); b.dead=true; } });
                if(b.dead)bullets.splice(i,1); 
            });
            thrownGrenades.forEach((g,i)=>{ g.update(); g.draw(); if(g.dead)thrownGrenades.splice(i,1); });
            particles.forEach((p,i)=>{p.x+=p.vx;p.y+=p.vy;p.life--;if(p.life<=0)particles.splice(i,1);});
        }

        function drawGame() {
            ctx.clearRect(0,0,canvas.width, canvas.height);
            ctx.fillStyle='#1a1a2e'; ctx.fillRect(0,0,canvas.width,canvas.height);
            obstacles.forEach(o=>o.draw());
            if(player) player.draw();
            enemies.forEach(e=>e.draw());
            bullets.forEach(b=>b.draw());
            particles.forEach(p=>{ctx.fillStyle=p.color;ctx.fillRect(p.x,p.y,3,3);});
            
            // Draw Remote Players
            if(currentMissionId === 'ONLINE') {
                for(let id in remotePlayers) {
                    let rp = remotePlayers[id];
                    ctx.save(); ctx.translate(rp.x, rp.y); ctx.rotate(rp.angle);
                    ctx.beginPath(); ctx.arc(0,0,15,0,Math.PI*2); ctx.fillStyle=rp.color; ctx.fill(); ctx.stroke();
                    ctx.restore();
                    ctx.fillStyle='lime'; ctx.font='12px Arial'; ctx.fillText("Player", rp.x-20, rp.y-20);
                }
            }
        }

        function loop() { requestAnimationFrame(loop); if(gameState==='PLAYING') { updateGame(); drawGame(); } }
        loop();

        // --- INPUTS ---
        window.addEventListener('keydown', e=>{if(controlMode==='PC')keys[e.code]=true;}); window.addEventListener('keyup', e=>{if(controlMode==='PC')keys[e.code]=false;});
        window.addEventListener('mousemove', e=>{if(controlMode==='PC'){mouse.x=e.clientX; mouse.y=e.clientY;}}); window.addEventListener('mousedown', ()=>{if(controlMode==='PC')mouse.down=true;}); window.addEventListener('mouseup', ()=>{if(controlMode==='PC')mouse.down=false;});
        
        // Touch logic for mobile
        function handleJoystick(t, isLeft) { const z=isLeft?document.getElementById('stick-left'):document.getElementById('stick-right'); const r=z.getBoundingClientRect(); let dx=t.clientX-(r.left+r.width/2), dy=t.clientY-(r.top+r.height/2); const md=r.width/2, d=Math.min(Math.hypot(dx,dy), md), a=Math.atan2(dy,dx); const knob=isLeft?document.getElementById('knob-left'):document.getElementById('knob-right'); knob.style.transform=`translate(-50%,-50%) translate(${Math.cos(a)*d}px, ${Math.sin(a)*d}px)`; if(isLeft){joystickLeft.x=Math.cos(a)*(d/md); joystickLeft.y=Math.sin(a)*(d/md); joystickLeft.active=true; joystickLeft.id=t.identifier;} else{joystickRight.x=Math.cos(a)*(d/md); joystickRight.y=Math.sin(a)*(d/md); joystickRight.active=true; joystickRight.id=t.identifier;} }
        function resetJoystick(isLeft) { if(isLeft){joystickLeft.active=false;joystickLeft.x=0;joystickLeft.y=0;document.getElementById('knob-left').style.transform='translate(-50%,-50%)';} else{joystickRight.active=false;joystickRight.x=0;joystickRight.y=0;document.getElementById('knob-right').style.transform='translate(-50%,-50%)';} }
        document.addEventListener('touchstart', e=>{ if(controlMode!=='MOBILE')return; for(let i=0;i<e.changedTouches.length;i++){ let t=e.changedTouches[i]; if(t.target.id==='mobile-grenade-btn'||t.target.closest('#weapon-bar'))continue; let zl=document.getElementById('stick-left').getBoundingClientRect(); if(t.clientX>=zl.left&&t.clientX<=zl.right) handleJoystick(t,true); let zr=document.getElementById('stick-right').getBoundingClientRect(); if(t.clientX>=zr.left&&t.clientX<=zr.right) handleJoystick(t,false); } },{passive:false});
        document.addEventListener('touchmove', e=>{ if(controlMode!=='MOBILE')return; e.preventDefault(); for(let i=0;i<e.changedTouches.length;i++){ let t=e.changedTouches[i]; if(t.identifier===joystickLeft.id)handleJoystick(t,true); if(t.identifier===joystickRight.id)handleJoystick(t,false); } },{passive:false});
        document.addEventListener('touchend', e=>{ if(controlMode!=='MOBILE')return; for(let i=0;i<e.changedTouches.length;i++){ let t=e.changedTouches[i]; if(t.identifier===joystickLeft.id)resetJoystick(true); if(t.identifier===joystickRight.id)resetJoystick(false); } });
        
        // Helper UI funcs
        function showMainMenu(){gameState='MENU'; document.getElementById('menu-overlay').style.display='flex'; document.getElementById('game-ui').style.display='none';}
        function openShop(){document.getElementById('menu-overlay').style.display='none';document.getElementById('shop-screen').style.display='flex';}
        function closeShop(){document.getElementById('shop-screen').style.display='none';document.getElementById('menu-overlay').style.display='flex';}
        function openEditor(){gameState='EDITOR';document.getElementById('menu-overlay').style.display='none';document.getElementById('editor-ui').style.display='flex';}
        function exitEditor(){document.getElementById('editor-ui').style.display='none';showMainMenu();}
        function setEditorTool(t){/*Minimal editor logic kept for size*/}
        function saveCustomMap(){saveGame();alert('Map Saved');}
        function devAction(a){if(a==='coins')playerStats.coins+=10000;if(a==='level')levelUp();if(a==='god')playerStats.godMode=!playerStats.godMode;if(a==='unlock')playerStats.unlockedWeapons=['pistol','rifle','shotgun','sniper','minigun','bazooka','laser','snowball'];updateMenuStats();}
        function redeemCode(){const c=document.getElementById('promo-input').value.toUpperCase(); if(c==='DRITKVMXNVBZXHS21893'){document.getElementById('dev-menu').style.display='block';}else if(c==='NEWYEAR2026'){playerStats.unlockedWeapons.push('snowball');alert('Snowball!');}else{alert('Code used/invalid');}}
        function updateUI(){if(player && controlMode==='PC')document.getElementById('weapon-info').innerText=player.weapon; document.getElementById('coin-counter').innerText='üí∞:'+playerStats.coins; document.getElementById('level-text').innerText='L'+playerStats.level; document.getElementById('xp-fill').style.width=(playerStats.xp/playerStats.nextLevelXp)*100+'%';}
        function setupMobileWeapons(){const b=document.getElementById('weapon-bar'); b.innerHTML=''; ['pistol','rifle','shotgun','minigun','bazooka','laser'].forEach(w=>{if(playerStats.unlockedWeapons.includes(w)){let d=document.createElement('div');d.className='wpn-btn';d.innerText=w[0].toUpperCase();d.onclick=()=>player.trySetWeapon(w);b.appendChild(d)}});}
        function throwGrenadeMobile(){if(player)player.throwGrenade(player.x,player.y-200);}
        // Shop preview (simplified)
        function updatePreview(){let c=document.getElementById('colorPicker').value;playerStats.color=c;let pc=document.getElementById('previewCanvas').getContext('2d');pc.clearRect(0,0,120,120);pc.beginPath();pc.arc(60,60,20,0,Math.PI*2);pc.fillStyle=c;pc.fill();pc.stroke();}
    </script>
</body>
</html>
