<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PolyStrike: EVOLUTION 2.0</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;900&family=Rajdhani:wght@500;700&display=swap');
        
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Rajdhani', sans-serif; user-select: none; color: white; }
        
        /* === UI –≠–õ–ï–ú–ï–ù–¢–´ === */
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; z-index: 10; align-items: center; justify-content: center; background: radial-gradient(circle at center, #1a202c 0%, #000 100%); }
        .active { display: flex; }

        .panel {
            background: rgba(10, 15, 30, 0.85);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(0, 229, 255, 0.2);
            padding: 30px; border-radius: 15px; text-align: center;
            box-shadow: 0 0 30px rgba(0, 229, 255, 0.1); width: 90%; max-width: 450px;
            position: relative;
        }

        h1 { font-family: 'Orbitron'; font-size: 42px; margin: 0 0 20px 0; color: #00e5ff; text-transform: uppercase; letter-spacing: 4px; text-shadow: 0 0 15px rgba(0, 229, 255, 0.8); }
        h2 { font-family: 'Orbitron'; color: #fff; letter-spacing: 2px; }
        
        .btn {
            background: linear-gradient(90deg, #00c6ff, #0072ff);
            border: none; padding: 12px 25px; margin: 8px; color: #fff;
            font-family: 'Orbitron'; font-size: 14px; font-weight: bold;
            clip-path: polygon(15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%, 0 15px);
            cursor: pointer; transition: 0.2s; width: 100%; text-transform: uppercase;
        }
        .btn:active { transform: scale(0.96); }
        .btn-sec { background: transparent; border: 1px solid rgba(255,255,255,0.3); }
        .btn-green { background: linear-gradient(90deg, #11998e, #38ef7d); }

        .item-card {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            padding: 10px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between;
            transition: 0.2s;
        }
        .item-card.selected { border-color: #00e5ff; background: rgba(0, 229, 255, 0.1); }
        
        /* –ò–ì–†–û–í–û–ô –ò–ù–¢–ï–†–§–ï–ô–° */
        #game-ui { pointer-events: none; background: transparent; justify-content: flex-start; }
        
        .top-hud { 
            position: absolute; top: 15px; width: 92%; display: flex; justify-content: space-between; align-items: center;
        }
        .stat-box { background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 8px; border-left: 3px solid #00e5ff; }

        .hp-bar-bg { width: 200px; height: 12px; background: #333; transform: skewX(-20deg); overflow: hidden; border: 1px solid #555; }
        .hp-fill { width: 100%; height: 100%; background: linear-gradient(90deg, #ff3333, #ff8800); transition: 0.3s; }

        #crosshair { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 20px; height: 20px; opacity: 0.8; }
        #crosshair::before, #crosshair::after { content:''; position: absolute; background: #0f0; }
        #crosshair::before { width: 2px; height: 10px; left: 9px; top: 5px; }
        #crosshair::after { width: 10px; height: 2px; top: 9px; left: 5px; }

        #ammo-display { position: absolute; bottom: 30px; right: 30px; font-family: 'Orbitron'; font-size: 30px; color: #00e5ff; text-shadow: 0 0 10px #00e5ff; }

        /* –ú–û–ë–ò–õ–¨–ù–û–ï –£–ü–†–ê–í–õ–ï–ù–ò–ï */
        .controls { position: absolute; width: 100%; height: 100%; pointer-events: none; display: none; }
        .touch-btn { position: absolute; pointer-events: auto; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); border-radius: 50%; backdrop-filter: blur(4px); }
        #stick-zone { bottom: 40px; left: 40px; width: 120px; height: 120px; }
        #stick-knob { width: 40px; height: 40px; background: rgba(255,255,255,0.8); position: absolute; top: 40px; left: 40px; border-radius: 50%; pointer-events: none; box-shadow: 0 0 10px white; }
        
        #damage-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: radial-gradient(circle, transparent 50%, rgba(255,0,0,0.5) 100%); opacity: 0; transition: 0.2s; pointer-events: none; }
    </style>
</head>
<body>

    <div id="device-screen" class="screen active">
        <h1>PolyStrike<br><span style="font-size:20px; color:#fff">EVOLUTION</span></h1>
        <div class="panel">
            <h3>–í–´–ë–ï–†–ò –£–ü–†–ê–í–õ–ï–ù–ò–ï</h3>
            <button class="btn" style="height:60px; font-size:18px;" onclick="selectDevice('PC')">üíª PC (–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞)</button>
            <button class="btn" style="height:60px; font-size:18px;" onclick="selectDevice('MOBILE')">üì± –¢–ï–õ–ï–§–û–ù (–°–µ–Ω—Å–æ—Ä)</button>
        </div>
    </div>

    <div id="menu-screen" class="screen">
        <div class="top-hud" style="justify-content: center;">
            <div class="stat-box">üí∞ <span id="money-display">1000</span></div>
        </div>
        
        <div class="panel">
            <input type="text" id="nick-input" placeholder="–¢–≤–æ–π –ù–∏–∫–Ω–µ–π–º" style="background:transparent; border:none; border-bottom:2px solid #00e5ff; color:white; text-align:center; font-family:'Orbitron'; font-size:20px; width:80%; margin-bottom:20px; outline:none;">
            
            <button class="btn" onclick="openLobby()">‚öîÔ∏è –ò–ì–†–ê–¢–¨ –û–ù–õ–ê–ô–ù</button>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; width:100%;">
                <button class="btn btn-sec" onclick="openShop('skins')">üëï –°–ö–ò–ù–´</button>
                <button class="btn btn-sec" onclick="openShop('guns')">üî´ –û–†–£–ñ–ò–ï</button>
            </div>
        </div>
    </div>

    <div id="shop-screen" class="screen">
        <h2 id="shop-title">–ú–ê–ì–ê–ó–ò–ù</h2>
        <div class="panel" style="width:95%; max-width:600px; height:60%; overflow-y:auto;" id="shop-container">
            </div>
        <button class="btn btn-sec" style="width:200px; margin-top:20px;" onclick="toMenu()">–ù–ê–ó–ê–î</button>
    </div>

    <div id="lobby-screen" class="screen">
        <div class="panel">
            <h2>–°–ï–¢–ï–í–ê–Ø –ò–ì–†–ê</h2>
            <p style="color:#aaa; font-size:12px;">PeerJS P2P System</p>
            
            <button class="btn btn-green" onclick="hostGame()">–°–û–ó–î–ê–¢–¨ –ö–û–ú–ù–ê–¢–£ (HOST)</button>
            
            <div style="margin: 20px 0; border-top:1px solid #333; padding-top:20px;">
                <input id="join-code" placeholder="–í—Å—Ç–∞–≤—å ID –¥—Ä—É–≥–∞ —Å—é–¥–∞" style="width:100%; padding:15px; text-align:center; background:#000; border:1px solid #444; color:#fff; font-family:'Orbitron'; margin-bottom:10px;">
                <button class="btn" onclick="joinGame()">–ü–û–î–ö–õ–Æ–ß–ò–¢–¨–°–Ø</button>
            </div>
            
            <div id="status-log" style="color:#0ff; height:30px; font-size:14px; font-weight:bold;"></div>
            <button class="btn btn-sec" onclick="toMenu()">–û–¢–ú–ï–ù–ê</button>
        </div>
    </div>

    <div id="game-ui" class="screen">
        <div id="damage-overlay"></div>
        <div class="top-hud">
            <div>
                <div style="font-size:14px; color:#00e5ff; font-weight:bold; margin-bottom:5px;">–ó–î–û–†–û–í–¨–ï</div>
                <div class="hp-bar-bg"><div class="hp-fill" id="hp-val"></div></div>
            </div>
            <div class="stat-box" style="text-align:right">
                <span id="score-text" style="font-size:24px; font-weight:bold; font-family:'Orbitron'">0 : 0</span>
            </div>
        </div>

        <div id="crosshair"></div>
        <div id="ammo-display">30 / ‚àû</div>
        
        <div id="mobile-controls" class="controls">
            <div id="stick-zone" class="touch-btn"><div id="stick-knob"></div></div>
            <div id="btn-shoot" class="touch-btn" style="bottom:80px; right:30px; width:70px; height:70px; background:rgba(255,50,50,0.2); border-color:#f00; display:flex; justify-content:center; align-items:center; font-size:30px;">üî•</div>
            <div id="btn-jump" class="touch-btn" style="bottom:170px; right:40px; width:50px; height:50px; display:flex; justify-content:center; align-items:center;">‚¨ÜÔ∏è</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <script>
        /* === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò –î–ê–ù–ù–´–ï === */
        const CFG = {
            nick: localStorage.getItem('ps_nick') || '–ë–æ–µ—Ü',
            skin: localStorage.getItem('ps_skin') || 'classic',
            gun: localStorage.getItem('ps_gun') || 'rifle',
            money: parseInt(localStorage.getItem('ps_money')) || 1000,
            isMobile: false,
            sens: 0.002
        };

        const SKINS = {
            'classic': { color: 0x4caf50, name: '–°–æ–ª–¥–∞—Ç', price: 0 },
            'specops': { color: 0x2196f3, name: '–°–ø–µ—Ü–Ω–∞–∑', price: 500 },
            'mercenary': { color: 0xf44336, name: '–ù–∞–µ–º–Ω–∏–∫', price: 1000 },
            'ninja': { color: 0x111111, name: '–¢–µ–Ω—å', price: 2000 }
        };

        const WEAPONS = {
            'pistol': { name: 'Glock-18', dmg: 15, rate: 400, color: 0x999999, price: 0, scale: [0.1, 0.3, 0.4] },
            'rifle': { name: 'AK-47', dmg: 25, rate: 150, color: 0x8d6e63, price: 1000, scale: [0.1, 0.3, 0.8] },
            'sniper': { name: 'AWP', dmg: 80, rate: 1200, color: 0x4caf50, price: 2500, scale: [0.1, 0.4, 1.2] }
        };

        /* === UI –õ–û–ì–ò–ö–ê === */
        function updateMoney() {
            document.getElementById('money-display').innerText = CFG.money;
            localStorage.setItem('ps_money', CFG.money);
        }

        function selectDevice(type) {
            CFG.isMobile = (type === 'MOBILE');
            document.getElementById('device-screen').classList.remove('active');
            document.getElementById('menu-screen').classList.add('active');
            if(CFG.isMobile) document.getElementById('mobile-controls').style.display = 'block';
            updateMoney();
        }

        function openShop(type) {
            document.getElementById('menu-screen').classList.remove('active');
            document.getElementById('shop-screen').classList.add('active');
            const con = document.getElementById('shop-container');
            const title = document.getElementById('shop-title');
            con.innerHTML = '';
            
            let data = (type === 'skins') ? SKINS : WEAPONS;
            let current = (type === 'skins') ? CFG.skin : CFG.gun;
            title.innerText = (type === 'skins') ? '–ì–ê–†–î–ï–†–û–ë' : '–û–†–£–ñ–ï–ô–ù–ê–Ø';

            for(let k in data) {
                const item = data[k];
                const el = document.createElement('div');
                const isOwned = true; // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –≤—Å—ë –¥–æ—Å—Ç—É–ø–Ω–æ, –Ω–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ–∫—É–ø–æ–∫
                const isSelected = (current === k);
                
                el.className = `item-card ${isSelected ? 'selected' : ''}`;
                el.innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div style="width:40px; height:40px; background:#${item.color.toString(16)}; border-radius:5px;"></div>
                        <div style="text-align:left">
                            <div style="font-weight:bold; color:#fff">${item.name}</div>
                            <div style="font-size:12px; color:#aaa">${type==='guns' ? '–£—Ä–æ–Ω: '+item.dmg : '–°–∫–∏–Ω'}</div>
                        </div>
                    </div>
                    <button class="btn" style="width:auto; padding:5px 15px; font-size:12px;">${isSelected ? '–í–´–ë–†–ê–ù–û' : '–í–´–ë–†–ê–¢–¨'}</button>
                `;
                el.onclick = () => {
                    if(type === 'skins') { CFG.skin = k; localStorage.setItem('ps_skin', k); }
                    else { CFG.gun = k; localStorage.setItem('ps_gun', k); }
                    openShop(type); // –û–±–Ω–æ–≤–∏—Ç—å
                };
                con.appendChild(el);
            }
        }

        function toMenu() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('menu-screen').classList.add('active');
        }
        function openLobby() {
            CFG.nick = document.getElementById('nick-input').value || '–ë–æ–µ—Ü';
            localStorage.setItem('ps_nick', CFG.nick);
            document.getElementById('menu-screen').classList.remove('active');
            document.getElementById('lobby-screen').classList.add('active');
        }

        /* === 3D –ú–ò–† (THREE.JS) === */
        let scene, camera, renderer, clock;
        let myMesh, enemyMesh;
        let projectiles = [];
        let peer, conn;
        let input = { x:0, y:0, jump:0, shoot:0 };
        let myHP = 100;
        let lastShot = 0;

        function init3D() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('game-ui').classList.add('active');

            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000510, 0.02);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({antialias: true});
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.body.appendChild(renderer.domElement);
            clock = new THREE.Clock();

            // –ù–ï–ë–û (–ó–≤–µ–∑–¥—ã)
            const starGeo = new THREE.BufferGeometry();
            const starCount = 2000;
            const posArray = new Float32Array(starCount * 3);
            for(let i=0;i<starCount*3;i++) posArray[i] = (Math.random()-0.5)*400;
            starGeo.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
            const stars = new THREE.Points(starGeo, new THREE.PointsMaterial({size:0.5, color:0xffffff}));
            scene.add(stars);

            // –°–í–ï–¢
            const ambient = new THREE.AmbientLight(0x404040, 0.6); // –ú—è–≥–∫–∏–π —Å–≤–µ—Ç
            scene.add(ambient);
            const sun = new THREE.DirectionalLight(0x00ccff, 0.7);
            sun.position.set(20, 50, 20); sun.castShadow = true;
            sun.shadow.mapSize.width = 2048; sun.shadow.mapSize.height = 2048;
            scene.add(sun);
            const pointL = new THREE.PointLight(0xffaa00, 0.5, 20); // –¢–µ–ø–ª—ã–π —Å–≤–µ—Ç –æ—Ç —Ü–µ–Ω—Ç—Ä–∞
            pointL.position.set(0,5,0);
            scene.add(pointL);

            // –ü–û–õ (–ù–µ–æ–Ω–æ–≤–∞—è —Å–µ—Ç–∫–∞)
            const gridHelper = new THREE.GridHelper(200, 100, 0x00e5ff, 0x111133);
            scene.add(gridHelper);
            const floorPlane = new THREE.Mesh(
                new THREE.PlaneGeometry(200, 200), 
                new THREE.MeshPhongMaterial({ color: 0x050510, shininess: 10 })
            );
            floorPlane.rotation.x = -Math.PI/2; floorPlane.position.y = -0.1;
            floorPlane.receiveShadow = true;
            scene.add(floorPlane);

            // –ü–†–ï–ü–Ø–¢–°–¢–í–ò–Ø
            const boxGeo = new THREE.BoxGeometry(4, 4, 4);
            const boxMat = new THREE.MeshPhongMaterial({color: 0x334455});
            for(let i=0; i<20; i++) {
                const box = new THREE.Mesh(boxGeo, boxMat);
                box.position.set(Math.random()*80-40, 2, Math.random()*80-40);
                box.castShadow = true; box.receiveShadow = true;
                scene.add(box);
            }

            // –í–†–ê–ì
            enemyMesh = createCharacter(SKINS['classic'].color, 'pistol'); // –í—Ä–µ–º–µ–Ω–Ω–æ –¥–µ—Ñ–æ–ª—Ç
            scene.add(enemyMesh);
            enemyMesh.position.y = -500; // –°–ø—Ä—è—Ç–∞—Ç—å

            camera.position.set(0, 1.7, 5);

            if(CFG.isMobile) setupMobileControls();
            else setupPCControls();

            animate();
        }

        function createCharacter(skinColor, gunType) {
            const group = new THREE.Group();
            const mat = new THREE.MeshPhongMaterial({ color: skinColor });
            
            // –¢–µ–ª–æ
            const body = new THREE.Mesh(new THREE.BoxGeometry(0.8, 1.2, 0.5), mat);
            body.position.y = 0.6; body.castShadow = true;
            group.add(body);
            
            // –ì–æ–ª–æ–≤–∞
            const head = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.5, 0.5), new THREE.MeshPhongMaterial({color: 0xffccaa}));
            head.position.y = 1.45; head.castShadow = true;
            
            // –ì–ª–∞–∑–∞ (–≤–∏–∑—É–∞–ª)
            const eyes = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.1, 0.1), new THREE.MeshBasicMaterial({color:0x000000}));
            eyes.position.set(0, 0.05, 0.25); head.add(eyes);
            group.add(head);

            // –û—Ä—É–∂–∏–µ
            const gData = WEAPONS[gunType] || WEAPONS['pistol'];
            const gunGeo = new THREE.BoxGeometry(gData.scale[0], gData.scale[1], gData.scale[2]);
            const gunMat = new THREE.MeshStandardMaterial({color: gData.color});
            const gun = new THREE.Mesh(gunGeo, gunMat);
            gun.position.set(0.3, 0.8, 0.4); 
            group.add(gun);
            group.gunMesh = gun; // –°—Å—ã–ª–∫–∞ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–æ–≤

            return group;
        }

        /* === –°–ï–¢–¨ (P2P + LOGIC) === */
        function hostGame() {
            peer = new Peer();
            peer.on('open', id => {
                document.getElementById('status-log').innerHTML = `–ö–û–î –ö–û–ú–ù–ê–¢–´: <span style="color:#fff; background:#333; padding:5px;">${id}</span>`;
            });
            peer.on('connection', c => { conn = c; setupConnection(); });
        }
        function joinGame() {
            const id = document.getElementById('join-code').value;
            if(!id) return alert('–í–≤–µ–¥–∏—Ç–µ ID!');
            peer = new Peer();
            peer.on('open', () => { conn = peer.connect(id); setupConnection(); });
        }

        function setupConnection() {
            document.getElementById('status-log').innerText = "–°–í–Ø–ó–¨ –£–°–¢–ê–ù–û–í–õ–ï–ù–ê! –ó–ê–ì–†–£–ó–ö–ê...";
            setTimeout(() => {
                init3D();
                conn.send({ type: 'init', skin: CFG.skin, gun: CFG.gun, nick: CFG.nick });
            }, 1000);

            conn.on('data', d => {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Ä–∞–≥–∞
                if(d.type === 'init') {
                    scene.remove(enemyMesh); // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π
                    enemyMesh = createCharacter(SKINS[d.skin].color, d.gun);
                    scene.add(enemyMesh);
                }
                // –î–≤–∏–∂–µ–Ω–∏–µ –≤—Ä–∞–≥–∞
                if(d.type === 'move') {
                    enemyMesh.position.set(d.x, d.y, d.z);
                    enemyMesh.rotation.y = d.ry;
                }
                // –í—Ä–∞–≥ —Å—Ç—Ä–µ–ª—è–µ—Ç (–≤–∏–∑—É–∞–ª)
                if(d.type === 'shoot') {
                    createBulletTrace(enemyMesh.position, new THREE.Vector3(d.dx, d.dy, d.dz));
                }
                // –í –º–µ–Ω—è –ø–æ–ø–∞–ª–∏
                if(d.type === 'hit') {
                    takeDamage(d.dmg);
                }
            });
        }

        /* === –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê === */
        let velY = 0;
        const speed = 8;
        
        function takeDamage(amount) {
            myHP -= amount;
            document.getElementById('hp-val').style.width = myHP + '%';
            
            // –≠—Ñ—Ñ–µ–∫—Ç –∫—Ä–æ–≤–∏
            const overlay = document.getElementById('damage-overlay');
            overlay.style.opacity = 1;
            setTimeout(() => overlay.style.opacity = 0, 300);

            if(myHP <= 0) {
                myHP = 100; // –†–µ—Å–ø–∞—É–Ω
                camera.position.set(Math.random()*40-20, 2, Math.random()*40-20);
                // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ —Å–º–µ—Ä—Ç–µ–π –∑–¥–µ—Å—å
            }
        }

        function shoot() {
            const now = Date.now();
            const weapon = WEAPONS[CFG.gun];
            if(now - lastShot < weapon.rate) return; // –°–∫–æ—Ä–æ—Å—Ç—Ä–µ–ª—å–Ω–æ—Å—Ç—å
            lastShot = now;

            // 1. –í–∏–∑—É–∞–ª —Ç—Ä–∞—Å—Å–µ—Ä–∞
            const origin = camera.position.clone();
            origin.y -= 0.2; // –ß—É—Ç—å –Ω–∏–∂–µ –≥–ª–∞–∑
            const dir = new THREE.Vector3(0, 0, -1).applyQuaternion(camera.quaternion);
            createBulletTrace(origin, dir);

            // 2. –õ–æ–≥–∏–∫–∞ –ø–æ–ø–∞–¥–∞–Ω–∏—è (Raycast)
            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(new THREE.Vector2(0,0), camera); // –¶–µ–Ω—Ç—Ä —ç–∫—Ä–∞–Ω–∞
            
            const intersects = raycaster.intersectObject(enemyMesh, true); // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ø–∞–¥–∞–Ω–∏—è –≤–æ –≤—Ä–∞–≥–∞
            
            if(intersects.length > 0) {
                // –ü–û–ü–ê–õ!
                console.log("HIT!");
                if(conn && conn.open) {
                    conn.send({ type: 'hit', dmg: weapon.dmg });
                    // –í–∏–∑—É–∞–ª –ø–∞—Ä—Ç–∏–∫–ª–æ–≤ –ø–æ–ø–∞–¥–∞–Ω–∏—è –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ç—É—Ç
                }
            }

            // 3. –û—Ç–ø—Ä–∞–≤–∫–∞ –≤—ã—Å—Ç—Ä–µ–ª–∞ –≤—Ä–∞–≥—É (—á—Ç–æ–±—ã –æ–Ω –≤–∏–¥–µ–ª —Ç—Ä–∞—Å—Å–µ—Ä)
            if(conn && conn.open) {
                conn.send({ type: 'shoot', dx: dir.x, dy: dir.y, dz: dir.z });
            }
        }

        function createBulletTrace(startPos, dir) {
            // –õ–∏–Ω–∏—è –≤—ã—Å—Ç—Ä–µ–ª–∞
            const material = new THREE.LineBasicMaterial({ color: 0xffff00 });
            const points = [];
            points.push(startPos.clone().add(new THREE.Vector3(0.2, -0.2, 0))); // –û—Ç –ø—É—à–∫–∏
            points.push(startPos.clone().add(dir.multiplyScalar(50))); // –í–¥–∞–ª—å
            const geometry = new THREE.BufferGeometry().setFromPoints(points);
            const line = new THREE.Line(geometry, material);
            scene.add(line);
            
            // –ò—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ –ª–∏–Ω–∏–∏
            setTimeout(() => scene.remove(line), 50);
        }

        function animate() {
            requestAnimationFrame(animate);
            const dt = clock.getDelta();

            // –§–ò–ó–ò–ö–ê –ò–ì–†–û–ö–ê
            const dir = new THREE.Vector3();
            const fwd = new THREE.Vector3(0,0,-1).applyEuler(new THREE.Euler(0, camera.rotation.y, 0));
            const side = new THREE.Vector3(1,0,0).applyEuler(new THREE.Euler(0, camera.rotation.y, 0));

            if(input.y < 0) dir.add(fwd); if(input.y > 0) dir.sub(fwd);
            if(input.x < 0) dir.sub(side); if(input.x > 0) dir.add(side);

            camera.position.add(dir.normalize().multiplyScalar(speed * dt));

            // –ü—Ä—ã–∂–æ–∫
            if(input.jump && camera.position.y <= 1.75) { velY = 12; input.jump=false; }
            velY -= 30 * dt; // –ì—Ä–∞–≤–∏—Ç–∞—Ü–∏—è
            camera.position.y += velY * dt;
            if(camera.position.y < 1.7) { camera.position.y = 1.7; velY = 0; }

            // –°—Ç—Ä–µ–ª—å–±–∞ (–¥–ª—è –º–æ–±–∞–π–ª–∞ –∏–ª–∏ –∞–≤—Ç–æ)
            if(input.shoot) shoot();

            // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–∑–∏—Ü–∏–∏ –≤ —Å–µ—Ç—å
            if(conn && conn.open) {
                conn.send({
                    type: 'move',
                    x: camera.position.x, 
                    y: camera.position.y - 1.6, // –ö–æ—Ä—Ä–µ–∫—Ü–∏—è –º–æ–¥–µ–ª–∏
                    z: camera.position.z,
                    ry: camera.rotation.y + Math.PI 
                });
            }

            renderer.render(scene, camera);
        }

        /* === –£–ü–†–ê–í–õ–ï–ù–ò–ï === */
        function setupPCControls() {
            document.body.onclick = () => document.body.requestPointerLock();
            document.body.onmousedown = () => input.shoot = true;
            document.body.onmouseup = () => input.shoot = false;
            
            document.addEventListener('mousemove', e => {
                if(document.pointerLockElement) {
                    camera.rotation.y -= e.movementX * CFG.sens;
                    camera.rotation.x -= e.movementY * CFG.sens;
                    camera.rotation.x = Math.max(-1.5, Math.min(1.5, camera.rotation.x));
                }
            });
            document.addEventListener('keydown', e => {
                if(e.code=='KeyW') input.y=-1; if(e.code=='KeyS') input.y=1;
                if(e.code=='KeyA') input.x=-1; if(e.code=='KeyD') input.x=1;
                if(e.code=='Space') input.jump=true;
            });
            document.addEventListener('keyup', e => {
                if(['KeyW','KeyS'].includes(e.code)) input.y=0;
                if(['KeyA','KeyD'].includes(e.code)) input.x=0;
            });
        }

        function setupMobileControls() {
            const stick = document.getElementById('stick-zone');
            const knob = document.getElementById('stick-knob');
            let startT;

            stick.addEventListener('touchstart', e => startT = e.changedTouches[0]);
            stick.addEventListener('touchmove', e => {
                e.preventDefault();
                const t = e.changedTouches[0];
                let dx = t.clientX - startT.clientX;
                let dy = t.clientY - startT.clientY;
                if(Math.sqrt(dx*dx+dy*dy) > 40) { dx*=0.8; dy*=0.8; }
                knob.style.transform = `translate(${dx}px, ${dy}px)`;
                input.x = dx/40; input.y = dy/40;
            });
            stick.addEventListener('touchend', () => { knob.style.transform=''; input.x=0; input.y=0; });

            // –í—Ä–∞—â–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã
            let lastX;
            document.addEventListener('touchstart', e => { if(e.touches[0].clientX > window.innerWidth/2) lastX = e.touches[0].clientX; });
            document.addEventListener('touchmove', e => {
                const t = e.touches[0];
                if(t.clientX > window.innerWidth/2) {
                    camera.rotation.y -= (t.clientX - lastX) * 0.005;
                    lastX = t.clientX;
                }
            });
            
            const btnShoot = document.getElementById('btn-shoot');
            btnShoot.addEventListener('touchstart', (e)=>{ e.preventDefault(); input.shoot=true; btnShoot.style.background='rgba(255,0,0,0.5)'; });
            btnShoot.addEventListener('touchend', (e)=>{ e.preventDefault(); input.shoot=false; btnShoot.style.background='rgba(255,50,50,0.2)'; });
            
            document.getElementById('btn-jump').addEventListener('touchstart', (e)=>{ e.preventDefault(); input.jump=true; });
        }
    </script>
</body>
</html>
